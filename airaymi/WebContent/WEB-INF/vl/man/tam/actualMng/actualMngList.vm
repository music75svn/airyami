#*************************************************************************
* CLASS 명      : actualMngList
* 작 업 자      : 박경태
* 작 업 일      : 2013년 06월 24일
* 기    능      : 실적입력/승인
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자     작   업   일       변 경 내 용           비  고
* ----  --------  -----------------  -------------------------  -----------
*  1     정용훈      2013년 06월 24일             최 초 작 업
**************************************************************************#
#set($curr_url = $!{context_path} + "/man/tam/actualMng/actualMngList.vw")
<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;

	J(document).ready(function(){

		/******************************************
		 * 디폴트 입력 지표 조회
		 ******************************************/
		goAction("$!{searchMap.txt2html("manKpiId")}", "direct");

		J("#btnReturnView").hide();

		/******************************************
		 * 조회
		 ******************************************/
		J("#formFind").submit(function(event) {
			//submit 하기전 작업추가
		});

		#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("60"))
		/******************************************
		 * 평가년도  change 이벤트
		 ******************************************/
		$('#findYear').change(function(){
			chgFindYear();
		});
		#end


		/******************************************
		 * 저장버튼 이벤트
		 ******************************************/
		J("#btnInsert").click(function(e) {
			e.preventDefault();
			saveChk();
		});

		/******************************************
		 * 삭제 버튼 클릭 이벤트
		 ******************************************/
		J("#btnDelete").click(function() {
			goDelete();
			return false;
		});

		/******************************************
		 * 엑셀다운로드 버튼 클릭 이벤트
		 ******************************************/
		J("#btnExcelDown").click(function() {
			excelDownload();
			return false;
		});

		/******************************************
		 * fancy Box 팝업호출
		 ******************************************/
		J("#anchor").fancybox();

		/******************************************
		 * 반려 버튼 클릭 이벤트
		 ******************************************/
		J("#btnReturn").click(function() {
			#if( "$!{yearClosingYn}" == "Y")
    			J.showMsgBox($!{searchMap.txt2html("findYear")} + " 년은 마감되었습니다.", null, null);
    			return false;
    		#end
			returnPop();
			return false;
		});

		/******************************************
		 * 반려조회 버튼 클릭 이벤트
		 ******************************************/
		J("#btnReturnView").click(function() {
			returnPopView();
			return false;
		});

	});

	/******************************************
	 * 평가년도 변경 시 입력/승인 담당자 변경 (AJAX)
	 ******************************************/
	function chgFindYear() {

		J.ajax({

        	url      : "$!{context_path}/man/tam/actualMng/userList_ajax.vw",
        	cache    : false,
        	type     : "POST",
			data     : J("#formFind").serialize(),
        	dataType : "html",
        	contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        	success  : function (data) {
				var xmlDoc = J.parseXML(data);
				J("#findUserId").empty();
				J('<option/>').attr('value','').text("미지정").appendTo('#findUserId');
				J('<option/>').attr('value','ALL').text("전체").appendTo('#findUserId');
				J(xmlDoc).find("data").each(function() {
					J('<option/>').attr('value', J(this).find("value").text()).text(J(this).find("text").text()).appendTo('#findUserId');
				})
        	}
    	});
    	
    	J("#formFind").attr("action", "$!{context_path}/man/tam/actualMng/actualMngList.vw?type=template").submit();
	}

	/******************************************
	 * 입력담당자 변경시 처리상태 변경		flag ->  0:담당자존재     1:미지정      2:전체
	 ******************************************/
	function chgUserId(){
		if( J("#findActualType").val() == "input" ) {
					if( J("#findUserId").val() == "" ) {
						J("#flag").val("1");
						J("#findActualStatusId").val("01");
					}else if(J("#findUserId").val() == "ALL" ) {
						J("#flag").val("2");
						J("#findActualStatusId").val("01");
					}else {
						J("#flag").val("0");
						J("#findActualStatusId").val("01");
					}
					
				} else if(J("#findActualType").val() =="check"){
					if( J("#findUserId").val() == "" ) {
						J("#flag").val("1");
						J("#findActualStatusId").val("06");
					}else if( J("#findUserId").val() == "ALL" ) {
						J("#flag").val("2");
						J("#findActualStatusId").val("06");
					}else {
						J("#flag").val("0");
						J("#findActualStatusId").val("06");
					}
					
				} else if(J("#findActualType").val() == "approve"){
					if( J("#findUserId").val() == "" ) {
						J("#flag").val("1");
						J("#findActualStatusId").val("03");
					}else if( J("#findUserId").val() == "ALL" ) {
						J("#flag").val("2");
						J("#findActualStatusId").val("03");
					}else {
						J("#flag").val("0");
						J("#findActualStatusId").val("03");
					}
				
				}

			J("#formFind").attr("action", "$!{context_path}/man/tam/actualMng/actualMngList.vw?type=template").submit();

	}

	/******************************************
	 * 처리상태 선택시 검색   flag ->  0:담당자존재     1:미지정      2:전체
	 ******************************************/
	function goSearchStatus() {
		if( J("#findActualType").val() == "input" ) {
			if( J("#findUserId").val() == '' ) {
				J("#flag").val("1");
			}else {
				J("#flag").val("0");
			}
		}else {
			if( J("#findUserId").val() == '' ) {
				J("#flag").val("1");
			}else if( J("#findUserId").val() == "ALL" ) {
				J("#flag").val("2");
			}else {
				J("#flag").val("0");
			}
		}

		J("#formFind").attr("action", "$!{context_path}/man/tam/actualMng/actualMngList.vw?type=template").submit();

	}

	/******************************************
	 * 조회
	 ******************************************/
	function goAction(id, nm) {
		var type				= "";
		var year				= J("#findYear").val();
		var mon					= J("#findMon").val();
		var findUserId			= J("#findUserId").val();
		var findActualStatusId	= J("#findActualStatusId").val();
		var findActualType		= "$!{searchMap.txt2html("findActualType")}";

		if(nm != "direct") {
			type = J(nm).attr("dpetClass").split("^")[0]; // 1:경영목표, 2:전략과제, 3:CSF, 4:KPI
		} else {
			type = "4";
		}

		if(type == '1' || type == '2' || type == '3') return; //경영목표, 전략과제, CSF 선택시

		J.ajax({
			url      : "$!{context_path}/man/tam/actualMng/actualMngDetailList.vw",
			cache    : false,
			type     : "POST",
			data     : "year=" + year + "&amp;findYear=" + year + "&amp;mon=" + mon + "&amp;findMon=" + mon + "&amp;manKpiId=" + id + "&amp;findUserId=" + findUserId + "&amp;findActualType=" + findActualType + "&amp;findActualStatusId=" + findActualStatusId,
			dataType : "html",
			contentType: "application/x-www-form-urlencoded; charset=UTF-8",
			success  : function (data) {
				J("#detailData").empty();  //body부분 div를 empty 시켜줌(empty를 시키지 않을 경우 메모리릭 발생)
				J("#detailData").append(data);
			}
		});
	}

	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk() {
		#if( "$!{yearClosingYn}" == "Y")
			J.showMsgBox($!{searchMap.txt2html("findYear")} + " 년은 마감되었습니다.", null, null);
			return false;
		#end

		#if( "$!{actualInputTermYn}" == "N" )
			J.showMsgBox("실적입력 기한이 아닙니다.", null, null);
			return false;
		#end

		var fileChk = true;

		//첨부파일 확장자 체크
		J(":file", "#formList").each(function(index, item) {
			var fileFullName = J("input[name=" + item.name + "]").val();
			var src = getFileExtension(fileFullName);

			if (!((src.toLowerCase() == "xls") || (src.toLowerCase() == "xlsx") || (src.toLowerCase() == "ppt") || (src.toLowerCase() == "pptx")||
				  (src.toLowerCase() == "doc") || (src.toLowerCase() == "docx") || (src.toLowerCase() == "hwp") || (src.toLowerCase() == "pdf") ||
				  (src.toLowerCase() == "zip") || (src.toLowerCase() == "txt")  || (src.toLowerCase() == "gif") || (src.toLowerCase() == "jpg") ||
			      (src.toLowerCase() == "png") || (src.toLowerCase() == "png")
			    )) {

				fileChk = false;
    		}
		});

		if(fileChk == false) {
			J.showMsgBox("허용되지 않는 파일형식입니다<br/>허용되는 파일형식 : <br/>xls, xlsx, ppt, pptx, doc, docx, hwp <br/> pdf, zip, txt, gif, jpg, png, jpeg", null, null);
    		return;
		}

		var actualType 		= J("#findActualType").val();
		var actualStatusId 	= J("#actualStatusId").val();

		if(actualStatusId == "03" || actualStatusId == "04") {
			J.showMsgBox("미입력, 입력, 반려 지표만 수정 하실 수 있습니다.", null, null);
			return;
		} else {
			var actual = J("input[name=colValues]:enabled", "#blockDetailTB");
			var actualChk = true;

			if(actual.length != 0) {
				for (var i = 0; i < actual.length; i++) {
					if(actual.eq(i).val()==""){
						actualChk = false;
					}
				}
			} else {
				J.showMsgBox("입력할 실적값이 없습니다.", null, null);
				return;
			}

			if(actualChk){
				J.showConfirmBox("저장하시겠습니까?", "saveDo"); //saveDo() 콜백함수 호출
			}else{
				J.showMsgBox("실적값을 모두 입력해주세요", null, null);
				return;
			}
		}
	}

	/******************************************
	 * 저장
	 ******************************************/
	function saveDo() {
		J("#year").val(J("#findYear").val());
		J("#mon").val(J("#findMon").val());
		J("#mode").val("ADD");
		J("#actStatusId").val("02");

		document.charset='utf-8';

		J("#formList").attr("action", "$!{context_path}/man/tam/actualMng/actualMngProcess.vw?type=template").submit();
	}

	/******************************************
	 * 승인상태 저장
	 ******************************************/
	function goStatus(actualStatusId) {
		if( "$!{yearClosingYn}" == "Y" ){
			J.showMsgBox($!{searchMap.txt2html("findYear")} + " 년은 마감되었습니다.", null, null);
			return ;
		}

		if(!saveStatusChk()) return;
		J("#actualStatusId").val(actualStatusId);

	    if(actualStatusId=="04"){
			J.showConfirmBox("승인하시겠습니까?", "statusDo"); //statusDo() 콜백함수 호출
		}else if(actualStatusId=="05"){
			statusDo();
		}else if(actualStatusId=="06"){
			J.showConfirmBox("확인요청하시겠습니까?", "statusDo"); //statusDo() 콜백함수 호출
		}else{
			J.showConfirmBox("확인 및 승인요청하시겠습니까?", "statusDo"); //statusDo() 콜백함수 호출
		}
	}

	/******************************************
	 * 전체 선택, 해제
	 ******************************************/
	function fncSelectAll(checkStatus) {
		if(checkStatus){
			fncSelecter(checkStatus);
		}else{
			fncSelecter(checkStatus);
		}
	}

	/******************************************
	 * 승인 및 반려 상태 저장
	 ******************************************/
	function statusDo() {
		J("#year").val(J("#findYear").val());
		J("#mon").val(J("#findMon").val());
		J("#mode").val("STATUS");

		var tree = $("#tree").dynatree("getTree");
		var selectNode = tree.serializeManKpiIdString();

		J("#manKpiId").val(selectNode);
		J("#formList").attr("action", "$!{context_path}/man/tam/actualMng/actualMngProcess.vw?type=template").submit();
	}

	/******************************************
	 * 승인 및 반려 체크
	 ******************************************/
	function saveStatusChk() {
			var tree = J("#tree").dynatree("getTree");
			var selectNode = tree.serializeManKpiIdString();

			#if($!{actualInputTermYn} == 'N')
				J.showMsgBox("실적입력 기한이 아닙니다.", null, null);
				return false;
			#end

			if("" == selectNode) {
				J.showMsgBox("선택된 지표가 없습니다.", null, null);
				return false;
			}

			return true;
	}

	/******************************************
	 * 반려조회 버튼
	 ******************************************/
	function showReturnView() {

			var actualStatusId = J("#actualStatusId").val();

			if(actualStatusId == "05") {
				J("#btnReturnView").show();
			} else {
				J("#btnReturnView").hide();
			}

	}

	/******************************************
	 * 반려조회 팝업호출
	 ******************************************/
	function returnPopView() {
		var year = J("#findYear").val();
		var mon = J("#findMon").val();
		var manKpiId = J("#manKpiId").val();

		J("#anchor").attr("href","$!{context_path}/man/tam/actualMng/popReturnView.vw?year="+ year + "&amp;mon=" + mon + "&amp;manKpiId=" + manKpiId);
		J("#anchor").click();
		return false;
	}

	/******************************************
	 * 반려 입력 팝업호출
	 ******************************************/
	function returnPop() {
			if(!saveStatusChk()) return;

			J("#anchor").attr("href","$!{context_path}/man/tam/actualMng/popReturnActual.vw?findYear=$!{searchMap.txt2html("year")}");
			J("#anchor").click();
	}

//]]>
</script>

<div id="Table">
	<div id="Table_blockContainer">
		<h1 class="none">실적입력/승인</h1>
		<div class="tableTop">
			#parse("/WEB-INF/vl/common/template/tabs.vm")

    		<!-- search S -->
			<form id="formFind" name="formFind" method="post" action="$!{context_path}/man/tam/actualMng/actualMngList.vw?type=template">
				<input type="hidden"    id="findHighPgmId"  name="findHighPgmId"    value="$!{searchMap.txt2html("findHighPgmId")}" />
				<input type="hidden"    id="findSubPgmId"   name="findSubPgmId"     value="$!{searchMap.txt2html("findSubPgmId")}" />
				<input type="hidden"    id="findPgmId"      name="findPgmId"        value="$!{searchMap.txt2html("findPgmId")}" />
				<input type="hidden"    id="findActualType"	name="findActualType"	value="$!{searchMap.txt2html("findActualType")}" />
				<input type="hidden"	id="findMetricId"	name="findMetricId"		value="$!{searchMap.txt2html("metricId")}" />
				<input type="hidden"	id="flag"			name="flag"		 		value="$!{searchMap.txt2html("flag")}" />

				<div class="searchBox">
    				<div><div><div>
    				<table summary="실적입력/승인검색 조건">
						<caption class="none">실적입력/승인 검색 조건</caption>
						<thead><tr><th></th></tr></thead>
        				<tbody>
            				<tr>
								<td class="searchBox_tit w250">
            						<span><label for="findYear">$!{YEARMON}</label></span>
            						<span class="searchBar">
            							<select id="findYear" name="findYear" class="select w80">
            								$!CS_CODE.getCodeOption("017", $!{searchMap.txt2html("findYear")})
            							</select>
										<select id="findMon" name="findMon" class="select w70">
            								$!CS_CODE.getCodeOption("024", $!{searchMap.txt2html("findMon")})
            							</select>
            						</span>
            					</td>
								<td class="searchBox_tit w200">
								#if($!{searchMap.txt2html("findActualType")} == "input")
									<span>입력담당자</span>
									<span class="searchBar">
									#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("60"))
            							<select id="findUserId" name="findUserId" class="select w80" onchange="chgUserId();">
            								<option value = "" >미지정</option>
            								<option value="ALL" $searchMap.getSelected("findUserId", "ALL") >전체</option>
            								#foreach($userList in $userList)
												<option value="$!{CS_HTML.txt2html($userList.USER_ID)}" $searchMap.getSelected("findUserId", "$!{CS_HTML.txt2html($userList.USER_ID)}")>$!{CS_HTML.txt2html($userList.USER_NM)}</option>
											#end

            							</select>
									#else
										$!{CS_LOGIN.getUser_nm()}
										<input type="hidden" id="findUserId" name="findUserId" value="$!{CS_LOGIN.getUser_id()}" />
									#end
								#elseif($!{searchMap.txt2html("findActualType")} == "check")
									<span>확인담당자</span>
									<span class="searchBar">
										#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("60"))
                							<select id="findUserId" name="findUserId" class="select w80" onchange="chgUserId()">
                								<option value = "" >미지정</option>
                								<option value="ALL" $searchMap.getSelected("findUserId", "ALL") >전체</option>
                								#foreach($userList in $userList)
    												<option value="$!{CS_HTML.txt2html($userList.USER_ID)}" $searchMap.getSelected("findUserId", "$!{CS_HTML.txt2html($userList.USER_ID)}")>$!{CS_HTML.txt2html($userList.USER_NM)}</option>
    											#end
                							</select>
										#else
											$!{CS_LOGIN.getUser_nm()}
											<input type="hidden" id="findUserId" name="findUserId" value="$!{CS_LOGIN.getUser_id()}" />
										#end
            						</span>
            					#else
            					<span>실적확인자</span>
            						<span class="searchBar">
										#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("60"))

                							<select id="findUserId" name="findUserId" class="select w80" onchange="chgUserId()">
                								    <option value="">미지정</option>
                								    <option value="ALL" $searchMap.getSelected("findUserId", "ALL") >전체</option>
                								#foreach($userList in $userList)
    												<option value="$!{CS_HTML.txt2html($userList.USER_ID)}" $searchMap.getSelected("findUserId", "$!{CS_HTML.txt2html($userList.USER_ID)}")>$!{CS_HTML.txt2html($userList.USER_NM)}</option>
    											#end
                							</select>
										#else
											$!{CS_LOGIN.getUser_nm()}
											<input type="hidden" id="findUserId" name="findUserId" value="$!{CS_LOGIN.getUser_id()}" />
										#end
            						</span>
								#end
            					</td>
            					<td class="searchBox_tit w200">
            						<span>처리상태</span>
            						<span class="searchBar">
            							<select id="findActualStatusId" name="findActualStatusId" class="select w110" onchange="goSearchStatus();" >
											#if( $!{searchMap.txt2html("flag")} != "1" )
											<option value="ALLSTATUS" >전체</option>
											#end
											#if($!{searchMap.txt2html("findActualType")} == "input")
            								$!CS_CODE.getCodeOption("195", $!{searchMap.txt2html("findActualStatusId")})
            								#elseif($!{searchMap.txt2html("findActualType")} == "check")
            								$!CS_CODE.getCodeOption("195", $!{searchMap.txt2html("findActualStatusId")})
            								#else
            								$!CS_CODE.getCodeOption("015", $!{searchMap.txt2html("findActualStatusId")})
            								#end
            							</select>
            						</span>
            					</td>
							</tr>
        				</tbody>
    				</table>
                    <input type="image" class="btnSearch" src="$!{img_path}/common/btn_search.gif" align="middle" alt="검색" />
                    </div></div></div>
    	        </div>
    		</form>
    		<!-- search E -->
			<div class="clear"></div>
		</div>

		<form id="formList" name="formList" method="post" enctype="multipart/form-data" action="$!{context_path}/man/tam/actualMng/actualMngProcess.vw?type=template">
			<input type="hidden" id="mode"       		name="mode" />
			<input type="hidden" id="year"		 		name="year" />
			<input type="hidden" id="mon"		 		name="mon" />
			<input type="hidden" id="manKpiId"  		name="manKpiId" />
			<input type="hidden" id="actualStatusId"	name="actualStatusId" />

			<input type="hidden" id="returnReason"		name="returnReason" />

			$!{searchMap.makeHiddenFind()}
			<div id="splitterBox">
				<div>
					<table width="100%" border="0" cellspacing="0" cellpadding="0" summary="실적입력">
						<tr>
							<td class="valign_top blockSearch textRight">
								#if($!{searchMap.txt2html("findActualType")} == "input")
									<a href="javascript:goStatus('06');"><img src="$!{img_path}/common/bt_01_3.gif" alt="확인요청" class="btn02" /></a>
								#elseif($!{searchMap.txt2html("findActualType")} == "check")
									<a href="javascript:goStatus('03');"><img src="$!{img_path}/common/bt_02_4.gif" alt="확인" class="btn02" /></a>
									<input id="btnReturn" type="image" src="$!{img_path}/common/bt_03.gif"  alt="반려" class="btn02" />
								#else
									<div style="padding-left:6px">
    									<a href="javascript:fncSelectAll(true);"><img src="$!{img_path}/common/bt_14.gif" alt="전체선택" class="btn02" align="left"/></a>
    									<a href="javascript:fncSelectAll(false);"><img src="$!{img_path}/common/bt_15.gif" alt="전체해제" class="btn02" align="left"/></a>
    									<a href="javascript:goStatus('04');"><img src="$!{img_path}/common/bt_02.gif" alt="승인" class="btn02" /></a>
    									<input id="btnReturn" type="image" src="$!{img_path}/common/bt_03.gif"  alt="반려" class="btn02" />
									</div>
								#end
								<!-- 조직트리 Start -->
                				<div class="blockGridTreeTable floatLeft" style="margin-top:10px;">
                					#parse("/WEB-INF/vl/man/tam/actualMng/actualTree.vm")
                				</div>

								<!-- 범례 Start -->
                				<div class="blockLegendTable floatLeft" style="margin-top:10px;">
									<ul>
										<li class="strong">[실적승인상태 범례]</li>
										<li>&nbsp;(미) : 미입력</li>
										<li>&nbsp;(입) : 입력완료</li>
    									<li>&nbsp;(요) : 확인요청</li>
    									<li>&nbsp;(확) : 확인/승인요청</li>
    									<li>&nbsp;(승) : 승인</li>
    									<li>&nbsp;(반) : 반려</li>
									</ul>
                				</div>
            				</td>
							<td>&nbsp;&nbsp;</td>
							<td class="textRight valign_top">
            					<!-- 실적입력 Start -->
            					<div id="detailData" class="blockDetailForTree"></div>
							</td>
						</tr>
					</table>
					<div class="blockButton_all floatLeft">
						<div class="blockButton_l">
							#if($!{searchMap.txt2html("findActualType")} == "input")
								#if($!{actualInputTermYn} == 'N')
									<span id="closeAlert" class="txt_red2">※실적입력 기한이 아닙니다.</span><br/>
								#end
							#end
						</div>
					</div>
				</div>
			</div>
		</form>

	</div>
	<a id="anchor"></a>
	<div class="clear"></div>
</div>
