<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="man.mon.MetricDetail">

	<!--
	==================================================================
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	:
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />


	<!--
	==================================================================
	  # 설명	: 이행성과지표 상세 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR
		    , A.STRAT_ID
		    , A.STRAT_NM
		    , A.TGT_STATUS_ID
		    , A.MAN_ID
		    , A.MAN_NM
		    , A.CSF_ID
		    , A.CSF_NM
		    , A.MAN_KPI_ID
		    , A.MAN_KPI_NM
		    , A.EVAL_CYCLE AS CYCLE_ID
			, F_CODE_NM('008', A.EVAL_CYCLE, A.YEAR) AS CYCLE_NM
		    , A.UNIT AS UNIT_ID
		    , F_CODE_NM('013', A.UNIT, A.YEAR) AS UNIT_NM
		    , A.INSERT_USER_ID
		    , A.INSERT_USER_NM
		    , B.DEPT_ID AS INSERT_DEPT_ID
		    , D.DEPT_KOR_NM
		    , E.VALUE
		    , E.TGT_VALUE
		    , E.STATUS_ID
		    , COUNT(A.STRAT_ID) OVER (PARTITION BY A.YEAR, A.STRAT_ID)AS STRAT_CNT
		    , ROW_NUMBER() OVER(PARTITION BY A.YEAR, A.STRAT_ID ORDER BY A.CSF_ORDER, A.STRAT_ID, A.CSF_ID, A.KPI_ORDER, A.MAN_KPI_ID) AS STRAT_INDEX
		    , COUNT(A.CSF_ID) OVER(PARTITION BY A.YEAR, A.CSF_ID) AS SUBJECT_CNT
		    , ROW_NUMBER() OVER(PARTITION BY A.YEAR, A.CSF_ID ORDER BY A.CSF_ORDER, A.CSF_ID, A.KPI_ORDER, A.MAN_KPI_ID) AS SUBJECT_INDEX
		FROM V_MAN_METRIC A
		LEFT OUTER JOIN V_ROLE_USER B
			ON  A.INSERT_USER_ID = B.SABUN
		LEFT OUTER JOIN V_DEPTINFO C
			ON  B.DEPT_ID = C.DEPT_ID
		LEFT OUTER JOIN BSC_INSA_DEPT D
			ON A.YEAR = D.YEAR
			AND B.DEPT_ID = D.DEPT_CD
		LEFT OUTER JOIN MAN_METRICSCORE E
			ON A.YEAR = E.YEAR AND A.MAN_KPI_ID = E.MAN_KPI_ID
			AND E.MON = #findMon#
			AND E.ANAL_CYCLE = #findAnalCycle#
		LEFT OUTER JOIN MAN_METRIC F
			ON A.YEAR = F.YEAR
			AND A.MAN_KPI_ID = F.MAN_KPI_ID
			AND A.MAN_KPI_GRP_ID = F.MAN_KPI_GRP_ID
		WHERE A.YEAR = #findYear#
		AND F.MONITORING_YN  = 'Y'
		<dynamic>
			<isNotEmpty prepend="AND" property="findManagementId">
	           	A.MAN_ID = #findManagementId#
	   		</isNotEmpty>
            <isNotEmpty prepend="AND" property="findStratSubjectId">
                A.STRAT_ID = #findStratSubjectId#
           	</isNotEmpty>
			<isNotEmpty prepend="AND" property="findCsfId">
                A.CSF_ID = #findCsfId#
            </isNotEmpty>
	    </dynamic>
         ORDER BY A.STRAT_ORDER, A.STRAT_ID, A.CSF_ORDER, A.CSF_ID, A.KPI_ORDER, A.MAN_KPI_ID
	</select>

	<!--
	==================================================================
	  # 설명	: 경영목표 조회조건목록
	  #	기능	: SELECT
	  #	TABLE	: MAN_TARGET
	==================================================================
	-->
	<select id="getManagement" parameterClass="hashMap" resultClass="hashMap">
	SELECT YEAR
                ,MAN_ID
                ,MAN_NM
                ,SORT_ORDER
      FROM MAN_TARGET
      WHERE YEAR= #findYear#
      AND DELETE_DT IS NULL
      ORDER BY SORT_ORDER
	</select>

	<!--
	==================================================================
	  # 설명	: 전략과제 조회조건목록
	  #	기능	: SELECT
	  #	TABLE	: MAN_STRATEGY
	==================================================================
	-->
	<select id="getStratSubjectList" parameterClass="hashMap" resultClass="hashMap">
		SELECT  STRAT_ID
					,STRAT_NM
		FROM MAN_STRATEGY
		WHERE YEAR =#findYear#
			AND DELETE_DT IS NULL
			AND MAN_ID = #findManagementId#
		ORDER BY SORT_ORDER
	</select>

	<!--
	==================================================================
	  # 설명	: CSF 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: MAN_CSF
	==================================================================
	-->
	<select id="getCsfList" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
			, CSF_ID
			, CSF_NM
			, SORT_ORDER
		FROM MAN_CSF
		WHERE YEAR = #findYear#
			AND DELETE_DT IS NULL
			AND STRAT_ID =#findStratSubjectId#
		ORDER BY CSF_NM, SORT_ORDER
	</select>

</sqlMap>


