<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bsc.base.scDeptMapping">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 성과조직 트리 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_SC_DEPT
	==================================================================
	-->
	<select id="getScDeptMappingTreeList" parameterClass="hashMap" resultClass="hashMap">
		SELECT  A.SC_DEPT_ID AS CODE_ID,
				A.UP_SC_DEPT_ID AS UP_CODE_ID,
				LEVEL AS LEVEL_ID,
                CASE
                   WHEN B.DEPT_NMS IS NULL THEN A.SC_DEPT_NM
                   ELSE A.SC_DEPT_NM || '(' || LTRIM(B.DEPT_NMS, ',') || ')'
                END
                   AS CODE_NM,
                DECODE (B.DEPT_NMS,
                        '', 'mappingTree_txt_black',
                        'mappingTree_txt_black')
                   AS PARAM 
          FROM    BSC_SC_DEPT A
	LEFT OUTER JOIN
				( SELECT YEAR,
						 SC_DEPT_ID,
						 MAX(SYS_CONNECT_BY_PATH (DEPT_NM, ',')) DEPT_NMS
					FROM  ( SELECT  YEAR,
									SC_DEPT_ID,
									DEPT_NM,
									ROW_NUMBER () OVER (PARTITION BY YEAR, SC_DEPT_ID ORDER BY DEPT_NM) RN
							  FROM (SELECT A.YEAR, A.SC_DEPT_ID, B.DEPT_NM
									  FROM    BSC_SC_DEPT_MAPPING A
								INNER JOIN BSC_DEPTINFO B
										ON A.DEPT_ID = B.DEPT_ID
                                                                       ))
                      START WITH RN = 1
                      CONNECT BY     PRIOR YEAR = YEAR
                                 AND PRIOR SC_DEPT_ID = SC_DEPT_ID
                                 AND PRIOR RN = RN - 1
                        GROUP BY YEAR, SC_DEPT_ID
                        ) B
                  ON A.YEAR = B.YEAR AND A.SC_DEPT_ID = B.SC_DEPT_ID
            WHERE A.YEAR = #findYear# AND A.DELETE_DT IS NULL
       START WITH A.UP_SC_DEPT_ID IS NULL
       CONNECT BY PRIOR A.SC_DEPT_ID = A.UP_SC_DEPT_ID AND PRIOR A.YEAR = A.YEAR
ORDER SIBLINGS BY A.SORT_ORDER, A.SC_DEPT_ID
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 실조직 트리 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_DEPTINFO
	==================================================================
	-->
	<select id="getDeptMappingTreeList" parameterClass="hashMap" resultClass="hashMap">
		SELECT     A.DEPT_ID AS CODE_ID
		         , A.UP_DEPT_ID AS UP_CODE_ID
		         , LEVEL AS LEVEL_ID
		         , CASE
		              WHEN B.SC_DEPT_NMS IS NULL
		                 THEN A.DEPT_NM
		              ELSE A.DEPT_NM || '(' || B.SC_DEPT_NMS || ')'
		           END AS CODE_NM
		         , DECODE(B.SC_DEPT_NMS, '', 'mappingTree_txt_red', 'mappingTree_txt_black') AS PARAM
		      FROM BSC_DEPTINFO A
		           LEFT OUTER JOIN
		           (SELECT     YEAR
		                     , DEPT_ID
		                     , LTRIM ( (SYS_CONNECT_BY_PATH (SC_DEPT_NM, ', ')), ', ') SC_DEPT_NMS
		                  FROM (SELECT YEAR
		                             , DEPT_ID
		                             , SC_DEPT_NM
		                             , ROW_NUMBER () OVER (PARTITION BY YEAR, DEPT_ID ORDER BY SC_DEPT_NM) RN
		                          FROM (SELECT A.YEAR
		                                     , A.DEPT_ID
		                                     , B.SC_DEPT_NM
		                                  FROM BSC_SC_DEPT_MAPPING A INNER JOIN BSC_SC_DEPT B ON A.YEAR = B.YEAR
		                                                                                    AND A.SC_DEPT_ID = B.SC_DEPT_ID
		                                 WHERE A.YEAR = #findYear#))
		            START WITH RN = 1
		            CONNECT BY PRIOR YEAR = YEAR
		                   AND PRIOR DEPT_ID = DEPT_ID
		                   AND PRIOR RN = RN - 1
		              GROUP BY YEAR, DEPT_ID, SC_DEPT_NM) B ON A.DEPT_ID = B.DEPT_ID
		     WHERE A.BEING_YN = 'Y'
		START WITH A.UP_DEPT_ID = '0000'
		CONNECT BY PRIOR A.DEPT_ID = A.UP_DEPT_ID
		  ORDER SIBLINGS BY A.OUORDER, A.DEPT_ID
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">

	</select>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직기준 매핑 등록, 단 Tree 사용을 위해 실조직코드앞에 임의로 A를 붙인 것 제거하여 insert 함.
	  #	기능	: INSERT
	  #	TABLE	: 
	==================================================================
	-->	
	<insert id="insertScDeptMappingData" parameterClass="hashMap">
		INSERT INTO BSC_SC_DEPT_MAPPING
		     VALUES (#findYear#, #scDeptMappingId#, #findScDeptId#, SYSDATE)
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직에 매핑된 실조직 리스트 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_SC_DEPT_MAPPING
	==================================================================
	-->
	<select id="selectDeptMappingData" parameterClass="hashMap" resultClass="java.lang.Integer">
		SELECT COUNT(*) CNT
		  FROM BSC_SC_DEPT_MAPPING
		 WHERE YEAR = #findYear#
		   AND DEPT_ID = #scDeptMappingId#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 실조직기준 매핑 등록
	  #	기능	: INSERT
	  #	TABLE	: 
	==================================================================
	-->	
	<insert id="insertDeptMappingData" parameterClass="hashMap">
		INSERT INTO BSC_SC_DEPT_MAPPING
		     VALUES (#findYear#, #findDeptId#, #deptMappingId#, SYSDATE)
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 수정
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		
	</update>	

	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 삭제
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">

	</update>
	
	<!--
	==================================================================   
	  # 설명	: 선택한 성과조직의  모든 매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<delete id="deleteScDeptMappingData" parameterClass="hashMap">
		DELETE BSC_SC_DEPT_MAPPING
	     WHERE YEAR = #findYear#
	       AND SC_DEPT_ID = #findScDeptId#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 선택한 실조직의  모든 매핑 삭제, 단 Tree 사용을 위해 실조직코드앞에 임의로 A를 붙인 것 제거하여 사용.
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<delete id="deleteDeptMappingData" parameterClass="hashMap">
		DELETE BSC_SC_DEPT_MAPPING
	     WHERE YEAR = #findYear#
	       AND DEPT_ID = #findDeptId#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직에 매핑된 실조직 리스트 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_SC_DEPT_MAPPING
	==================================================================
	-->
	<select id="getMappingDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT DEPT_ID
		  FROM BSC_SC_DEPT_MAPPING
		 WHERE YEAR = #findYear#
		   AND SC_DEPT_ID = #findScDeptId#
	  ORDER BY DEPT_ID
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 실조직에 매핑된 성과조직 리스트 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_SC_DEPT_MAPPING
	==================================================================
	-->
	<select id="getMappingScDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT SC_DEPT_ID
		  FROM BSC_SC_DEPT_MAPPING
		 WHERE YEAR = #findYear#
		   AND DEPT_ID = #findDeptId#
	  ORDER BY SC_DEPT_ID
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직매핑관리 엑셀다운로드
	  #	기능	: SELECT
	  #	TABLE	: BSC_SC_DEPT_MAPPING
	==================================================================
	-->
	<select id="getExcelList" parameterClass="hashMap" resultClass="hashMap">
		SELECT   A.YEAR
		       , A.DEPT_ID
		       , B.DEPT_NM
		       , A.SC_DEPT_ID
		       , C.SC_DEPT_NM
		       , C.SORT_ORDER
		    FROM BSC_SC_DEPT_MAPPING A
		    	 LEFT OUTER JOIN BSC_DEPTINFO B ON A.DEPT_ID = B.DEPT_ID
		         LEFT OUTER JOIN BSC_SC_DEPT C ON A.YEAR = C.YEAR
		                                     AND A.SC_DEPT_ID = C.SC_DEPT_ID
		   WHERE A.YEAR = #findYear#
		ORDER BY C.SORT_ORDER, A.SC_DEPT_ID, A.DEPT_ID
	</select>
	
</sqlMap>


