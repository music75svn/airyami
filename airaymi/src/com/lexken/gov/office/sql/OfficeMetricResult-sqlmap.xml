<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="gov.office.officeMetricResult">

	<!--
	==================================================================
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: GOV_OFFICE
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />


	<!--
	==================================================================
	  # 설명	: 공공기관 경영평가지표 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: GOV_OFFICE
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT O.YEAR
           	 , O.OFFICE_EVAL_GRP_ID
           	 , OG.OFFICE_EVAL_GRP_NM
           	 , O.OFFICE_ID
           	 , O.OFFICE_NM
          	 , COUNT(*) OVER( PARTITION BY O.OFFICE_EVAL_GRP_ID) AS OG_CNT
          	 , ROW_NUMBER() OVER(PARTITION BY O.OFFICE_EVAL_GRP_ID
                                 ORDER BY OG.SORT_ORDER NULLS LAST, O.OFFICE_EVAL_GRP_ID
                                , O.SORT_ORDER NULLS LAST, O.OFFICE_ID ) AS OG_ROWNUM
             , (SELECT COUNT(1)
                FROM GOV_OFFICE_METRIC GOM
                INNER JOIN GOV_METRIC_GRP GMG
                        ON GOM.YEAR = GMG.YEAR
                       AND GOM.GOV_METRIC_GRP_ID = GMG.GOV_METRIC_GRP_ID
                 WHERE GOM.YEAR = O.YEAR
                   AND GOM.OFFICE_ID = O.OFFICE_ID) AS CNT
             , (SELECT COUNT(1)
                FROM GOV_OFFICE_METRIC GOM
                INNER JOIN GOV_METRIC_GRP GMG
                        ON GOM.YEAR = GMG.YEAR
                       AND GOM.GOV_METRIC_GRP_ID = GMG.GOV_METRIC_GRP_ID
                 WHERE GOM.YEAR = O.YEAR
                   AND GOM.OFFICE_ID = O.OFFICE_ID
                   AND (GOM.WEIGHT IS NOT NULL OR GOM.SCORE IS NOT NULL OR GOM.ACT IS NOT NULL) ) AS INPUT_CNT
          FROM GOV_OFFICE O
          LEFT OUTER JOIN GOV_OFFICE_GRP OG
					   ON O.YEAR = OG.YEAR
              		  AND O.OFFICE_EVAL_GRP_ID = OG.OFFICE_EVAL_GRP_ID
         WHERE 1=1
		   AND O.YEAR = #findYear#
		 <isNotEmpty property="findOfficeEvalGrpId">
		   AND O.OFFICE_EVAL_GRP_ID = #findOfficeEvalGrpId#
		 </isNotEmpty>
		 ORDER BY OG.SORT_ORDER NULLS LAST, O.OFFICE_EVAL_GRP_ID, O.SORT_ORDER NULLS LAST, O.OFFICE_ID
	</select>

	<!--
	==================================================================
	  # 설명	: 공공기관 평가군 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: GOV_OFFICE_GRP
	==================================================================
	-->
	<select id="getOfficeGrpList" parameterClass="hashMap" resultClass="hashMap">
		SELECT OFFICE_EVAL_GRP_ID, OFFICE_EVAL_GRP_NM
		  FROM GOV_OFFICE_GRP
		 WHERE 1=1
		   AND YEAR = #findYear#
		 ORDER BY SORT_ORDER NULLS LAST, OFFICE_EVAL_GRP_ID
	</select>

	<!--
	==================================================================
	  # 설명		: 공공기관 경영평가지표 결과 상세 보기
	  #	기능		: SELECT
	  #	TABLE	: GOV_OFFICE_METRIC
	==================================================================
	-->
	<select id="getResultList" parameterClass="hashMap" resultClass="hashMap">
		SELECT GOM.YEAR
             , GOM.GOV_OFF_METRIC_ID
             , GOM.OFFICE_ID
             , GOF.OFFICE_NM
             , GOM.GOV_METRIC_GRP_ID
             , GMG.GOV_METRIC_GRP_NM
             , GOM.WEIGHT
             , TO_CHAR(GOM.SCORE, 90.999) SCORE
             , GOM.ACT
          FROM GOV_OFFICE_METRIC GOM
          INNER JOIN V_GOV_METRIC_GRP VGOF
                                ON GOM.YEAR = VGOF.YEAR
                               AND GOM.GOV_METRIC_GRP_ID = VGOF.GOV_METRIC_GRP_ID
          LEFT OUTER JOIN GOV_OFFICE GOF
                                ON GOM.OFFICE_ID = GOF.OFFICE_ID
                               AND GOM.YEAR = GOF.YEAR
          LEFT OUTER JOIN GOV_METRIC_GRP GMG
                                ON GOM.GOV_METRIC_GRP_ID = GMG.GOV_METRIC_GRP_ID
                               AND GOM.YEAR = GMG.YEAR
         WHERE 1 = 1
           AND GOM.YEAR = #year#
           AND GOM.OFFICE_ID = #officeId#
         ORDER BY CAT_GRP_SORT, CAT_SORT, METRIC_GRP_SORT
	</select>

	<!--
	==================================================================
	  # 설명		: 공공기관 경영평가지표 엑셀 다운 목록 보기
	  #	기능		: SELECT
	  #	TABLE	: GOV_OFFICE_METRIC
	==================================================================
	-->
	<select id="getExcelList" parameterClass="hashMap" resultClass="hashMap">
		SELECT GOM.YEAR
	         ,  GOG.OFFICE_EVAL_GRP_ID
	         ,  GOG.OFFICE_EVAL_GRP_NM
	         ,  GOM.GOV_OFF_METRIC_ID
	         ,  GOF.OFFICE_ID
	         ,  GOF.OFFICE_NM
	         ,  GMG.GOV_METRIC_GRP_ID
	         ,  GMG.GOV_METRIC_GRP_NM
	         ,  GOM.WEIGHT
	         ,  GOM.SCORE
	         ,  GOM.ACT
	         ,  COUNT (*) OVER (PARTITION BY GOF.OFFICE_EVAL_GRP_ID) AS CNT
		FROM GOV_OFFICE_METRIC GOM
		INNER JOIN GOV_OFFICE GOF
		                     ON GOM.YEAR = GOF.YEAR
		                    AND GOM.OFFICE_ID = GOF.OFFICE_ID
		LEFT OUTER JOIN GOV_METRIC_GRP GMG
		                     ON GOM.YEAR = GMG.YEAR
		                   AND GOM.GOV_METRIC_GRP_ID = GMG.GOV_METRIC_GRP_ID
		LEFT OUTER JOIN GOV_OFFICE_GRP GOG
		                     ON GOM.YEAR = GOG.YEAR
		                   AND GOF.OFFICE_EVAL_GRP_ID = GOG.OFFICE_EVAL_GRP_ID
	</select>

	<!--
	==================================================================
	  # 설명		: 공공기관 등록
	  #	기능		: INSERT
	  #	TABLE	: GOV_OFFICE_METRIC
	==================================================================
	-->
	<update id="updateData" parameterClass="hashMap">
		UPDATE GOV_OFFICE_METRIC
           SET WEIGHT = #weight#
            ,  SCORE = #score#
            ,  ACT = #act#
         WHERE 1 = 1
           AND YEAR = #year#
           AND GOV_OFF_METRIC_ID = #govOffMetricId#
	</update>

	<!--
	==================================================================
	  # 설명	: 공공기관 삭제
	  #	기능	: UPDATE
	  #	TABLE	: GOV_OFFICE_METRIC
	==================================================================
	-->
	<update id="deleteData" parameterClass="hashMap">
		UPDATE  GOV_OFFICE_METRIC
		   SET WEIGHT = ''
            ,  SCORE  = ''
            ,  ACT	  = ''
         WHERE YEAR = #year#
             AND GOV_OFF_METRIC_ID = #govOffMetricId#
	</update>


</sqlMap>


