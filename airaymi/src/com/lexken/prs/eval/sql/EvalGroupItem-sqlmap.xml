<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.eval.evalGroupItem">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: PRS_EVAL_GRP_ITEM
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 평가군_평가항목 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_EVAL_GRP_ITEM
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
				SELECT B.YEAR
					 , B.EVAL_ITEM_ID
					 , B.EVAL_ITEM_NM
					 , B.SCORE
					 , CASE D.EVAL_TYPE
				            WHEN '01' THEN '(100점 만점)'
				            WHEN '02' THEN '(100점 만점)'
				            WHEN '03' THEN '(100점 만점)'
				            WHEN '04' THEN '(100점 만점)'
				            WHEN '05' THEN '(100점 만점)'
				            WHEN '06' THEN '(10점 만점)'
				            WHEN '07' THEN '(10점 만점)'
				            WHEN '08' THEN '(10점 만점)'
				        END AS EVAL_SCORE
					 , REPLACE( REPLACE ( B.CONTENT, CHR(13), '' ), CHR(10), ' ' )  CONTENT
				  FROM PRS_EVAL_ITEM B
	   LEFT OUTER JOIN PRS_EVAL_GRP_ITEM C
		        	ON C.EVAL_ITEM_ID = B.EVAL_ITEM_ID
		           AND C.YEAR = B.YEAR
	   LEFT OUTER JOIN PRS_EVAL_GRP D
		        	ON D.EVAL_GRP_ID = C.EVAL_GRP_ID
		           AND D.YEAR = B.YEAR
				 WHERE B.YEAR = #findYear#
				   AND B.EVAL_ITEM_ID IN (
				                        SELECT EVAL_ITEM_ID
				                          FROM PRS_EVAL_GRP_ITEM A
				                         WHERE A.YEAR = #findYear#
				                           AND A.EVAL_GRP_ID = #findEvalGrpId#
				                        )
				   AND B.DELETE_DT IS NULL
					<isNotEmpty prepend="AND" property="findEvalItem">
					UPPER(B.EVAL_ITEM_NM) LIKE  '%' || TRIM(UPPER(#findEvalItem#)) ||'%'
					</isNotEmpty>
				 ORDER BY B.SORT_ORDER
	</select>
	
	<!--
	==================================================================   
	  # 설명	: EvalType 조회
	  #	기능	: SELECT
	  #	TABLE	: PRS_EVAL_GRP_ITEM
	==================================================================
	-->
	<select id="getEvalScore" parameterClass="hashMap" resultClass="hashMap">
				SELECT D.EVAL_TYPE
				  FROM PRS_EVAL_ITEM B
	   LEFT OUTER JOIN PRS_EVAL_GRP_ITEM C
		        	ON C.EVAL_ITEM_ID = B.EVAL_ITEM_ID
		           AND C.YEAR = B.YEAR
	   LEFT OUTER JOIN PRS_EVAL_GRP D
		        	ON D.EVAL_GRP_ID = C.EVAL_GRP_ID
		           AND D.YEAR = B.YEAR
				 WHERE B.YEAR = #findYear#
				   AND B.EVAL_ITEM_ID IN (
				                        SELECT EVAL_ITEM_ID
				                          FROM PRS_EVAL_GRP_ITEM A
				                         WHERE A.YEAR = #findYear#
				                           AND A.EVAL_GRP_ID = #findEvalGrpId#
				                        )
				   AND B.DELETE_DT IS NULL
					<isNotEmpty prepend="AND" property="findEvalItem">
					UPPER(B.EVAL_ITEM_NM) LIKE  '%' || TRIM(UPPER(#findEvalItem#)) ||'%'
					</isNotEmpty>
				 GROUP BY EVAL_TYPE
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가군_평가항목 맵핑등록
	  #	기능	: INSERT
	  #	TABLE	: PRS_EVAL_GRP_ITEM
	==================================================================
	-->	
	<insert id="insertMappingData" parameterClass="hashMap">
	<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
			SELECT 'EI'||LPAD(NVL(MAX(SUBSTR(EVAL_ITEM_ID,3,5)),0),5,'0') FROM PRS_EVAL_ITEM WHERE YEAR=#year#
		</selectKey>		
		INSERT INTO PRS_EVAL_GRP_ITEM ( 
			   YEAR
			 , EVAL_GRP_ID
			 , EVAL_ITEM_ID
			 , CREATE_DT
			 ) VALUES ( 
			   #year#
			 , #evalGrpId#
			 , #SEQ#
			 , SYSDATE
			 )
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: 평가항목 등록
	  #	기능	: INSERT
	  #	TABLE	: PRS_EVAL_ITEM
	==================================================================
	-->	
	<insert id="insertItemData" parameterClass="hashMap">
		<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
			SELECT 'EI'||LPAD(NVL(MAX(SUBSTR(EVAL_ITEM_ID,3,5)),0)+1,5,'0') FROM PRS_EVAL_ITEM WHERE YEAR=#year#
		</selectKey>
		
		INSERT INTO PRS_EVAL_ITEM (
		            YEAR
		          , EVAL_ITEM_ID
		          , EVAL_ITEM_NM
		          , SCORE
		          , CONTENT
		          , CREATE_DT
		          , MODIFY_DT
		          , DELETE_DT
		          , SORT_ORDER
		          ) VALUES ( 
		            #year#
		          , #SEQ#
		          , #evalItemNm#
		          , #score#
		          , #content#
		          , SYSDATE
		          , NULL
			 	  , NULL
			 	  , #sortOrder#
			 	  )
	</insert>	
		

	<!--
	==================================================================   
	  # 설명	: 평가군_평가항목 매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: PRS_EVAL_GRP_ITEM
	==================================================================
	-->	
	<delete id="deleteData" parameterClass="hashMap">
		DELETE FROM PRS_EVAL_GRP_ITEM 
		 WHERE YEAR 			= #year#
		   AND EVAL_ITEM_ID 	= #evalItemId#
		   AND EVAL_GRP_ID 		= #evalGrpId#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 평가항목 삭제
	  #	기능	: UPDATE
	  #	TABLE	: PRS_EVAL_ITEM
	==================================================================
	-->	
	<delete id="deleteItemData" parameterClass="hashMap">
		DELETE FROM PRS_EVAL_ITEM 
		 WHERE YEAR 			= #year#
		   AND EVAL_ITEM_ID 	= #evalItemId#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 평가항목 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_EVAL_ITEM
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
     		 , B.EVAL_ITEM_ID
     		 , B.EVAL_ITEM_NM
		     , B.EVAL_TYPE
		     , B.SCORE
		     , B.CONTENT
		     , B.CREATE_DT
		     , B.MODIFY_DT
		     , B.DELETE_DT
		     , B.SORT_ORDER
  		  FROM PRS_EVAL_GRP_ITEM A
  	INNER JOIN PRS_EVAL_ITEM B
			ON A.YEAR = B.YEAR
		   AND A.EVAL_ITEM_ID = B.EVAL_ITEM_ID
	INNER JOIN PRS_EVAL_GRP C
            ON B.YEAR = C.YEAR
           AND A.EVAL_GRP_ID = C.EVAL_GRP_ID
 		 WHERE YEAR = #year#
		   AND A.EVAL_GRP_ID = #evalGrpId#
   		   AND A.EVAL_ITEM_ID = #evalItemId#
		         
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가항목 수정
	  #	기능	: UPDATE
	  #	TABLE	: PRS_EVAL_ITEM
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE PRS_EVAL_ITEM
   		   SET EVAL_ITEM_NM = #evalItemNm#
     		 , SCORE = #score#
     		 , CONTENT = #content#
     		 , SORT_ORDER = #sortOrder#
     		 , MODIFY_DT = SYSDATE
		 WHERE YEAR = #year#
		   AND EVAL_ITEM_ID = #evalItemId#		
	</update>	
	
	
</sqlMap>


