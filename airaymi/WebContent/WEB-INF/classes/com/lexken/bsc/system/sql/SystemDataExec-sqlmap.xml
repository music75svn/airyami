<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bsc.system.systemDataExec">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 시스템연계 실행 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_SYSTEM_ITEM
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">         
		  SELECT A.YEAR
		       , B.MON
		       , A.ITEM_CD
		       , SUBSTR (A.ITEM_CD, 1, 4) ITEM_CD_PROC
		       , A.ITEM_NM
		       , TO_CHAR (B.INTERFACE_DT, 'YYYY-MM-DD HH24:MI:SS') INTERFACE_DT
		       , B.YM
		       , C.CODE_NM RESULT_YN
		       , NVL (A.USE_YN, 'N') USE_YN
		    FROM BSC_SYSTEM_ITEM A
		         LEFT OUTER JOIN (SELECT A.INTERFACE_DT
		                               , A.INTERFACE_ID
		                               , A.YM
		                               , SUBSTR (A.YM, 1, 4) YEAR
		                               , SUBSTR (A.YM, 5, 2) MON
		                               , PROC_NM
		                               , RESULT_YN
		                            FROM BSC_SYSTEM_INTERFACE_LOG A
		                               , (  SELECT MAX (INTERFACE_DT) INTERFACE_DT, INTERFACE_ID, YM
		                                      FROM BSC_SYSTEM_INTERFACE_LOG
		                                     WHERE YM = #findYear#||#findMon#
		                                  GROUP BY INTERFACE_ID, YM) B
		                           WHERE A.INTERFACE_DT = B.INTERFACE_DT
		                             AND A.INTERFACE_ID = B.INTERFACE_ID
		                             AND A.YM = B.YM) B
		            ON SUBSTR (A.ITEM_CD, 1, 4) = B.INTERFACE_ID
		           AND A.YEAR = B.YEAR
		           AND B.YEAR = #findYear#
		           AND B.MON = #findMon#
		         LEFT OUTER JOIN BSC_CODE C
		            ON B.RESULT_YN = C.CODE_ID
		           AND C.CODE_GRP_ID = '184'
		   WHERE A.YEAR = #findYear#
		     AND A.ITEM_DIVI = '01'
		     AND A.DELETE_DT IS NULL
		    <isNotEmpty prepend="AND" property="findItemNm" >
				UPPER(A.ITEM_NM) LIKE  '%' || TRIM(UPPER(#findItemNm#)) ||'%'
			</isNotEmpty>
		ORDER BY ITEM_CD
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 연계실행 자동연계여부 변경
	  #	기능	: UPDATE
	  #	TABLE	: BSC_SYSTEM_ITEM
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE BSC_SYSTEM_ITEM SET
			   USE_YN 		= #useYn#
			 , MODIFY_DT 	= SYSDATE
		 WHERE YEAR = #year#
		   AND ITEM_CD = #itemCd# 	     
	</update>		
	
	<!--
	==================================================================   
	  # 설명	: 연계실행 파라미터 맵
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->		
	<parameterMap id="interfaceParamMap" class="java.util.HashMap">
		<parameter property="year" 		jdbcType="VARCHAR"  javaType="java.lang.String" mode="IN"/>
		<parameter property="mon" 		jdbcType="VARCHAR"  javaType="java.lang.String" mode="IN"/>			
	</parameterMap>			
	
	<!--
	==================================================================   
	  # 설명	: 연계 프로시져 실행
	  #	기능	: PROCEDURES
	  #	TABLE	: BSC_INTERFACE_ORIGINAL_DATA
	==================================================================
	-->		
	<procedure id="execInterface" parameterMap="interfaceParamMap">  
		{CALL SP_BSC_$itemProcCds$_ORIGINAL_DATA(?, ?)}
	</procedure>
	
	<!--
	==================================================================   
	  # 설명	: 연계실행 실행자 기록
	  #	기능	: UPDATE
	  #	TABLE	: BSC_SYSTEM_ITEM
	==================================================================
	-->	
	<update id="updateUser" parameterClass="hashMap">
		UPDATE BSC_SYSTEM_INTERFACE_LOG
		   SET USER_ID = #UserId#
			 , USER_NM = #UserNm#
	   	 WHERE YM = #year#||#mon#
		   AND INTERFACE_ID = #itemProcCds#
	</update>	
 
	
	
</sqlMap>


