#*************************************************************************
* CLASS 명      : memEvalGroupModify
* 작 업 자      : 유연주
* 작 업 일      : 2017년 03월 10일 
* 기    능      : 평가그룹관리  
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자    작     업     일        변 경 내 용                비고
* ----  --------  -----------------  -------------------------  --------
*  1    유연주      2017년 03월 10일             최 초 작 업 
**************************************************************************# 

<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;
	var grdRowId = 0;
	
	J(document).ready(function(){
    
		/******************************************
		 * 데이터 그리드 출력
		 ******************************************/
		var str = J('#form1').serialize();

		jQuery("#list").jqGrid({
			url          :"$!{context_path}/mem/base/memEvalGroup/memEvalGroupModifyList_xml.vw" + "?" + str,
			mtype        :"POST",
			datatype     :"json",
			jsonReader   : {
    						page   : "page",
    						total  : "total",
    						root   : "rows",
    						records: function(obj){return obj.length;},
    						repeatitems: false,
    						id     : "id"
    				       },
			height       : "200",
			width        : $!{jqGrid_width},
			colNames     :['기준년도', '평가그룹', '평가그룹대상', '직급', '직위', '년차', '년차구분', '적용기준일'],
			colModel     :[
							{name:'YEAR'                 ,index:'YEAR'                 ,width:150   ,align:'center' },
                            {name:'EVAL_GRP_ID'          ,index:'EVAL_GRP_ID'          ,width:150   ,align:'center' },
                            {name:'EVAL_GRP_TRG_SEQ'     ,index:'EVAL_GRP_TRG_SEQ'     ,width:150   ,align:'center' },
                            {name:'CAST_TC'         	 ,index:'CAST_TC'    	       ,width:200   ,align:'center' ,formatter:goCastTc},
							{name:'POS_TC'         		 ,index:'POS_TC'    	       ,width:200   ,align:'center' ,formatter:goPosTc},
							{name:'YEAR_TC'         	 ,index:'YEAR_TC'    	       ,width:100   ,align:'center' ,formatter:goYearTc},
                            {name:'YEAR_TC_GUBUN'        ,index:'YEAR_TC_GUBUN'        ,width:100   ,align:'center' ,formatter:goYearTcGubun},
                            {name:'APPLY_DT'             ,index:'APPLY_DT'             ,width:100   ,align:'center' ,formatter:goApplyDt}
							],
			rowNum       : $!{jqGrid_rownum},
			autowidth    : false,
			viewrecords  : true,
			loadonce     : true,
			multiselect  : true,
			cellEdit     : true,
			gridview     : true,
			##cmTemplate   : {sortable:false},
			loadComplete : function() {
					grdRowId = J("#list").getDataIDs().length;
					J("input[name=yearTcs]").numeric({allow:""});        	//특정문자 허용(.)
					J("input[name=yearTcs]").css("ime-mode", "disabled"); 	//한글사용 비활성화
				  },
			caption:"평가그룹"
		}).jqGrid('hideCol',"YEAR").jqGrid('hideCol',"EVAL_GRP_ID").jqGrid('hideCol',"EVAL_GRP_TRG_SEQ").setGridWidth($!{jqGrid_width});
    
		/******************************************
		 * 취소버튼 (돌아가기)
		 ******************************************/
		J("#btnBack").click(function() {
			J("#form1").attr("action", "$!{context_path}/mem/base/memEvalGroup/memEvalGroupList.vw?type=template").submit();
		});
        
		/******************************************
		 * 저장버튼 이벤트
		 ******************************************/
		J("#btnInsert").click(function(e) {
			e.preventDefault();
			saveChk();
		});

		/******************************************
		 * 저장버튼 이중 클릭 방지
		 ******************************************/
		J("form").submit(function(){
			J("#btnInsert").unbind();
		});
		
		/******************************************
		 * 정렬순서 숫자만 입력
		 ******************************************/
		J("#sortOrder").numeric();
		J("#sortOrder").css("ime-mode", "disabled");
	});
	
	/******************************************
     * jqGrid 직급코드
     ******************************************/
    function goCastTc(cellvalue, options, rowObject) {
    	var str = "";
		var ids = "castTcs";
    	
    	str += '<select id="' + ids + '" name="' + ids + '" class="select w100">';
    #foreach($castTcList in $castTcList)
    	if (cellvalue == "$!{CS_HTML.txt2html($castTcList.CODE_ID)}") {
    		str += '	<option value="$!{CS_HTML.txt2html($castTcList.CODE_ID)}" selected>$!{CS_HTML.txt2html($castTcList.CODE_NM)}</option>';
    	}else{
    		str += '	<option value="$!{CS_HTML.txt2html($castTcList.CODE_ID)}">$!{CS_HTML.txt2html($castTcList.CODE_NM)}</option>';
    	}
    #end
        str += '</select>';
    	
    	return str;
    }
    
	/******************************************
     * jqGrid 직위코드
     ******************************************/
    function goPosTc(cellvalue, options, rowObject) {
    	
    	var str = "";
		var ids = "posTcs";
    	
    	str += '<select id="' + ids + '" name="' + ids + '" class="select w180">';
    	str += '	<option value="">전체</option>';
	#foreach($posTcList in $posTcList)
		if("100" != "$!{CS_HTML.txt2html($posTcList.CODE_ID)}"){
	    	if (cellvalue == "$!{CS_HTML.txt2html($posTcList.CODE_ID)}") {
	    		str += '	<option value="$!{CS_HTML.txt2html($posTcList.CODE_ID)}" selected>$!{CS_HTML.txt2html($posTcList.CODE_NM)}</option>';
	    	}else{
	    		str += '	<option value="$!{CS_HTML.txt2html($posTcList.CODE_ID)}">$!{CS_HTML.txt2html($posTcList.CODE_NM)}</option>';
	    	}
    	}
	#end
        str += '</select>';
        str += '</select>';
    	
    	return str;
    }
    
	/******************************************
     * jqGrid 년차구분
     ******************************************/
    function goYearTcGubun(cellvalue, options, rowObject) {
    	
    	var str = "";
		var ids = "yearTcGubuns";
    	
    	str += '<select id="' + ids + '" name="' + ids + '" class="select w80">';
	#foreach($yearGubunTcList in $yearGubunTcList)
    	if (cellvalue == "$!{CS_HTML.txt2html($yearGubunTcList.CODE_ID)}") {
    		str += '	<option value="$!{CS_HTML.txt2html($yearGubunTcList.CODE_ID)}" selected>$!{CS_HTML.txt2html($yearGubunTcList.CODE_NM)}</option>';
    	}else{
    		str += '	<option value="$!{CS_HTML.txt2html($yearGubunTcList.CODE_ID)}">$!{CS_HTML.txt2html($yearGubunTcList.CODE_NM)}</option>';
    	}
    	
    #end
        str += '</select>';
    	
    	return str;
    }

	/******************************************
     * jqGrid 년차
     ******************************************/
    function goYearTc(cellvalue, options, rowObject) {

		if(options.rowId==""){
			return cellvalue;
		}else{
			var str = '';
			str += '<input type="text" id="yearTcs" name="yearTcs" value="' + cellvalue + '" class="inputbox w20" maxlength="2"/>';

			return str;
		}
    }
    
   	/******************************************
     * jqGrid 적용기준일
     ******************************************/
    function goApplyDt(cellvalue, options, rowObject) {
		var str = '';
		str += '<input type="text" name="applyDts" value="' + cellvalue + '" class="inputbox w80" readonly="readonly" onmouseover="calen();"/>';
    	return str;
    }
	
	/******************************************
	 * 적용기준일 클릭시 달력팝업 이벤트
	 ******************************************/
	 function calen() {
	 	J("input[name='applyDts']").each(function(i){
	 		J("input[name='applyDts']").eq(i).datepicker({
		 		dateFormat: 'yy.mm.dd'
		 	})
	 	})
	}

	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk() {
		if(!J.checkLength("evalGrpNm", "평가그룹명", 1, 100)) {
			return;
		}
		if(!J.checkLength("sortOrder", "정렬순서", 0, 5)) {
			return;
		}
		var ids = J("#list").jqGrid('getDataIDs');
		var rowdata = "";
		var castTcs = "";
		var posTcs = "";
		var yearTcs = "";
		var yearTcGubuns = "";
		var applyDts = "";
		
		for (var i = 0; i < ids.length; i++) {
			rowdata = J("#list").getRowData(ids[i]);
			
			if(J("#form1 select[name=castTcs]").eq(i).val() == "100"){
				alert("직급을 입력하세요.");
				J("#form1 select[name=castTcs]").eq(i).focus();
				return false;
			}
			castTcs += J("#form1 select[name=castTcs]").eq(i).val() + '|';
			posTcs += J("#form1 select[name=posTcs]").eq(i).val() + '|';
			yearTcs += J("#form1 input[name=yearTcs]").eq(i).val() + '|';
			yearTcGubuns += J("#form1 select[name=yearTcGubuns]").eq(i).val() + '|';
			var applyDt = J("input[name='applyDts']").eq(i).val().replace(/[.]/gi, "");
			applyDts += applyDt + '|';
		}

		J("#gCastTcs").val(castTcs);
		J("#gPosTcs").val(posTcs);
		J("#gYearTcs").val(yearTcs);
		J("#gYearTcGubuns").val(yearTcGubuns);
		J("#gApplyDts").val(applyDts);
		
		J.showConfirmBox("저장하시겠습니까?", "saveDo"); //saveDo() 콜백함수 호출
	}
    
	/******************************************
	 * 저장
	 ******************************************/
	function saveDo() {
		J("#form1").attr("action", "$!{context_path}/mem/base/memEvalGroup/memEvalGroupProcess.vw?type=template").submit();
	}

	function addRow() {
		grdRowId++;
		J("#list").jqGrid("addRow", {
				rowID:grdRowId,
				initdata : {
							YEAR_TC:"",
							CAST_TC:"",
							POS_TC:"",
							YEAR_TC_GUBUN:"",
							APPLY_DT:""
							},
				position : "last",
				useDefValues : false,
				useFormmatter : false,
				addRowParams : {extraparam:{}}
		});
		
		J("#list").resetSelection();
	}
	
	function delRow() {
		var rowids = J("#list").jqGrid('getGridParam' , 'selarrrow');
		for (var i = rowids.length -1; i >=0 ; i--) {
			var rowid = rowids[i];
			J("#list").delRowData(rowid);
		}
	}
//]]>
</script>    
 
<form id="form1" name="form1" method="post" action="$!{context_path}/mem/base/memEvalGroup/memEvalGroupProcess.vw?type=template">
    <input type="hidden" 	id="mode"		    name="mode"		      value="$!{searchMap.txt2html("mode")}" />
	<input type="hidden"	id="year"           name="year"           value="$!{searchMap.txt2html("year")}" />
	<input type="hidden"	id="gCastTcs"       name="gCastTcs">
	<input type="hidden"	id="gPosTcs"        name="gPosTcs">
	<input type="hidden"	id="gYearTcs"       name="gYearTcs">
	<input type="hidden"	id="gYearTcGubuns"  name="gYearTcGubuns">
	<input type="hidden"	id="gApplyDts"      name="gApplyDts">
	
    $!{searchMap.makeHiddenFind()}
	
    <div id="Table">
    	<div id="Table_blockContainer">
    		<div class="tableTop">
    			#parse("/WEB-INF/vl/common/template/tabs.vm")
    			<div class="clear"></div>
    		</div>
			<div class="tableTop">
                <!-- 검색 테이블 Start -->
                <div class="searchBox">
                <div><div><div>   
                    <table summary="검색조건">        
                        <caption class="none">검색조건</caption>
                        <thead><tr><th></th><th></th></tr></thead>
                        <tbody>
                            <tr>
								<td class="searchBox_tit w250">기준년도 <span class="searchBar">$!{searchMap.txt2html("findYear")}년</span></td>
							</tr>
                        </tbody>
                    </table>
                </div></div></div>
                </div>
                <!--// 검색 테이블 End -->
                <div class="clear"></div>
            </div>
    		<div class="blockDetail">
    			<table summary="평가그룹 등록">
					<caption class="none">평가그룹 등록</caption>
    				<colgroup>
    					<col width="15%" />
    					<col width="80%" />
    				</colgroup>
    				<tbody>
						<tr>
    						<th scope="row"><label for="evalGrpId">평가그룹코드</label></th>
    						<td>
								#if($!{searchMap.txt2html("mode")} == "MOD")
									$!{CS_HTML.txt2html($detail.EVAL_GRP_ID)}
									<input type="hidden" id="evalGrpId" name="evalGrpId" class="inputbox w100" value="$!{CS_HTML.txt2html($detail.EVAL_GRP_ID)}" maxlength="7" readonly="readonly"/>
								#else
									<input type="hidden" id="evalGrpId" name="evalGrpId" class="inputbox w100" maxlength="7" />
									※ 저장시 자동으로 부여됩니다.
								#end
							</td>
    					</tr>
						<tr>
							<th scope="row"><span class="txt_red">(*)</span> <label for="evalGrpNm">평가그룹명</label></th>
							<td><input type="text" id="evalGrpNm" name="evalGrpNm" class="inputbox w270" value='$!{CS_HTML.txt2html($detail.EVAL_GRP_NM)}' maxlength="40"/></td>
						</tr>
						<tr>
							<th scope="row"><label for="sortOrder">정렬순서</label></th>
							<td><input type="text" id="sortOrder" name="sortOrder" class="inputbox w170" value='$!{CS_HTML.txt2html($detail.SORT_ORDER)}' maxlength="5"/></td>
						</tr>
    				</tbody>
    			</table>
    		</div>
    	</div>
		<div>
			<div id="Table_blockContainer">
				<div>
					<div style="height:25px;text-align:right">
						<a href="javascript:addRow();"><img class="btnSearch" src="$!{img_path}/btn_add2.gif" align="middle" alt="행추가" /></a>
						<a href="javascript:delRow();"><img class="btnSearch" src="$!{img_path}/btn_del2.gif" align="middle" alt="행삭제" /></a>
					</div>
				</div>
			</div>
		</div>
		<div id="Table_blockContainer">
			<div id="splitterBox">
				<div>
					<!-- 데이터그리드 Start -->
					<div class="blockGridListTable">
						<table id="list" summary="평가대상결과">
							<caption class="none">평가대상결과 조회</caption>
							<thead><tr><th></th></tr></thead>
							<tbody><tr><td></td></tr></tbody>
						</table>
						<div id="pager"></div>
					</div>
					<!--// 데이터그리드 End -->
					<div class="blockButton_all">
						<div class="blockButton_l">
							##<input id="btnExcelDown" type="image" src="$!{img_path}/btn_excel.gif" align="middle" alt="엑셀다운로드" />
						</div>
						<div class="blockButton">
							<ul>
			    				<li><input type="button" id="btnBack"   value="돌아가기" /></li>
			    				<li><input type="submit" id="btnInsert" value="저장" /></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="clear"></div>
</form>
