#*************************************************************************
* CLASS 명      : targetMngList
* 작 업 자      : 박경태
* 작 업 일      : 2012년 10월 30일 
* 기    능      : 목표입력
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자     작   업   일       변 경 내 용           비  고
* ----  --------  -----------------  -------------------------  -----------
*  1     박경태      2012년 10월 30일             최 초 작 업
**************************************************************************# 
#set($curr_url = $!{context_path} + "/str/tam/targetMng/targetMngList.vw")
<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;
	
	J(document).ready(function(){
    
		/******************************************
		 * 디폴트 입력 지표 조회
		 ******************************************/
		goAction("$!{searchMap.txt2html("subjectMetricId")}", "direct");
		
		/******************************************
		 * 조회
		 ******************************************/
		J("#formFind").submit(function(event) {
			//submit 하기전 작업추가
		});
		
		
		#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("14") || $CS_LOGIN.chkAuthGrp("60"))
		/******************************************
		 * 평가년도  change 이벤트
		 ******************************************/
		$('#findYear').change(function(){
			chgFindYear();
		});
		#end
        
		/******************************************
		 * 저장버튼 이벤트
		 ******************************************/
		J("#btnInsert").click(function(e) {
			e.preventDefault();
			saveChk();
		});
        
		/******************************************
		 * 삭제 버튼 클릭 이벤트
		 ******************************************/
		J("#btnDelete").click(function() {
			goDelete();
			return false;
		});
		
		/******************************************
		 * 엑셀다운로드 버튼 클릭 이벤트
		 ******************************************/
		J("#btnExcelDown").click(function() {
			excelDownload();
			return false;
		});
		
		/******************************************
		 * fancy Box 팝업호출
		 ******************************************/
		J("#anchor").fancybox();
		
		/******************************************
		 * 반려 버튼 클릭 이벤트
		 ******************************************/
		J("#btnReturn").click(function() {
			#if( "$!{yearClosingYn}" == "Y")
    			J.showMsgBox($!{searchMap.txt2html("findYear")} + " 년은 마감되었습니다.", null, null);
    			return false;
    		#end
			returnPop();
			return false;
		});
		
		/******************************************
		 * 반려조회 버튼 클릭 이벤트
		 ******************************************/
		J("#btnReturnView").click(function() {
			returnPopView();
			return false;
		});
	});
	
	/******************************************
	 * 조회
	 ******************************************/
    function goAction(subjectMetricId, metricNm) {
		var type = "";
		
		if(metricNm != "direct") {
			type = J(metricNm).attr("class").split("^")[0]; // 1:조직, 2:지표
		}
		
		if(type == '1') return; //조직을 선택했을 경우
		
		var year = J("#findYear").val();
		var findActualType = "$!{searchMap.txt2html("findActualType")}";
		
		J("#subjectMetricId").val(subjectMetricId);
		J("#findMetricId").val(subjectMetricId);

		J.ajax({
        	url      : "$!{context_path}/str/tam/targetMng/targetMngDetailList.vw",
        	cache    : false,
        	type     : "POST",
			data     : "year=" + year + "&amp;findYear=" + year + "&amp;subjectMetricId=" + subjectMetricId + "&amp;findActualType=" + findActualType,
        	dataType : "html",
        	contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        	success  : function (data) {
        		J("#detailData").empty();  //body부분 div를 empty 시켜줌(empty를 시키지 않을 경우 메모리릭 발생)   
        		J("#detailData").append(data);
        	}
    	});
	}
	
	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk() {
		
		#if( "$!{yearClosingYn}" == "Y")
			J.showMsgBox($!{searchMap.txt2html("findYear")} + " 년은 마감되었습니다.", null, null);
			return false;
		#end
	
		#if($!{targetInputTermYn} == 'N')
			J.showMsgBox("목표입력 기한이 아닙니다.", null, null);
			return false;
		#end

		var fileChk = true;
		
		//첨부파일 확장자 체크
		J(":file", "#formList").each(function(index, item) {
			var fileFullName = J("input[name=" + item.name + "]").val();
			var src = getFileExtension(fileFullName);
			
			if (!((src.toLowerCase() == "xls") || (src.toLowerCase() == "xlsx") || (src.toLowerCase() == "ppt") || (src.toLowerCase() == "pptx")||
				  (src.toLowerCase() == "doc") || (src.toLowerCase() == "docx") || (src.toLowerCase() == "hwp") || (src.toLowerCase() == "pdf") ||
				  (src.toLowerCase() == "zip") || (src.toLowerCase() == "txt")  || (src.toLowerCase() == "gif") || (src.toLowerCase() == "jpg") ||
			      (src.toLowerCase() == "png") || (src.toLowerCase() == "png")
			    )) {
			
				fileChk = false;
    		}
		});
		
		if(fileChk == false) {
			J.showMsgBox("허용되지 않는 파일형식입니다<br/>허용되는 파일형식 : <br/>xls, xlsx, ppt, pptx, doc, docx, hwp <br/> pdf, zip, txt, gif, jpg, png, jpeg", null, null);
    		return;
		}
	
		var actualType 		= J("#findActualType").val();
		var targetStatusId 	= J("#targetStatusId").val();
		
		if(targetStatusId == "03") {
			J.showMsgBox("승인요청중인 지표는 수정이 불가능합니다", null, null);
			return;
		} else if(targetStatusId == "04") {
			J.showMsgBox("승인완료된 지표는 수정이 불가능합니다", null, null);
			return;
		} else {
			var target = J("input[name=colValues]:enabled", "#blockDetailTB");
			var targetChk = true;
			
			for (var i = 0; i < target.length; i++) {
				if(target.eq(i).val()==""){
					targetChk=false;
				}
			}
			
			if(targetChk){
				J.showConfirmBox("저장하시겠습니까?", "saveDo"); //saveDo() 콜백함수 호출
			}else{
				J.showMsgBox("목표값을 모두 입력해주세요", null, null);
				return;
			}
		}
	}
	
	
	/******************************************
	 * 평가년도 변경 시 입력/승인 담당자 변경 (AJAX)
	 ******************************************/
	function chgFindYear(){
	
		
		// 입력담당자 변경
		#if($!{searchMap.txt2html("findActualType")} == "input")
		
		J.ajax({
        	url      : "$!{context_path}/str/tam/targetMng/insertUserList_ajax.vw",﻿
        	cache    : false,
        	type     : "POST",
			data     : J("#formFind").serialize(),
        	dataType : "html",
        	contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        	success  : function (data) {
				var xmlDoc = J.parseXML(data);
				J("#findInsertUserId").empty();
				J(xmlDoc).find("data").each(function() {
					J('<option/>').attr('value', J(this).find("value").text()).text(J(this).find("text").text()).appendTo('#findInsertUserId');
				})
        	}
    	});
		
		// 승인담당자 변경
		#else
		
		J.ajax({
        	url      : "$!{context_path}/str/tam/targetMng/approveUserList_ajax.vw",﻿
        	cache    : false,
        	type     : "POST",
			data     : J("#formFind").serialize(),
        	dataType : "html",
        	contentType: "application/x-www-form-urlencoded; charset=UTF-8",
        	success  : function (data) {
				var xmlDoc = J.parseXML(data);
				J("#findApproveUserId").empty();
				J(xmlDoc).find("data").each(function() {
					J('<option/>').attr('value', J(this).find("value").text()).text(J(this).find("text").text()).appendTo('#findApproveUserId');
				})
        	}
    	});
		
		
		#end
		
	}
	
	/******************************************
	 * 저장
	 ******************************************/
	function saveDo() {
		J("#year").val(J("#findYear").val());
		J("#mode").val("ADD");
		J("#targetStatusId").val("02");
		J("input[type=text]", "#blockDetailTB").attr("disabled", false);
		
		document.charset='utf-8';
		
		J("#formList").attr("action", "$!{context_path}/str/tam/targetMng/targetMngProcess.vw?type=template").submit(); 
	}

	/******************************************
	 * jqGrid 수정페이지 링크
	 ******************************************/
	function linkUpdate(cellvalue, options, rowObject) { 
		return '<a href=javascript:goModify(' + options.rowId + ')>' + cellvalue + '<//a>';
	}
	
	/******************************************
	 * 수정
	 ******************************************/
	function goModify(rowId) {
		var ret = J("#list").jqGrid('getRowData',rowId);
		J("#mon").val(ret.MON);
		J("#subjectMetricId").val(ret.SUBJECT_METRIC_ID);
		J("#year").val(J("#findYear").val());
		J("#mode").val("MOD");
		J("#formList").attr("action", "$!{context_path}/str/tam/targetMng/targetMngModify.vw?type=template").submit();
	}
    
	/******************************************
	 * 삭제
	 ******************************************/
	function goDelete() {
		if(!J.gridSelectChk("list")){
			J.showMsgBox("삭제할 데이터를 선택하십시요", null, null); 
		} else {
			J.showConfirmBox("삭제하시겠습니까?", "deleteDo"); //deleteDo() 콜백함수 호출
		}
	}
    
	/******************************************
	 * 삭제처리
	 ******************************************/
	function deleteDo() {
		var id = J("#list").getGridParam('selarrrow');
		var ids = J("#list").jqGrid('getDataIDs');
		var rowdata = "";
		var mons = "";
		var subjectMetricIds = "";
        
		for (var i = 0; i < ids.length; i++) {
			J.each(id, function (index, value) {
				if (value == ids[i]) {
					rowdata = J("#list").getRowData(ids[i]);
					mons += rowdata.MON + '|';subjectMetricIds += rowdata.SUBJECT_METRIC_ID + '|';
				}
			});
		}
        
		J("#mons").val(mons);J("#subjectMetricIds").val(subjectMetricIds);
		J("#mode").val("DEL");
		J("#year").val(J("#findYear").val());
		J("#formList").attr("action", "$!{context_path}/str/tam/targetMng/targetMngProcess.vw?type=template").submit();
		return false;
	}
	
	/******************************************
	 * 엑셀다운로드
	 ******************************************/
	function excelDownload(){
		J("#formList").attr("action", "$!{context_path}/str/tam/targetMng/targetMngListExcel.vw?type=excel").submit();
		return false;
	}
	
	/******************************************
	 * 반려조회 버튼
	 ******************************************/
	function showReturnView() {
		var targetStatusId = J("#targetStatusId").val(); 
		
		if(targetStatusId == "05") {
			J("#btnReturnView").show();
		} else {
			J("#btnReturnView").hide();
		}
	}
	
	/******************************************
	 * 승인상태 저장
	 ******************************************/
	function goStatus(targetStatusId) {
		
		if( "$!{yearClosingYn}" == "Y" ){
			J.showMsgBox($!{searchMap.txt2html("findYear")} + " 년은 마감되었습니다.", null, null);
			return ;
		}
	
		if(!saveStatusChk()) return;
		J("#targetStatusId").val(targetStatusId);
		
		if(targetStatusId=="04"){
			J.showConfirmBox("승인하시겠습니까?", "statusDo"); //statusDo() 콜백함수 호출
		}else{
			J.showConfirmBox("승인요청하시겠습니까?", "statusDo"); //statusDo() 콜백함수 호출
		}
		
	}
	
	/******************************************
	 * 승인상태 저장
	 ******************************************/
	function statusDo() {
		J("#year").val(J("#findYear").val());
		J("#mode").val("STATUS");
		
		var tree = $("#tree").dynatree("getTree");
		var selectNode = tree.serializeSubjectMetricString();
		
		J("#subjectMetricIds").val(selectNode);
		J("#formList").attr("action", "$!{context_path}/str/tam/targetMng/targetMngProcess.vw?type=template").submit(); 
	}
	
	/******************************************
	 * 승인상태 저장
	 ******************************************/
	function statusBanDo(targetStatusId) {
		J("#year").val(J("#findYear").val());
		J("#mode").val("STATUS");
		
		var tree = $("#tree").dynatree("getTree");
		var selectNode = tree.serializeSubjectMetricString();
		
		J("#targetStatusId").val(targetStatusId);
		
		J("#subjectMetricIds").val(selectNode);
		J("#formList").attr("action", "$!{context_path}/str/tam/targetMng/targetMngProcess.vw?type=template").submit(); 
	}
	
	/******************************************
	 * 승인 및 반려 체크
	 ******************************************/
	function saveStatusChk() {
		var tree = J("#tree").dynatree("getTree");
		var selectNode = tree.serializeSubjectMetricString();
		
		#if($!{targetInputTermYn} == 'N')
			J.showMsgBox("목표입력 기한이 아닙니다.", null, null);
			return false;
		#end
		
		if("" == selectNode) {
			J.showMsgBox("선택된 지표가 없습니다.", null, null);
			return false;
		}
		
		return true;
	}
	
	/******************************************
	 * 반려조회 팝업호출
	 ******************************************/
	function returnPopView() {
		var year = J("#findYear").val(); 
		var mon = J("#findMon").val();
		var subjectMetricId = J("#subjectMetricId").val();
		
		J("#anchor").attr("href","$!{context_path}/str/tam/targetMng/popReturnView.vw?year="+ year + "&amp;subjectMetricId=" + subjectMetricId);
		J("#anchor").click();
		return false;
	}
	
	/******************************************
	 * 반려 입력 팝업호출
	 ******************************************/
	function returnPop() {
		if(!saveStatusChk()) return;
		
		J("#anchor").attr("href","$!{context_path}/str/tam/targetMng/popReturnActual.vw?findYear=$!{searchMap.txt2html("year")}");
		J("#anchor").click();
	}
	
//]]>
</script>

<div id="Table">
	<div id="Table_blockContainer">
		<h1 class="none">목표입력</h1>
		<div class="tableTop">
			#parse("/WEB-INF/vl/common/template/tabs.vm")
			
    		<!-- search S -->
			<form id="formFind" name="formFind" method="post" action="$!{context_path}/str/tam/targetMng/targetMngList.vw?type=template">
				<input type="hidden"	id="findHighPgmId"			name="findHighPgmId"			value="$!{searchMap.txt2html("findHighPgmId")}" />
				<input type="hidden" 	id="findSubPgmId"			name="findSubPgmId"				value="$!{searchMap.txt2html("findSubPgmId")}" />
				<input type="hidden"    id="findPgmId"				name="findPgmId"				value="$!{searchMap.txt2html("findPgmId")}" />
				<input type="hidden"    id="findActualType"			name="findActualType"			value="$!{searchMap.txt2html("findActualType")}" />
				
				<div class="searchBox">
    				<div><div><div>
    				<table summary="목표입력검색 조건">
						<caption class="none">목표입력 검색 조건</caption> 
						<thead><tr><th></th></tr></thead>
        				<tbody>
            				<tr>
								<td class="searchBox_tit w200">
            						<span><label for="findYear">$!{YEAR}</label></span>
            						<span class="searchBar">
            							<select id="findYear" name="findYear" class="select w80">
            								$!CS_CODE.getCodeOption("017", $!{searchMap.txt2html("findYear")})
            							</select>
            						</span>
            					</td>
								<td class="searchBox_tit w200">
            						<span>처리상태</span>
            						<span class="searchBar">
            							<select id="findTargetStatusId" name="findTargetStatusId" class="select w80">
											<option value="">전체</option>
            								$!CS_CODE.getCodeOption("015", $!{searchMap.txt2html("findTargetStatusId")})
            							</select>
            						</span>
            					</td>
								<td class="searchBox_tit w350">
									#if($!{searchMap.txt2html("findActualType")} == "input")
										<span>입력담당자</span>
										<span class="searchBar">
										#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("14") || $CS_LOGIN.chkAuthGrp("60"))
                							<select id="findInsertUserId" name="findInsertUserId" class="select w80">
                								#foreach($insertUserList in $insertUserList)
    												<option value="$!{CS_HTML.txt2html($insertUserList.CHARGE_USER_ID)}" $searchMap.getSelected("findInsertUserId", "$!{CS_HTML.txt2html($insertUserList.CHARGE_USER_ID)}")>$!{CS_HTML.txt2html($insertUserList.CHARGE_USER_NM)}</option>
    											#end
                							</select>
										#else 
											$!{CS_LOGIN.getUser_nm()}
											<input type="hidden" id="findInsertUserId" name="findInsertUserId" value="$!{CS_LOGIN.getUser_id()}" />
										#end
										</span>
									#else
										<span>승인담당자</span>
                						<span class="searchBar">
    										#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("14") || $CS_LOGIN.chkAuthGrp("60"))
                    							<select id="findApproveUserId" name="findApproveUserId" class="select w80">
                    								#foreach($approveUserList in $approveUserList)
        												<option value="$!{CS_HTML.txt2html($approveUserList.APPROVE_USER_ID)}" $searchMap.getSelected("findApproveUserId", "$!{CS_HTML.txt2html($approveUserList.APPROVE_USER_ID)}")>$!{CS_HTML.txt2html($approveUserList.APPROVE_USER_NM)}</option>
        											#end
                    							</select>
    										#else 
    											$!{CS_LOGIN.getUser_nm()}
    											<input type="hidden" id="findApproveUserId" name="findApproveUserId" value="$!{CS_LOGIN.getUser_id()}" />
    										#end
                						</span>
									#end	
            					</td>
            				</tr>
        				</tbody>
    				</table>
                    <input type="image" class="btnSearch" src="$!{img_path}/common/btn_search.gif" align="middle" alt="검색" /> 
                    </div></div></div>
    	        </div>
    		</form>
    		<!-- search E -->
			<div class="clear"></div>
		</div>
		
		<form id="formList" name="formList" method="post" enctype="multipart/form-data" action="$!{context_path}/str/tam/targetMng/targetMngProcess.vw?type=template">
			<input type="hidden" id="mode"       		name="mode" />
			<input type="hidden" id="year"		 		name="year" />
			<input type="hidden" id="subjectMetricIds" 	name="subjectMetricIds" /> 
			<input type="hidden" id="subjectMetricId"  	name="subjectMetricId" />
			<input type="hidden" id="targetStatusId"	name="targetStatusId" />
			<input type="hidden" id="cycleId"			name="cycleId" />
			<input type="hidden" id="returnReason"		name="returnReason" />
			
			$!{searchMap.makeHiddenFind()}
			<div id="splitterBox">
				<div>
					<table width="100%" border="0" cellspacing="0" cellpadding="0" summary="목표입력">
						<tr>
							<td class="valign_top blockSearch textRight">
								#if($!{searchMap.txt2html("findActualType")} == "input")
									<a href="javascript:goStatus('03');"><img src="$!{img_path}/common/bt_01.gif" alt="승인요청" class="btn02" /></a>
								#else
									<a href="javascript:goStatus('04');"><img src="$!{img_path}/common/bt_02.gif" alt="승인" class="btn02" /></a>
									<input id="btnReturn" type="image" src="$!{img_path}/common/bt_03.gif"  alt="반려" class="btn02" />
								#end
								<!-- 조직트리 Start -->
                				<div class="blockGridTreeTable floatLeft" style="margin-top:10px;">
                					#parse("/WEB-INF/vl/str/tam/targetMng/targetTree.vm") 
                				</div>
								
								<!-- 범례 Start -->
                				<div class="blockLegendTable floatLeft" style="margin-top:10px;">
									<ul>
										<li class="strong">[목표승인상태 범례]</li>
										<li>&nbsp;(미) : 미입력</li>
										<li>&nbsp;(입) : 입력완료</li>
    									<li>&nbsp;(요) : 승인요청</li>
    									<li>&nbsp;(승) : 승인완료</li>
    									<li>&nbsp;(반) : 반려</li>
									</ul>
                				</div>
            				</td>
							<td>&nbsp;&nbsp;</td>
							<td class="textRight valign_top">
            					<!-- 실적입력 Start -->
            					<div id="detailData" class="blockDetailForTree"></div>
							</td>
						</tr>
					</table>
					<div class="blockButton_all floatLeft">
						<div class="blockButton_l">
							#if($!{targetInputTermYn} == 'N')
								<span id="closeAlert" class="txt_red2">※목표입력 기한이 아닙니다.</span><br/>
							#end
						</div>
						#if($!{searchMap.txt2html("findActualType")} == "input")
						<div class="blockButton">
							<ul>
								<li><input type="button" id="btnReturnView" value="반려조회" class="none" /></li>
								<li><input type="submit" id="btnInsert" value="저장" /></li>
							</ul>
						</div>
						#end
					</div>
				</div>
			</div>
		</form>
		
	</div>
	<a id="anchor"></a>
	<div class="clear"></div>
</div>
