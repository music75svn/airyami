<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bsc.base.activity">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: Activity관리 계획 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getPlans" parameterClass="hashMap" resultClass="hashMap">
	
           
	</select>

	<!--
	==================================================================   
	  # 설명	: Activity관리 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
           SELECT T1.YEAR, 
                T1.METRIC_ID, 
                T1.METRIC_NM, 
                T2.SC_DEPT_ID,
                T2.SC_DEPT_NM,            
                T3.STRATEGY_ID,
                T3.STRATEGY_NM,                        
                T1.EVAL_CYCLE,
                F_CODE_NM('008', T1.EVAL_CYCLE, T1.YEAR) AS EVAL_CYCLE_NM,  
                CASE WHEN T1.TYPE_ID='01' THEN TO_CHAR(T5.TGT_VALUE) ELSE T1.TARGETY_TXT END TARGET_Y,
                T1.WEIGHT,             
                CASE WHEN T4.PLAN_CNT IS NULL THEN 0 ELSE T4.PLAN_CNT END PLAN_CNT                 
           FROM BSC_METRIC T1
           INNER JOIN BSC_SC_DEPT T2
                ON T1.YEAR=T2.YEAR
                AND T1.SC_DEPT_ID=T2.SC_DEPT_ID
                AND T2.DELETE_DT IS NULL
           INNER JOIN BSC_STRATEGY T3
                ON T1.YEAR=T3.YEAR
                AND T1.STRATEGY_ID=T3.STRATEGY_ID
                AND T3.DELETE_DT IS NULL           
           LEFT OUTER JOIN  (SELECT YEAR, METRIC_ID, COUNT(*) AS PLAN_CNT FROM BSC_INITIATIVE WHERE YEAR = #findYear# AND PLAN_START_DT IS NOT NULL AND DELETE_DT IS NULL GROUP BY YEAR, METRIC_ID) T4
                ON T1.YEAR=T4.YEAR 
                AND T1.METRIC_ID = T4.METRIC_ID
           LEFT OUTER JOIN  BSC_TARGET T5
                ON T1.YEAR=T5.YEAR 
                AND T1.METRIC_ID = T5.METRIC_ID
                AND T5.MON='12'
                AND T5.ANAL_CYCLE='Y'                          
           WHERE T1.YEAR = #findYear#
               AND T1.SC_DEPT_ID = #findScDeptId#
               AND T1.DELETE_DT IS NULL
               <dynamic prepend="AND">
               		<isNotEmpty property="bscMetricGbn">
               			T1.BSC_METRIC_GBN = #bscMetricGbn#
               		</isNotEmpty>
               </dynamic>                                        
           ORDER BY T2.SORT_ORDER, T3.SORT_ORDER, T1.SORT_ORDER
           
	</select>
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 상세 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getDetailList" parameterClass="hashMap" resultClass="hashMap">
 		SELECT YEAR, 
 			   METRIC_ID, 
 			   INITIATIVE_ID, 
 			   UP_INITIATIVE_ID, 
 			   UP_INITIATIVE_ID || INITIATIVE_ID SORT_ORDER, 
 			   INITIATIVE_NM,
 			   PLAN_START_DT, 
 			   PLAN_START_DT2, 
 			   PLAN_START_DT3, 
 			   PLAN_START_DT4, 
 			   PLAN_START_DT5, 
 			   PLAN_START_DT6,                                                 
               PLAN_END_DT, 
               PLAN_END_DT2, 
               PLAN_END_DT3, 
               PLAN_END_DT4, 
               PLAN_END_DT5, 
               PLAN_END_DT6,                                                     
               PLAN_DESC, 
               DECODE(STATUS_ID,'01','기본','추가') AS STATUS_NM, 
               PRODUCT
        FROM BSC_INITIATIVE A                                                
        WHERE YEAR = #year# 
        	AND METRIC_ID = #metricId#
        	AND PLAN_START_DT IS NOT NULL                                        
          	AND DELETE_DT IS  NULL                                            
          	ORDER BY SORT_ORDER                                               			                       
	</select>
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR, 
			   METRIC_ID, 
			   INITIATIVE_ID, 
			   UP_INITIATIVE_ID, 
			   UP_INITIATIVE_ID || INITIATIVE_ID SORT_ORDER, 
			   INITIATIVE_NM,
			   PLAN_START_DT, 
			   PLAN_START_DT2, 
			   PLAN_START_DT3, 
			   PLAN_START_DT4, 
			   PLAN_START_DT5, 
			   PLAN_START_DT6,                                                 
			   PLAN_END_DT, 
	           PLAN_END_DT2, 
	           PLAN_END_DT3, 
	           PLAN_END_DT4, 
	           PLAN_END_DT5, 
	           PLAN_END_DT6,                                                     
	           PLAN_DESC, 
	           PRODUCT
	    FROM BSC_INITIATIVE A                                                
	    WHERE YEAR = #year# 
	    	AND METRIC_ID = #metricId#   
	    	AND INITIATIVE_ID = #initiativeId#    
	        AND PLAN_START_DT IS NOT NULL                                        
	        AND DELETE_DT IS  NULL                                                                                           			                       
	</select>
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 특정 지표의 이니셔트브 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: 
	==================================================================
	-->
	<select id="getInitList" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR, 
			   INITIATIVE_ID, 
			   INITIATIVE_NM
	    FROM BSC_INITIATIVE A                                                
	    WHERE YEAR = #year# 
	    	AND METRIC_ID = #metricId#   
	        AND PLAN_START_DT IS NOT NULL
       		<dynamic>
       			<isNotEmpty property="initiativeId" prepend="AND">
       				INITIATIVE_ID != #initiativeId#
       			</isNotEmpty>
       			<isNotEmpty property="initiativeId" prepend="AND">
		       		INITIATIVE_ID NOT IN
		       		(SELECT INITIATIVE_ID FROM BSC_INITIATIVE WHERE YEAR=A.YEAR AND METRIC_ID=A.METRIC_ID AND DELETE_DT IS NULL AND UP_INITIATIVE_ID = #initiativeId#)
           		</isNotEmpty>
           </dynamic>                                        
	        AND DELETE_DT IS  NULL                                                                                           			                       
	</select>
	
	<!--
	==================================================================   
	  # 설명	: Activity ID 채번
	  #	기능	: SELECT
	  #	TABLE	: BSC_CODE
	==================================================================
	-->
	<select id="getActivityId" parameterClass="hashMap" resultClass="java.lang.String">
		SELECT F_PGM_SERI('BSC_INITIATIVE', #year#, #metricId#,'','','') SEQ FROM DUAL
	</select>
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 등록
	  #	기능	: INSERT
	  #	TABLE	: 
	==================================================================
	-->	
	<insert id="insertData" parameterClass="hashMap">
		INSERT INTO BSC_INITIATIVE
			(YEAR, INITIATIVE_ID, UP_INITIATIVE_ID, METRIC_ID, INITIATIVE_NM,
			PLAN_START_DT, PLAN_END_DT,                           
			PLAN_START_DT2, PLAN_END_DT2,                                
            PLAN_START_DT3, PLAN_END_DT3,                                
            PLAN_START_DT4, PLAN_END_DT4,                                
            PLAN_START_DT5, PLAN_END_DT5,                                
            PLAN_START_DT6, PLAN_END_DT6,                                
            PLAN_DESC, CHARGE_DEPT_ID, INSERT_USER_ID,                            
            CREATE_DT, STATUS_ID, PRODUCT)                        
       VALUES 
       		(#year#, #initiativeId#, #upInitiativeId#, #metricId#, #initiativeNm#,
       		 #planStartDt#, #planEndDt#,
       		 #planStartDt2#, #planEndDt2#,
       		 #planStartDt3#, #planEndDt3#,
       		 #planStartDt4#, #planEndDt4#, 
       		 #planStartDt5#, #planEndDt5#, 
       		 #planStartDt6#, #planEndDt6#,
       		 #planDesc#, #scDeptId#, #insertUserId#,
       		 SYSDATE, #statusId#,#product#)                        
	</insert>	
	
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 ACTIVITY 승인상태 가져오기
	  #	기능	: INSERT
	  #	TABLE	: 
	==================================================================
	-->	
	<select id="getActivityStatus" resultClass="java.lang.String">
        SELECT  DECODE(T2.APPROVE_STATUS_ID ,'04','02','05','02','01')  
        AS METRIC_STATUS_ID FROM BSC_METRIC T1 
        LEFT OUTER JOIN BSC_KPI_APPROVE T2
            ON T1.YEAR=T2.YEAR
            AND T1.SC_DEPT_ID=T2.SC_DEPT_ID
            AND T2.DELETE_DT IS NULL
        WHERE T1.YEAR = #year# 
	        AND T1.METRIC_ID = #metricId# 								
	</select>	
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 수정
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE BSC_INITIATIVE
		SET    INITIATIVE_NM 	= #initiativeNm#,
		       UP_INITIATIVE_ID = #upInitiativeId#,
		       PLAN_START_DT    = #planStartDt#,
		       PLAN_START_DT2   = #planStartDt2#,
		       PLAN_START_DT3   = #planStartDt3#,
		       PLAN_START_DT4   = #planStartDt4#,
		       PLAN_START_DT5   = #planStartDt5#,
		       PLAN_START_DT6   = #planStartDt6#,
		       PLAN_END_DT      = #planEndDt#,
		       PLAN_END_DT2     = #planEndDt2#,
		       PLAN_END_DT3     = #planEndDt3#,
		       PLAN_END_DT4     = #planEndDt4#,
		       PLAN_END_DT5     = #planEndDt5#,
		       PLAN_END_DT6     = #planEndDt6#,
		       PLAN_DESC        = #planDesc#,
		       CHARGE_DEPT_ID   = #scDeptId#,
		       PRODUCT          = #product#,
		       UPDATE_DT        = SYSDATE
		WHERE  YEAR             = #year#
		AND    INITIATIVE_ID    = #initiativeId#
		AND    METRIC_ID        = #metricId#
		
	</update>	

	<!--
	==================================================================   
	  # 설명	: Activity관리 삭제
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">
		DELETE BSC_INITIATIVE
		WHERE YEAR=#year#
		AND METRIC_ID=#metricId#
		AND INITIATIVE_ID=#initiativeId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: Activity 첨부파일 등록
	  #	기능	: INSERT
	  #	TABLE	: BSC_INITIATIVE_PLAN_ATTACH
	==================================================================
	-->	
	<insert id="insertFileInfo" parameterClass="hashMap">
		<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
			SELECT F_PGM_SERI('BSC_INITIATIVE_PLAN_ATTACH', #year#, #initiativeId#, #metricId#,'','') SEQ FROM DUAL
		</selectKey> 
		INSERT INTO BSC_INITIATIVE_PLAN_ATTACH (
               YEAR
             , INITIATIVE_ID
             , METRIC_ID
             , SEQ
             , ATTACH_FILE_NM
             , ATTACH_FILE_FNM
             , ATTACH_FILE_SUFFIX
             , ATTACH_FILE_PATH
             , CREATE_DT
           ) VALUES (
               #year#
             , #initiativeId#
             , #metricId#
             , #SEQ#
             , #attachFileNm#
             , #attachFileFnm#
             , #attachFileSufix#
             , #attachFilePath#
             , SYSDATE
    	   )       
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: Activity 첨부파일 삭제
	  #	기능	: INSERT
	  #	TABLE	: BSC_INITIATIVE_PLAN_ATTACH
	==================================================================
	-->	
	<delete id="deleteFileInfo" parameterClass="hashMap">
		DELETE FROM BSC_INITIATIVE_PLAN_ATTACH
		 WHERE YEAR = #year#
		   AND METRIC_ID = #metricId#
		   AND INITIATIVE_ID = #initiativeId#
		   AND SEQ = #seq#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: Activity관리 상세 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_INITIATIVE_PLAN_ATTACH
	==================================================================
	-->
	<select id="getFileList" parameterClass="hashMap" resultClass="hashMap">
 		SELECT A.YEAR
	         , A.INITIATIVE_ID
	         , A.METRIC_ID
	         , A.SEQ
	         , A.ATTACH_FILE_NM
	         , A.ATTACH_FILE_FNM
	         , A.ATTACH_FILE_SUFFIX
	         , F_ENCRYPT(A.ATTACH_FILE_PATH, #encryptionCode#) ATTACH_FILE_PATH 
         FROM BSC_INITIATIVE_PLAN_ATTACH A
        WHERE A.YEAR = #year#
          AND A.INITIATIVE_ID = #initiativeId#
          AND A.METRIC_ID = #metricId#
        ORDER BY A.SEQ                                            			                       
	</select>
	
	
</sqlMap>


