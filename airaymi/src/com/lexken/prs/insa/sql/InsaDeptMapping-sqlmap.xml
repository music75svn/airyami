<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.insa.insaDeptMapping">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	
	<!--
	==================================================================   
	  # 설명	: 최상위 평가조직 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getTopDeptInfo" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR, DEPT_CD, DEPT_KOR_NM
	  	  FROM (  SELECT YEAR, DEPT_CD, DEPT_KOR_NM
	            	FROM BSC_INSA_DEPT
	           	   WHERE YEAR = #findYear#
	           		 AND USE_YN != 'F'
	        ORDER BY DISP_ORDER, DEPT_CD)
	 	  WHERE DEPT_CD = '0000'
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직매핑관리 인사조직 트리 조회(사용)
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getInsaDeptMappingTreeList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_CD AS CODE_ID
             , A.UP_DEPT_CD AS UP_CODE_ID
             , DEPT_LEVL AS LEVEL_ID
             , CASE
				  WHEN B.DEPT_NMS IS NULL THEN A.DEPT_KOR_NM
				  ELSE A.DEPT_KOR_NM || '(' || B.DEPT_NMS || ')'
			    END AS CODE_NM
			 , DECODE (B.DEPT_NMS, '', 'mappingTree_txt_red', 'mappingTree_txt_black') AS PARAM
		  FROM BSC_INSA_DEPT A
	LEFT OUTER JOIN
				( SELECT  YEAR
						, DEPT_CD
						, LTRIM ( (SYS_CONNECT_BY_PATH (DEPT_KOR_NM, ',')), ',') DEPT_NMS
					FROM (SELECT  YEAR
								, DEPT_CD
								, DEPT_KOR_NM
								, ROW_NUMBER ()
							OVER (PARTITION BY YEAR, DEPT_CD ORDER BY DEPT_KOR_NM) RN
							FROM (SELECT A.YEAR, A.DEPT_CD, B.DEPT_KOR_NM
									FROM    BSC_INSA_DEPT_MAPPING A
							  INNER JOIN BSC_INSA_DEPT B 
							  		  ON A.DEPT_CD = B.DEPT_CD))
			  				  START WITH RN = 1
						CONNECT BY PRIOR YEAR = YEAR
					 				 AND PRIOR DEPT_CD = DEPT_CD
					 				 AND PRIOR RN = RN - 1
				GROUP BY YEAR, DEPT_CD, DEPT_KOR_NM) B
				 ON A.YEAR = B.YEAR
				AND A.DEPT_CD = B.DEPT_CD
		 WHERE A.YEAR = #findYear#
		   AND A.USE_YN = 'T'
	START WITH A.UP_DEPT_CD IS NULL
	CONNECT BY PRIOR A.DEPT_CD = A.UP_DEPT_CD
		   AND PRIOR A.YEAR = A.YEAR
ORDER SIBLINGS BY A.DISP_ORDER, A.DEPT_CD
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직매핑관리 인사조직 트리 조회(미사용)
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getDeptMappingTreeList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_CD AS CODE_ID
			 , A.UP_DEPT_CD AS UP_CODE_ID
			 , DEPT_LEVL AS LEVEL_ID
			 , CASE
				  WHEN B.SC_DEPT_NMS IS NULL THEN A.DEPT_KOR_NM
                  ELSE A.DEPT_KOR_NM || '(' || B.SC_DEPT_NMS || ')'
				END AS CODE_NM
		  FROM (SELECT * FROM BSC_INSA_DEPT
		  		 WHERE YEAR = #findYear# ) A
	LEFT OUTER JOIN
			 ( SELECT YEAR
					, DEPT_CD
					, LTRIM ( (SYS_CONNECT_BY_PATH (DEPT_KOR_NM, ',')), ',') SC_DEPT_NMS
				 FROM (SELECT YEAR
							, DEPT_CD
							, DEPT_KOR_NM
							, ROW_NUMBER () OVER (PARTITION BY YEAR, DEPT_CD ORDER BY DEPT_KOR_NM) RN
						 FROM (SELECT A.YEAR, A.DEPT_CD, B.DEPT_KOR_NM
								 FROM BSC_INSA_DEPT_MAPPING A
									INNER JOIN BSC_INSA_DEPT B
											ON A.YEAR = B.YEAR
										   AND A.DEPT_CD = B.DEPT_CD
								WHERE A.YEAR = #findYear#))
						   START WITH RN = 1
					 CONNECT BY PRIOR YEAR = YEAR
								  AND PRIOR DEPT_CD = DEPT_CD
								  AND PRIOR RN = RN - 1
							 GROUP BY YEAR, DEPT_CD, DEPT_KOR_NM) B
								   ON A.DEPT_CD = B.DEPT_CD
								  AND A.DEPT_CD = B.DEPT_CD
		   START WITH A.UP_DEPT_CD = '0000'
	 CONNECT BY PRIOR A.DEPT_CD = A.UP_DEPT_CD
ORDER SIBLINGS BY A.DISP_ORDER, A.DEPT_CD
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직기준 매핑 등록, 단 Tree 사용을 위해 실조직코드앞에 임의로 A를 붙인 것 제거하여 insert 함.
	  #	기능	: INSERT
	  #	TABLE	: 
	==================================================================
	-->	
	<insert id="insertScDeptMappingData" parameterClass="hashMap">
		INSERT INTO BSC_INSA_DEPT_MAPPING
		     VALUES (#findYear#, #scDeptMappingId#, #findInsaDeptId#, SYSDATE)
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직에 매핑된 실조직 리스트 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT_MAPPING
	==================================================================
	-->
	<select id="selectDeptMappingData" parameterClass="hashMap" resultClass="java.lang.Integer">
		SELECT COUNT(*) CNT
		  FROM BSC_INSA_DEPT_MAPPING
		 WHERE YEAR = #findYear#
		   AND DEPT_CD = #scDeptMappingId#
	</select>
	
		
	<!--
	==================================================================   
	  # 설명	: 선택한 성과조직의  모든 매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: 
	==================================================================
	-->	
	<delete id="deleteScDeptMappingData" parameterClass="hashMap">
		DELETE BSC_INSA_DEPT_MAPPING
	     WHERE YEAR = #findYear#
	       AND SC_DEPT_CD = #findInsaDeptId#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 성과조직에 매핑된 실조직 리스트 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT_MAPPING
	==================================================================
	-->
	<select id="getMappingDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT DEPT_CD
          FROM BSC_INSA_DEPT_MAPPING
         WHERE YEAR = #findYear#
           AND SC_DEPT_CD = #findInsaDeptId#
      ORDER BY DEPT_CD
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 실조직에 매핑된 성과조직 리스트 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT_MAPPING
	==================================================================
	-->
	<select id="getMappingScDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT DEPT_CD
		  FROM BSC_INSA_DEPT_MAPPING
		 WHERE YEAR = #findYear#
		   AND DEPT_CD = #findInsaDeptId#
	  ORDER BY DEPT_CD
	</select>
	
</sqlMap>