<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.insa.dept">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 최상위 평가조직 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getTopDeptInfo" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
				, DEPT_CD
       			, DEPT_KOR_NM
    	  FROM ( SELECT YEAR, DEPT_CD, DEPT_KOR_NM FROM BSC_INSA_DEPT WHERE YEAR = #findYear# ORDER BY DISP_ORDER, DEPT_CD )
		  WHERE DEPT_CD = '0000'
	</select>
	
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 왼쪽트리목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_CD
			 , A.DEPT_KOR_NM
			 , A.UP_DEPT_CD
			 , DEPT_LEVL 
		  FROM (SELECT T.*
					 , NVL ( (  SELECT COUNT (1)
								  FROM BSC_INSA_DEPT
								 WHERE YEAR = T.YEAR
								   AND UP_DEPT_CD = T.DEPT_CD
							  GROUP BY YEAR, UP_DEPT_CD), '0') AS CNT
				  FROM BSC_INSA_DEPT T) A
		 WHERE A.YEAR = #findYear#
	START WITH A.UP_DEPT_CD IS NULL
CONNECT BY PRIOR A.DEPT_CD = A.UP_DEPT_CD
	   AND PRIOR A.YEAR = A.YEAR
ORDER SIBLINGS BY DISP_ORDER       
		 
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 오른쪽목록보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getListData" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_CD
			 , A.DEPT_KOR_NM
			 , A.UP_DEPT_CD
			 , A.UP_USER_ID
			 , A.DEPT_LEVL
			 , A.USE_YN
			 , A.DISP_ORDER
			 , (SELECT DEPT_KOR_NM
				  FROM BSC_INSA_DEPT
				 WHERE A.YEAR = YEAR
				   AND DEPT_CD = A.UP_DEPT_CD) UP_DEPT_NAME
			 , DECODE (A.USE_YN,  'T', 'Y',  'F', 'N',  '') USE_YN
			 , A.DEPT_LEVL
			 , A.DISP_ORDER
			 , NVL((SELECT COUNT (1)
					  FROM BSC_INSA_DEPT
					 WHERE YEAR = A.YEAR
					   AND UP_DEPT_CD = A.DEPT_CD
				  GROUP BY YEAR, UP_DEPT_CD), '0') AS CNT
		 FROM BSC_INSA_DEPT A
		WHERE A.YEAR = #findYear#
		  AND A.DEPT_CD IN ( SELECT DEPT_CD
							   FROM BSC_INSA_DEPT
							  WHERE YEAR = #findYear#
						 START WITH DEPT_CD =#findDeptCd#
				   CONNECT BY PRIOR YEAR = YEAR
								AND PRIOR DEPT_CD = UP_DEPT_CD )
	 ORDER BY A.DEPT_LEVL, A.DISP_ORDER, A.DEPT_CD                     
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getDeptListData" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_CD
			 , A.DEPT_KOR_NM
			 , A.UP_DEPT_CD
			 , A.UP_USER_ID
			 , (SELECT DEPT_KOR_NM
				  FROM BSC_INSA_DEPT
				 WHERE A.YEAR = YEAR
				   AND DEPT_CD = A.UP_DEPT_CD) AS UP_DEPT_NAME
			 , B.USER_NM
			 , DECODE (A.USE_YN,  'T', 'Y',  'F', 'N',  '') AS USE_YN
			 , A.DEPT_LEVL
			 , A.DISP_ORDER
			 , (SELECT COUNT (1)
				  FROM BSC_INSA_DEPT
				 WHERE YEAR = A.YEAR
				   AND UP_DEPT_CD = A.DEPT_CD) AS CNT
		  FROM    BSC_INSA_DEPT A
LEFT OUTER JOIN   V_ROLE_USER B
		     ON B.USER_ID = A.UP_USER_ID
		  WHERE A.YEAR = #findYear#
		  	AND A.DEPT_CD = #deptCd#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 코드 중복체크
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getDeptCdCount" parameterClass="hashMap" resultClass="integer">
        SELECT COUNT(1) CNT FROM BSC_INSA_DEPT WHERE YEAR = #findYear# AND DEPT_CD = #deptCd#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 등록
	  #	기능	: INSERT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->	
	<insert id="insertData" parameterClass="hashMap">
		INSERT INTO BSC_INSA_DEPT (
					YEAR
                  , DEPT_CD
                  , DEPT_KOR_NM
                  , UP_DEPT_CD
                  , USE_YN
                  , DISP_ORDER
                  , disp_levl
                  ) VALUES ( 
                    #findYear#
                  , #deptCd#
                  , #deptNm#
                  , #upDeptCd#
                  , DECODE(#useYn#, 'Y', 'T', 'N', 'F')
                  , #dispOrder#
                  , (select disp_levl + 1 from BSC_INSA_DEPT where year = #findYear# and dept_cd = #upDeptCd#)
              )
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 수정
	  #	기능	: UPDATE
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE BSC_INSA_DEPT SET
		       DEPT_CD = #deptCd#
		     , DEPT_KOR_NM = #deptNm#
		     , USE_YN = DECODE(#useYn#, 'Y', 'T', 'N', 'F')
		     , UP_USER_ID = #upUserId#
		     , DISP_ORDER = #dispOrder#
		 WHERE YEAR = #findYear#
		   AND DEPT_CD = #deptCd#
	</update>	
	

	<!--
	==================================================================   
	  # 설명	: 인사조직 삭제
	  #	기능	: DELETE
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">
		UPDATE BSC_INSA_DEPT
		   SET USE_YN = 'F'
		 WHERE YEAR = #findYear#
		   AND DEPT_CD = #deptCd#
		
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 인사정보 입력(불러오기용)
	  #	기능	: INSERT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->	
	<insert id="insertInsaInfo" parameterClass="hashMap">
		CALL KGS_INSA.BSC_INSA_DEPT(#findYear#)
	</insert>
	
</sqlMap>


