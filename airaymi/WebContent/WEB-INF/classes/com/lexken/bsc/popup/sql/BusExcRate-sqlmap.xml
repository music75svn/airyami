<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bsc.popup.busExcRate">

	<!--
	==================================================================
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	:
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />


	<!--
	==================================================================
	  # 설명	: 시스템항목관리 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_SYSTEM_ITEM
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		<isEqual property="findDeptId" compareValue="1300">
                SELECT DEPT_CD, DEPT_NM, ACCT_CD, ACCT_NM, BGT_TOT_AMT, BGT_RSLT, BGT_AMT
                     , ROUND(NVL(BGT_RSLT / DECODE(BGT_AMT, 0, NULL, BGT_AMT) * 100, 0), 5) RATE
                  FROM ( 
                        SELECT DEPT_CD, DEPT_NM, ACCT_CD, ACCT_NM, NVL(SUM(BGT_TOT_AMT), 0) BGT_TOT_AMT
			<isEqual property="findQuarter" compareValue="01">
							 , NVL(SUM(BGT_RSLT1), 0) BGT_RSLT, NVL(SUM(BGT_AMT1), 0) BGT_AMT
			</isEqual>
			<isEqual property="findQuarter" compareValue="02">
							 , NVL(SUM(BGT_RSLT2), 0) BGT_RSLT, NVL(SUM(BGT_AMT2), 0) BGT_AMT
			</isEqual>
			<isEqual property="findQuarter" compareValue="03">
							 , NVL(SUM(BGT_RSLT3), 0) BGT_RSLT, NVL(SUM(BGT_AMT3), 0) BGT_AMT
			</isEqual>
			<isEqual property="findQuarter" compareValue="04">
							 , NVL(SUM(BGT_RSLT4), 0) BGT_RSLT, NVL(SUM(BGT_AMT4), 0) BGT_AMT
			</isEqual>
                          FROM V_AAA0106M_001
                         WHERE YY = #findYear#
                           AND MGT_BUSN_CD NOT IN ('220130048', '220130195')
                           AND (ACCT_CD LIKE '120206%' OR ACCT_CD IN ('12010200', '12020701') OR ACCT_CD LIKE '120205%' OR ACCT_CD LIKE '610524%')
                         GROUP BY DEPT_CD, DEPT_NM, ACCT_CD, ACCT_NM
                         UNION
                        SELECT '9999', '', '', '', DEBT_PLAN_AMT * 4, LOAN_AMT, DEBT_PLAN_AMT
			<isEqual property="findQuarter" compareValue="01">
						  FROM TABLE(BSC_SYSTEM_KGS.F_LOAN_LIST(#findYear#, '03'))
			</isEqual>
			<isEqual property="findQuarter" compareValue="02">
						  FROM TABLE(BSC_SYSTEM_KGS.F_LOAN_LIST(#findYear#, '06'))
			</isEqual>
			<isEqual property="findQuarter" compareValue="03">
						  FROM TABLE(BSC_SYSTEM_KGS.F_LOAN_LIST(#findYear#, '09'))
			</isEqual>
			<isEqual property="findQuarter" compareValue="04">
						  FROM TABLE(BSC_SYSTEM_KGS.F_LOAN_LIST(#findYear#, '12'))
			</isEqual>
                         WHERE CNT = 4
                       )
                 ORDER BY DEPT_CD, ACCT_CD
		</isEqual>
		<isNotEqual property="findDeptId" compareValue="1300">
                SELECT DEPT_CD, DEPT_NM, ACCT_CD, ACCT_NM, BGT_TOT_AMT, BGT_RSLT, BGT_AMT
                     , ROUND(NVL(BGT_RSLT / DECODE(BGT_AMT, 0, NULL, BGT_AMT) * 100, 0), 5) RATE
                  FROM ( 
                        SELECT DEPT_CD, DEPT_NM, ACCT_CD, ACCT_NM, NVL(SUM(BGT_TOT_AMT), 0) BGT_TOT_AMT
			<isEqual property="findQuarter" compareValue="01">
							 , NVL(SUM(BGT_RSLT1), 0) BGT_RSLT, NVL(SUM(BGT_AMT1), 0) BGT_AMT
			</isEqual>
			<isEqual property="findQuarter" compareValue="02">
							 , NVL(SUM(BGT_RSLT2), 0) BGT_RSLT, NVL(SUM(BGT_AMT2), 0) BGT_AMT
			</isEqual>
			<isEqual property="findQuarter" compareValue="03">
							 , NVL(SUM(BGT_RSLT3), 0) BGT_RSLT, NVL(SUM(BGT_AMT3), 0) BGT_AMT
			</isEqual>
			<isEqual property="findQuarter" compareValue="04">
							 , NVL(SUM(BGT_RSLT4), 0) BGT_RSLT, NVL(SUM(BGT_AMT4), 0) BGT_AMT
			</isEqual>
                          FROM V_AAA0106M_001
                         WHERE YY = #findYear#
                           AND MGT_BUSN_CD NOT IN ('220130048', '220130195')
                           AND (ACCT_CD LIKE '120206%' OR ACCT_CD IN ('12010200', '12020701') OR ACCT_CD LIKE '120205%' OR ACCT_CD LIKE '610524%')
                           AND DEPT_CD IN (SELECT DEPT_ID FROM BSC_DEPTINFO WHERE UP_DEPT_ID = #findDeptId#)
                         GROUP BY DEPT_CD, DEPT_NM, ACCT_CD, ACCT_NM
                       )
                 ORDER BY DEPT_CD, ACCT_CD
		</isNotEqual>
	</select>

	<!--
	==================================================================
	  # 설명	: 부서조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_DEPTINFO
	==================================================================
	-->
	<select id="getDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_ID
			, A.DEPT_NM
          FROM BSC_DEPTINFO A
          LEFT OUTER JOIN BSC_SC_DEPT_MAPPING B
          ON A.DEPT_ID = B.DEPT_ID
          WHERE B.YEAR = #findYear#
          <isNotEmpty prepend="AND" property="findScDeptCd">
          	B.SC_DEPT_ID = #findScDeptCd#
          </isNotEmpty>
          <isEmpty prepend="AND" property="findScDeptCd">
            B.DEPT_ID = #findDeptId#
          </isEmpty>
	</select>

	<!--
	==================================================================
	  # 설명	: 부서조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_DEPTINFO
	==================================================================
	-->
	<select id="getDeptInfo" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.SC_DEPT_ID
		     , B.DEPT_ID
		     , C.DEPT_NM
		  FROM BSC_METRIC A
		  LEFT OUTER JOIN BSC_SC_DEPT_MAPPING B
		    ON A.YEAR = B.YEAR AND A.SC_DEPT_ID = B.SC_DEPT_ID
		  LEFT OUTER JOIN BSC_DEPTINFO C
		    ON B.DEPT_ID = C.DEPT_ID
		 WHERE A.METRIC_GRP_ID = (SELECT METRIC_GRP_ID
		                            FROM BSC_METRIC
		                           WHERE YEAR = #findYear# 
		                             AND METRIC_ID = #findMetricId#)
	</select>

	<!--
	==================================================================
	  # 설명	: 시스템 연계항목 정보를 가져옴
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getItem" remapResults="true" parameterClass="hashMap" resultClass="hashMap">
          SELECT A.ITEM_CD, B.CAL_TYPE_COL_NM
            FROM BSC_SYSTEM_ITEM A
               , BSC_CAL_TYPE_COL B
           WHERE A.YEAR = #findYear#
             AND A.YEAR = B.YEAR
             AND A.ITEM_CD = B.ITEM_CD
             AND B.METRIC_ID = #findMetricId#
           ORDER BY B.CAL_TYPE_COL_NM
	</select>


</sqlMap>
