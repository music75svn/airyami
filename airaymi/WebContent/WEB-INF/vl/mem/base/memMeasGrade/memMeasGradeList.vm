#*************************************************************************
* CLASS 명      : memMeasGradeList
* 작 업 자      : 유연주
* 작 업 일      : 2017년 03월10일
* 기    능      : 계량평가등급환산표
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자     작   업   일       변 경 내 용           비  고
* ----  --------  -----------------  -------------------------  -----------
*  1     유연주      2017년 03월 10일            최 초 작 업
**************************************************************************#
#set($curr_url = $!{context_path} + "/mem/base/memMeasGrade/memMeasGradeList.vw")
<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;

	J(document).ready(function(){

		/******************************************
		 * 데이터 그리드 출력
		 ******************************************/
		dispSection()

		/******************************************
		 * 조회
		 ******************************************/
		J("#formFind").submit(function(event) {
			//submit 하기전 작업추가
		});

		/******************************************
		 * 신규 등록
		 ******************************************/
		J("#btnInsert").click(function() {
			saveChk();
		});

	});

	/*****************************************************
	 * 득점산식 구분에 의한 평가구간을 활성 비활성 한다.
	 *****************************************************/
    function dispSection() {
    	var arg = J("#findGubun").val();

    	if(arg == "01") { //상향구간대, 득점산식+구간대
			J("span.optionStr").text("이상");
			J("span.optionStr:last").text("미만");
    	} else if(arg == "02") { //하향구간대
			J("span.optionStr").text("이하");
			J("span.optionStr:last").text("초과");
    	}
    }

	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk() {

		if(J("#selYear").val() != J("#findYear").val() || J("#selGubun").val() != ""){
			if(J("#selGubun").val() != J("#findGubun").val() || J("#selYear").val() != J("#findYear").val()){
				alert("조회조건과 조회 결과가 다릅니다. 조회 후 저장해주세요.");
				return false;
			}
		}

		//구간 입력 체크
        if(!scoreCalTypeSaveChk()) return;

        //구간대처리
        if(!calEvalSection()) return;

		J.showConfirmBox("저장하시겠습니까?", "saveDo"); //saveDo() 콜백함수 호출
	}

	/******************************************
	 * 등록구간 입력 체크
	 ******************************************/
	function scoreCalTypeSaveChk() {
		var saveChk = true;

        J("input[name=conversionScores]", "#evalSectionArea").each(function(index, item) {
            if(J(item).val() == "") {
                J.showMsgBox("환산점수를 입력해 주십시요", null, J('input[name=conversionScores]').eq(index));
                saveChk = false;
                return false;
            }
            if( isNaN(J(item).val())) {
                J.showMsgBox("환산점수을 숫자만 입력 가능합니다.", null, J('input[name=conversionScores]').eq(index));
                saveChk = false;
                return false;
            }
        });

        J("input[name=viewValues]", "#evalSectionArea").each(function(index, item) {
            if(J(item).val() == "") {
                J.showMsgBox("점수구간을 입력해 주십시요", null, J('input[name=viewValues]').eq(index));
                saveChk = false;
                return false;
            }
            if( isNaN(J(item).val())) {
                J.showMsgBox("점수구간을 숫자만 입력 가능합니다.", null, J('input[name=viewValues]').eq(index));
                saveChk = false;
                return false;
            }

        });

        return saveChk;
	}
	
	/******************************************
	 * 구간대 처리
	 ******************************************/
	function calEvalSection() {
		var value = J("#findGubun").val();
		var cnt = J("input[name=viewValues]").length ;

    	var firstVal = "";
    	var lastVal = "";
    	var isDescending = true;

    	if (value == "01" || value == "02") {
    		var tmp_0 = 0 ;
    		var tmp_1 = 0 ;

    		if( "" != J("input[name=viewValues]").eq(0).val() && "" != J("input[name=viewValues]").eq(1).val()) {
    			tmp_0 = parseFloat(J("input[name=viewValues]").eq(0).val());
    			tmp_1 = parseFloat(J("input[name=viewValues]").eq(1).val());
    			if(tmp_0 > tmp_1 && value == "01") {
    				isDescending = true;
    			} else if( tmp_0 < tmp_1 && value == "02") {
    				isDescending = false;
    			} else {
                    alert("상/하향구간 점수가 잘못 되어있습니다.");
                    J("input[name=viewValues]").eq(0).focus()
    				return false;
    			}
    		} else {
    			return false;
    		}

    		for(var i = 2; i < cnt - 1; i++) {
    			tmp_0 = parseFloat(J("input[name=viewValues]").eq(i-1).val());
    			tmp_1 = parseFloat(J("input[name=viewValues]").eq(i).val());
    			if(isDescending) {
    				if(tmp_0 > tmp_1) {
    				} else {
                        alert("상향구간 점수가 잘못 되어있습니다.");
                        J("input[name=viewValues]").eq(i).focus()
    					return false;
    				}
    			} else {
    				if(tmp_0 < tmp_1) {
    				} else {
                        alert("하향구간 점수가 잘못 되어있습니다.");
                        J("input[name=viewValues]").eq(i).focus()
    					return false;
    				}
    			}
    		}
    	}

    	if(isDescending) {
    		firstVal = "9999999";
    		lastVal = "-9999999";
    	} else {
    		firstVal = "-9999999";
    		lastVal = "9999999";
    	}

    	if (value == "01") {
    		for(var i = 0; i < cnt; i++) {
    			if (i == 0) {
					J("input[name=fromValues]").eq(i).val( J("input[name=viewValues]").eq(i).val() );
					J("input[name=toValues]").eq(i).val(firstVal);
    			} else if (i == cnt-1) {
					J("input[name=fromValues]").eq(i).val(lastVal);
					J("input[name=toValues]").eq(i).val( J("input[name=viewValues]").eq(i).val() );
    			} else {
					J("input[name=fromValues]").eq(i).val( J("input[name=viewValues]").eq(i).val() );
					J("input[name=toValues]").eq(i).val( J("input[name=viewValues]").eq(i-1).val() );
    			}
    		}
    	} else if (value == "02") {
    		for(var i = 0; i < cnt; i++) {
    			if (i == 0) {
					J("input[name=fromValues]").eq(i).val(firstVal);
					J("input[name=toValues]").eq(i).val( J("input[name=viewValues]").eq(i).val() );
    			} else if (i == cnt-1) {
					J("input[name=fromValues]").eq(i).val( J("input[name=viewValues]").eq(i-1).val() );
					J("input[name=toValues]").eq(i).val(lastVal);
    			} else {
					J("input[name=fromValues]").eq(i).val( J("input[name=viewValues]").eq(i-1).val() );
					J("input[name=toValues]").eq(i).val( J("input[name=viewValues]").eq(i).val() );
    			}
    		}
    	}
    	return true;
	}

    /******************************************
     * 저장
     ******************************************/
    function saveDo() {

        J("#mode").val("MODLIST");
        J("#year").val(J("#findYear").val());
        J("#gubun").val(J("#findGubun").val());
        J("#formList").attr("action", "$!{context_path}/mem/base/memMeasGrade/memMeasGradeProcess.vw?type=template").submit();

        return false;

    }

//]]>
</script>

<div id="Table">
	<div id="Table_blockContainer">
		<h1 class="none">계량평가등급환산표</h1>
		<div class="tableTop">
			#parse("/WEB-INF/vl/common/template/tabs.vm")

    		<!-- search S -->
			<form id="formFind" name="formFind" method="post" action="$!{context_path}/mem/base/memMeasGrade/memMeasGradeList.vw?type=template">
				<input type="hidden"    id="findHighPgmId"  name="findHighPgmId"    value="$!{searchMap.txt2html("findHighPgmId")}" />
				<input type="hidden"    id="findSubPgmId"   name="findSubPgmId"     value="$!{searchMap.txt2html("findSubPgmId")}" />
				<input type="hidden"    id="findPgmId"      name="findPgmId"        value="$!{searchMap.txt2html("findPgmId")}" />
				<input type="hidden"    id="selGubun"       name="selGubun"         value="$!{searchMap.txt2html("findGubun")}" />
				<input type="hidden"    id="selYear"        name="selYear"          value="$!{searchMap.txt2html("findYear")}" />

				<div class="searchBox">
    				<div><div><div>
    				<table summary="계량평가등급환산표 검색 조건">
						<caption class="none">계량평가등급환산표 검색 조건</caption>
						<thead><tr><th></th></tr></thead>
        				<tbody>
            				<tr>
								<td class="searchBox_tit w250">
            						<span><label for="findYear">기준년도</label></span>
            						<span class="searchBar">
            							<select id="findYear" name="findYear" class="select w80">
            								$!CS_CODE.getCodeOption("017", $!{searchMap.txt2html("findYear")})
            							</select>
            						</span>
            					</td>
								<td class="searchBox_tit w250">
            						<span><label for="findYear">구분</label></span>
            						<span class="searchBar">
            							<select id="findGubun" name="findGubun" class="select w120">
            								$!CS_CODE.getCodeOption("234", $!{searchMap.txt2html("findGubun")})
            							</select>
            						</span>
            					</td>
            				</tr>
        				</tbody>
    				</table>
                    <input type="image" class="btnSearch" src="$!{img_path}/common/btn_search.gif" align="middle" alt="검색" />
                    </div></div></div>
    	        </div>
    		</form>
    		<!-- search E -->
			<div class="clear"></div>
		</div>

		<form id="formList" name="formList" method="post" action="$!{context_path}/mem/base/memMeasGrade/memMeasGradeProcess.vw?type=template">
			<input type="hidden" id="mode"				name="mode" />
			<input type="hidden" id="year"				name="year" />
			<input type="hidden" id="yearNm"     		name="yearNm" />
			<input type="hidden" id="gubun"				name="gubun" />
			<input type="hidden" id="gubunNm"			name="gubunNm" />

			$!{searchMap.makeHiddenFind()}
			<!-- 평가등급 구간대 -->
			<div id="evalSectionArea" class="blockDetail2">
    			<table summary="평가등급구간대 등록">
    				<caption class="none">평가등급구간대 등록</caption>
    				<colgroup>
    					<col width="15%" />
    					<col width="15%" />

						#foreach($list in $evalSectionList)
							<col width="14%" />
						#end

    				</colgroup>
    				<tbody>
    					<tr>
    						<th scope="row" rowspan="3"><span class="txt_red">(*)</span> 평가등급구간대</th>
    						<th scope="row">구간분류</th>

							#foreach($list in $evalSectionList)
    							<th scope="row">$!{CS_HTML.txt2html($list.EVAL_SECTION_NM)}</th>
							#end

    					</tr>
						<tr>
							<th scope="row">점수구간</th>

							#set($curValue = "")
							#set($lastValue = "")
							#set($idx = 1)
							#set($evalSectionListSize = $!{CS_HTML.txt2html($evalSectionList.size())})
							#foreach($list in $evalSectionList)
								#if($idx == $evalSectionListSize)
									#set($curValue = $!{lastValue})
								#else
									#set($curValue = $!{CS_HTML.txt2html($list.VIEW_VAL)})
								#end
    							<td>
									<input type="hidden" name="evalSectionIds" class="inputbox w50" value="$!{CS_HTML.txt2html($list.EVAL_SECTION_ID)}" />
    								<input type="text" name="viewValues" class="inputbox w50" value="$!{curValue}" maxlength="15" title="환산점수"/>
									<input type="hidden" name="fromValues" class="inputbox w50" value="$!{CS_HTML.txt2html($list.FROM_VALUE)}" />
									<input type="hidden" name="toValues" class="inputbox w50" value="$!{CS_HTML.txt2html($list.TO_VALUE)}" />
									<span class="optionStr">이상</span>
    							</td>
								#set($idx = $idx + 1)
								#set($lastValue = $curValue)
							#end

    					</tr>
						<tr>
    						<th scope="row">환산점수</th>
							#foreach($list in $evalSectionList)
								<td>
    								<input type="text" name="conversionScores" class="inputbox w80" value="$!{CS_HTML.txt2html($list.CONVERSION_SCORE)}" maxlength="6" title="환산점수"/>
    							</td>
							#end
    					</tr>
    				</tbody>
    			</table>
    		</div>

			<!-- 버튼 -->
    		<div class="blockButton">
    			<ul>
    				<li><input type="button" id="btnInsert" value="저장" /></li>
    			</ul>
    		</div>
		</form>

	</div>
	<div class="clear"></div>
</div>
