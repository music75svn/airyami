#*************************************************************************
* CLASS 명      : rptModify
* 작 업 자      : 김상용
* 작 업 일      : 2013년 06월 03일 
* 기    능      : 간부개인업적평가 자기성과기술서    
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자    작     업     일        변 경 내 용                비고
* ----  --------  -----------------  -------------------------  --------
*  1    김상용      2013년 06월 03일             최 초 작 업
*  2    김효은      2013년 12월 16일               수 정
**************************************************************************#

<script type="text/javascript" language="javascript" src="$!{spaceditor_path}/spac_editor_common.js"></script>
<script type="text/javascript" language="javascript" src="$!{spaceditor_path}/spac_editor.js"></script>
<link rel="stylesheet" type="text/css" href="$!{spaceditor_path}/spac_editor_common.css">
<link rel="stylesheet" type="text/css" href="$!{spaceditor_path}/spac_editor.css">
	
<script type="text/javascript" language="javascript" >
//<![CDATA[

    var J = jQuery;

    J(document).ready(function(){
	
		/******************************************
         * 테이블 rowspan(소타이틀)
         ******************************************/
		#set($listSize = $!{CS_HTML.txt2html($rptDetail.size())})
		var size = $listSize +1;
		#if($listSize == 0)
		J("#smallTitle").attr('rowspan', "2");
		#else
		J("#smallTitle").attr('rowspan', size);
		#end
    
		/******************************************
         * 전년도 소속부서
         ******************************************/
    	var index = 0;
		#foreach($dept in $lastDept)
			J("#lastYearDept").append("<li id=\"lastDepts$!{CS_HTML.txt2html($dept.DEPT_CD)}\"><input type=\"hidden\" id=\"lastDeptCd$!{CS_HTML.txt2html($dept.DEPT_CD)}\" name=\"lastDeptCd\" value=\"$!{CS_HTML.txt2html($dept.DEPT_CD)}\">$!{CS_HTML.txt2html($dept.DEPT_FULL_NM)} ( $!{CS_FORMAT.dateFormat($dept.FROM_DT)}<input type=\"hidden\" id=\"startPcmtDate$!{CS_HTML.txt2html($dept.DEPT_CD)}\" name=\"startPcmtDate\" class=\"inputbox w60\" value=\'$!{CS_HTML.txt2html($!{dept.FROM_DT})}\' maxlength=\"20\" readonly /> ~ $!{CS_FORMAT.dateFormat($!{dept.TO_DT})}<input type=\"hidden\" id=\"endPcmtDate$dept.DEPT_CD\" name=\"endPcmtDate\" class=\"inputbox w60\" value=\'$!{CS_HTML.txt2html($!{dept.TO_DT})}\' maxlength=\"20\" readonly /> ) </li>");
			index++;
		#end
    
        /******************************************
         * 취소버튼 (돌아가기)
         ******************************************/
        J("#btnBack").click(function() {
       		J("#form1").attr("enctype", "application/x-www-form-urlencoded");
			J("#form1").attr("action", "$!{context_path}/prs/mng/rpt/rptList.vw?type=template").submit();
        });
        
        /******************************************
         * 저장버튼 이벤트
         ******************************************/
        J("#btnInsert").click(function(e) {
            e.preventDefault();
            saveChk(false);
        });

        /******************************************
         * 저장버튼 이중 클릭 방지
         ******************************************/
        J("form").submit(function(){
            J("#btnInsert").unbind();
        });
        
        if ("$!{rpt.SUBMIT_YN}" == "Y") {
			J("#btnSubmit").attr("value", "제출취소");
			J("#btnInsert").hide();
			
    		J("#btnSubmit").click(function() { //제출버튼 이벤트
    			cancelSubmit();
    		});
		} else {
			J("#btnSubmit").attr("value", "제출");
    		J("#btnSubmit").click(function() { //제출버튼 이벤트
    			saveChk(true);
    		});
		}
		
		/******************************************
		 * 비고 byte 체크
		 ******************************************/
		J("#content").checkbyte({
			indicator:J("#indicator"),
			limit:500
		});
		J("#content").trigger("keyup");
		
		// 자기성과기술서 제출기간 보여주기
		if( "T" != "$!{rptSchedule.RPT_YN}" ){
			J("#alertDis").html("※  자기성과기술서 제출기간이 아닙니다." ).attr("class","txt_red");
			J("#btnInsert").hide();
			J("#btnSubmit").hide();
		}
		
		/******************************************
    	 * 상세최종일자조회 fancybox
    	 ******************************************/
		 J("#finalApproveSearch").fancybox();
    });
    
    /******************************************
	 * 자기성과기술서 제출취소
	 ******************************************/
	function cancelSubmit() {
		document.charset='utf-8';
		J.showConfirmBox("제출된 자기성과기술서를 취소하시겠습니까?", "cancelDo"); //cancelDo() 콜백함수 호출
	}
	
	var isRptSubmit = false;
	
	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk(isSubmit) {
		var fileChk = true;
		
		//첨부파일 확장자 체크
        J(":file", "#form1").each(function(index, item) {
            var fileFullName = J("input[name=" + item.name + "]").val();
            var src = getFileExtension(fileFullName);
            if (!((src.toLowerCase() == "xls") || (src.toLowerCase() == "xlsx") || (src.toLowerCase() == "ppt") || (src.toLowerCase() == "pptx")||
                  (src.toLowerCase() == "doc") || (src.toLowerCase() == "docx") || (src.toLowerCase() == "hwp") || (src.toLowerCase() == "pdf") ||
                  (src.toLowerCase() == "zip") || (src.toLowerCase() == "txt")  || (src.toLowerCase() == "gif") || (src.toLowerCase() == "jpg") ||
                  (src.toLowerCase() == "png") || (src.toLowerCase() == "png")
                )) {
            
                fileChk = false;
            }
        });

        if (fileChk == false) {
            J.showMsgBox("허용되지 않는 파일형식입니다<br/>허용되는 파일형식 : <br/>xls, xlsx, ppt, pptx, doc, docx, hwp <br/> pdf, zip, txt, gif, jpg, png, jpeg", null, null);
            return;
        }
        
		isRptSubmit = isSubmit;
		
		document.charset='utf-8';
		
		var str = "";
		
		if (isRptSubmit) {
			str = "자기성과기술서를 제출하시겠습니까?";
		} else {
			str = "저장하시겠습니까?";
		}
		
		J.showConfirmBox(str, "saveDo"); //saveDo() 콜백함수 호출
	}

    
    /******************************************
     * 저장
     ******************************************/
    function saveDo() {
   		 syncEditor();
		//document.getElementById('spaceditor_id_textarea').value  = getStringToUnicodeHTML(document.getElementById('spaceditor_id_textarea').value);
		//document.getElementById('spaceditor_id_textarea').value = J('<div>').text(document.getElementById('spaceditor_id_textarea').value).html();
		
		if (isRptSubmit) {
			J("#mode").val("SUBMIT");
		} else {
			J("#mode").val("SAVE");
		}
		
        J("#form1").attr("action", "$!{context_path}/prs/mng/rpt/rptProcess.vw?type=template").submit();
    }
	
	/******************************************
	 * 파일추가
	 ******************************************/
	var fileIndex = 0;
	
	function fileAttachAdd() {
		J("#fileAttach").append("<li id=\"fileRow" + fileIndex + "\"><input type=\"file\" name=\"file" + fileIndex + "\" class=\"input\" size=\"70\" /> <input type=\"button\" value=\"삭제\" onclick=\"deleteRow(" + fileIndex + ")\" class=\"input\" size=\"70\"></li>");
		fileIndex++;
	}
	
	/******************************************
	 * 제출취소
	 ******************************************/
	function cancelDo() {
		J("#mode").val("CANCEL");
		J("#form1").attr("action", "$!{context_path}/prs/mng/rpt/rptProcess.vw?type=template").submit();
	}
	
	/******************************************
	 * 파일삭제
	 ******************************************/
	function deleteRow(fileIndex)	{
    	J("#fileRow" + fileIndex).remove();
    }
    
    // 문자열 --> HTML 정식 유니코드 문자열 
    function getStringToUnicodeHTML(str) { 
        var test = /^[a-zA-Z0-9ㄱ-ㅎ가-힣~!\#\-$^&*\=+|:;?"<,.>'\/\s%]/;
        
        str = str || ''; 
        var ret = []; 
        var strs = str.split(''); 
        for (var i = 0, length = strs.length; i < length; i++) { 
            if( !test.test(str.charAt(i)) ) {
                ret.push('&#' + strs[i].charCodeAt(0));
            } else {
                ret.push(strs[i]);
            }
        } 
        return ret.join(''); 
    } 
    // 문자열 --> 유니코드 문자열 
    function getStringToUnicode(str) { 
        str = str || ''; 
        var ret = []; 
        var strs = str.split(''); 
        for (var i = 0, length = strs.length; i < length; i++) { 
        ret.push(escape(strs[i]).replace('%', '\\')); 
        } 
        return ret.join(''); 
    } 
    // 유니코드 문자열 --> 문자열 
    function getUnicodeToString(unicodes) { 
        unicodes = unicodes || []; 
        var ret = []; 
        for (var i = 0, length = unicodes.length; i < length; i++) { 
        ret.push(unescape(unicodes[i])); 
        } 
        return ret.join(''); 
    } 
    // HTML 정식 유니코드 문자열 --> 문자열 
    function getUnicodeHTMLToString(unicodes) { 
        unicodes = unicodes || []; 
        var ret = []; 
        for (var i = 0, length = unicodes.length; i < length; i++) { 
        ret.push(String.fromCharCode(parseInt(unicodes[i].replace('&#', ''), 10))); 
        } 
        return ret.join(''); 
    } 

//]]>
</script>    
 
<form id="form1" name="form1" method="post" enctype="multipart/form-data"  action="$!{context_path}/prs/mng/rpt/rptProcess.vw?type=template">
    <input type="hidden"     id="mode"            name="mode"              value="$!{searchMap.txt2html("mode")}" />
    <input type="hidden"     id="year"            name="year"              value="$!{searchMap.txt2html("findYear")}" />
    <input type="hidden"     id="targetId"        name="targetId" 		   value="$!{CS_HTML.txt2html($detail.TARGET_ID)}" /> 
    <input type="hidden"     id="evalMembEmpn"    name="evalMembEmpn"      value="$!{searchMap.txt2html("evalMembEmpn")}" />
    <input type="hidden"     id="evalMembEmpnSeq" name="evalMembEmpnSeq"   value="$!{searchMap.txt2html("evalMembEmpnSeq")}" />
    <input type="hidden"     id="userId"          name="userId" 		   value="$!{CS_LOGIN.getUser_id()}" />         
    <input type="hidden"     id="curDeptCd"       name="curDeptCd" 		   value="$!{CS_HTML.txt2html($rpt.DEPT_CD)}" /> 
	$!{searchMap.makeHiddenFind()}
    
    <div id="Table">
        <div id="Table_blockContainer">
            <div class="tableTop">
                #parse("/WEB-INF/vl/common/template/tabs.vm")
                <div class="clear"></div>
            </div>
			<div class="blockDetail">
                <table summary="자기평가기술서 관리 등록">
                    <caption class="none">자기평가기술서 관리 등록</caption>
                    <colgroup>
                        <col width="10%" />
                        <col width="30%" />
                        <col width="10%" />
                        <col width="20%" />
                        <col width="10%" />
                        <col width="30%" />
                    </colgroup>
                    <tbody>
						<tr>
                            <th scope="row"><label for="findYear">직전 소속부서</label></th>
                            <td><div><ul id="lastYearDept"></ul></div></td>
                            <th scope="row"><label for="posTcNm">현 소속부서</label></th>
                            <td><span>$!{CS_HTML.txt2html($rpt.DEPT_CUR_NM)}</span></td>
                            <th scope="row"><label for="deptKorNm">성명</label></th>
                            <td><span>$!{CS_HTML.txt2html($rpt.KOR_NM)}</span></td>
                        </tr>
						<tr>
							<th scope="row"><label for="korNm">직위</label></th>
                            <td><span>$!{CS_HTML.txt2html($rpt.CAST_TC_NM)}</span></td>
							<th scope="row"><label for="korNm">직급</label></th>
                            <td colspan="3"><span>$!{CS_HTML.txt2html($rpt.CAST_TC_NM)}</span></td>
                        </tr>
						<tr>
                            <th scope="row"><label for="approveUserNm">직무 수행기간</label></th>
                            <td><span>$!{CS_HTML.txt2html($rpt.FROM_DT,100)} ~ $!{CS_HTML.txt2html($rpt.TO_DT,100)}</span></td>
                            <th scope="row"><label for="planStatusNm">확인자</label></th>
                            <td><span>$!{CS_HTML.txt2html($rpt.APPROVE_USER_NM)}</span></td>
                            <th scope="row"><label for="finalApproveDt">최종확인일</label></th>
                            <td><span>$!{CS_HTML.txt2html($rpt.FINAL_APPROVE_DT)}&nbsp;
						    #if($!{CS_HTML.txt2html($rpt.FINAL_APPROVE_DT)} != "")
							<a id="finalApproveSearch" href="$!{context_path}/prs/mng/planHistory/planHistoryList.vw?findYear=$!{searchMap.txt2html("findYear")}&amp;evalMembEmpn=$!{CS_HTML.txt2html($rpt.EVAL_MEMB_EMPN)}&amp;evalMembEmpnSeq=$!{CS_HTML.txt2html($rpt.EVAL_MEMB_EMPN_SEQ)}"><img src="$!{img_path}/common/board/ic_search.gif" class="valign_middle" alt="최종확인일선택" /></a>
							#end
							</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
	
    		<div class="blockDetail">
    			<table summary="자기성과기술서 등록">
					<caption class="none">자기성과기술서 등록</caption>
    				<colgroup>
    					<col width="10%" />
    					<col width="10%" />
    					<col width="25%" />
						<col width="15%" />
    					<col width="5%" />
    					<col width="5%" />
    					<col width="5%" />
    					<col width="5%" />
						<col width="5%" />
    					<col width="5%" />
    					<col width="5%" />
    					<col width="5%" />
    				</colgroup>
    				<tbody>
						 <tr>
                             <th scope="row" id="smallTitle" ><label for="directionCd">성과계획 및 실적</label></th>
                             <th scope="row" class="textCenter"><label for="directionNm">설정방향</label></th>
							 <th scope="row" class="textCenter"><label for="targetNm">성과목표</label></th>
							 <th scope="row" class="textCenter"><label for="metricNm">성과지표 </label></th>
							 <th scope="row" class="textCenter"><label for="weight">가중치 </label></th>
							 <th scope="row" class="textCenter"><label for="dffly_nm">난이도 </label></th>
							 <th scope="row" class="textCenter"><label for="targetValue">목표량 </label></th>
							 <th scope="row" class="textCenter"><label for="unitNm">단위 </label></th>
							 <th scope="row" class="textCenter"><label for="value">실적 </label></th>
							 <th scope="row" class="textCenter"><label for="score">달성도 </label></th>
							 <th scope="row" class="textCenter"><label for="evalGrade">평가 </label></th>
							 <th scope="row" class="textCenter"><label for="evalScore">환산<br/>점수 </label></th>
                         </tr>
						 #if($!{CS_HTML.txt2html($rptDetail.size())} == 0)
                             <tr class="textCenter"><td colspan="11">입력된 데이터가 없습니다.</td></tr>
        				 #else
						 #foreach($rptDetail in $rptDetail)
						 <tr>
                            <td>$!{CS_HTML.txt2html($rptDetail.DIRECTION_NM)}</td>
                            <td>$!{CS_HTML.txt2html($rptDetail.TARGET_NM)}</td>
                            <td>$!{CS_HTML.txt2html($rptDetail.METRIC_NM)}</td>
                            <td>$!{CS_HTML.txt2html($rptDetail.WEIGHT)}</td>
                            <td>$!{CS_HTML.txt2html($rptDetail.DFFLY_NM)}</td>
                            <td align="center">$!{CS_HTML.txt2html($rptDetail.TARGET_VALUE)}</td>
                            <td align="center">$!{CS_HTML.txt2html($rptDetail.UNIT_NM)}</td>
                            <td align="center">$!{CS_HTML.txt2html($rptDetail.VALUE)}</td>
                            <td align="center">$!{CS_HTML.txt2html($rptDetail.SCORE)}</td>
                            <td align="center">$!{CS_HTML.txt2html($rptDetail.EVAL_GRADE)}</td>
                            <td align="center">$!{CS_HTML.txt2html($rptDetail.EVAL_SCORE)}</td>
                         </tr>
						 #end
						 #end
						 <tr>
							<th scope="row">주요내용</th>
							<td colspan="11">
								<script type="text/javascript">createEditor('content','200', '$!{rpt.CONTENT.replaceAll("\r\n","").replaceAll("\\","&#92;").replaceAll("\'","\"")}', 'insertunorderedlist,insertorderedlist,createlink,unlink,attach,image_link,emoticon,special_chars,page_add,textbox,sourcebox,fullscreen,subscript,superscript,source,images');</script>
							</td>
						</tr>
						<tr>
							<th scope="row">첨부파일</th>
							<td colspan="11">
								#foreach($fileList in $fileList)
									$!{CS_HTML.makeFileIconFileName($fileList.get("ATTACH_FILE_SUFFIX"), $fileList.get("ATTACH_FILE_NM"), $fileList.get("ATTACH_FILE_PATH"))} 
									&nbsp;&nbsp;<input type="checkbox" name="delAttachFiles" id="delAttachFile$!{fileList.get("SEQ")}" value="$!{fileList.get("SEQ")}" />&nbsp;<label for="delAttachFile$!{fileList.get("SEQ")}">첨부파일 삭제</label> <br/>
								#end
								<a href="javascript:fileAttachAdd();"><img src="$!{img_path}/common/btn_file.gif" class="valign_middle" alt="파일추가" /></a>&nbsp;(첨부파일 용량제한은 100M입니다)<br/>
								<div>
									<ul id="fileAttach">
									</ul>
								</div>
							</td>
						</tr>
    				</tbody>
    			</table>
    		</div>
			<div class="blockButton_all">
				<div class="blockButton_l txt_blue">
					<span id="alertDis"></span>
				</div>
        		<div class="blockButton"> 
        			<ul>
        				<li><input type="button" id="btnBack"   value="돌아가기" /></li>
        				<li><input type="submit" id="btnInsert" value="저장" /></li>
    					<li><input type="button" id="btnSubmit" value="제출" /></li>
        			</ul>
        		</div>
            </div>
    	</div>
    	<div class="clear"></div>
    </div>
</form>
