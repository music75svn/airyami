<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.insa.insaDeptScore">

	<!--
	==================================================================
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	:
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />

	<!--
	==================================================================
	  # 설명	: 조직업적평가결과 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
          SELECT A.YEAR
               , A.DEPT_CD
               <!-- 
               , CASE
                    WHEN A.DEPT_LEVL = '2'
                    THEN
                       (SELECT DEPT_KOR_NM || ' '
                          FROM BSC_INSA_DEPT
                         WHERE A.YEAR = YEAR
                           AND A.UP_DEPT_CD = DEPT_CD)
                 END || A.DEPT_KOR_NM DEPT_KOR_NM
                -->
               , CASE
                    WHEN A.DEPT_LEVL = '2'
                    THEN
                       (SELECT DEPT_KOR_NM || ' '
                          FROM V_PRS_DEPT_MAPPING
                         WHERE A.YEAR = YEAR
                           AND A.UP_DEPT_CD = DEPT_CD)
                 END || B.DEPT_KOR_NM AS DEPT_KOR_NM
               , A.DEPT_GRADE AS GRADE
               , A.DEPT_SCORE AS SCORE
            FROM (           SELECT *
                               FROM (SELECT *
                                       FROM BSC_INSA_DEPT
                                      WHERE YEAR = #findYear#
		<![CDATA[
                                        AND (USE_YN = 'T' OR DEPT_CD = '0000'))
        ]]>
                              WHERE 1 = 1
                              AND DEPT_CD NOT IN ( '1000', '1005', '1010', '1090')
		<dynamic>
			<isEqual property="findDeptCd" compareValue="0000">
                         START WITH DEPT_CD = '0000'
		    </isEqual>
			<isNotEqual property="findDeptCd" compareValue="0000">
                         START WITH DEPT_CD = #findDeptCd#
		    </isNotEqual>
	    </dynamic>
                         CONNECT BY PRIOR DEPT_CD = UP_DEPT_CD
                  ORDER SIBLINGS BY DISP_ORDER) A
           INNER JOIN V_PRS_DEPT_MAPPING B
             ON A.YEAR = B.YEAR
            AND A.DEPT_CD = B.DEPT_CD
		<![CDATA[
           WHERE 1 = 1 AND A.DEPT_CD <> '0000'
        ]]>
        ORDER BY A.DEPT_CD
	</select>

	<!--
	==================================================================
	  # 설명	: 조직업적평가결과 등록
	  #	기능	: INSERT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<insert id="insertData" parameterClass="hashMap">
		MERGE INTO BSC_INSA_DEPT AA
		     USING (SELECT #year# AS YEAR
        		         , #deptCd# AS DEPT_CD
        		         , #deptNm# AS DEPT_KOR_NM
                 		 , UPPER(#grade#) AS DEPT_GRADE
                 		 , #score# AS DEPT_SCORE
              		FROM DUAL) BB
		        ON (AA.YEAR = BB.YEAR
        		AND AA.DEPT_CD = BB.DEPT_CD)
		WHEN MATCHED
		THEN
		   UPDATE SET AA.DEPT_GRADE = BB.DEPT_GRADE, AA.DEPT_SCORE = BB.DEPT_SCORE
		WHEN NOT MATCHED
		THEN
		   INSERT     (YEAR
		             , DEPT_CD
             		 , DEPT_KOR_NM
             		 , DEPT_GRADE
		             , DEPT_SCORE
		       )VALUES (BB.YEAR
        		     , BB.DEPT_CD
		             , BB.DEPT_KOR_NM
		             , BB.DEPT_GRADE
		             , BB.DEPT_SCORE)
	</insert>
	
	<!--
	==================================================================
	  # 설명	: 조직업적평가점수 가져오기
	  #	기능	: PROCEDURE
	  #	TABLE	: getBscScore
	==================================================================
	-->
	<procedure id="getBscScore" parameterClass="hashMap">
		CALL SP_PRS_DEPT_SCORE(#year#)
	</procedure>
	
	<!--
	==================================================================
	  # 설명	: 조직업적평가점수 월할계산
	  #	기능	: PROCEDURE
	  #	TABLE	: getBscMonScore
	==================================================================
	-->
	<procedure id="getBscMonScore" parameterClass="hashMap">
		CALL SP_PRS_MNG_DEPT_SCORE(#year#)
	</procedure>
	
	

</sqlMap>


