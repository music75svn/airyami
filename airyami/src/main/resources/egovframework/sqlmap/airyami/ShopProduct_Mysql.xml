<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="shopProduct">

<typeAlias alias="ValueMap" type="egovframework.airyami.cmm.util.ValueMap"/>
	
	<select id="shopProduct.getPrNo" parameterClass="Map" resultClass="java.lang.String">
		SELECT /* ShopProduct.xml  shopProduct.getPrNo */
				   CONCAT('CPR', DATE_FORMAT(now(), '%y%m%d'),
			              IFNULL((SELECT 
			                            LPAD(MAX(SUBSTR(PR_NO, 10, 5))+1, 5, '0') AS SERIAL_NO
			                        FROM
			                            TB_CUSTOMER_PR), '00001')) AS PR_NO
		      FROM DUAL
	</select>
	
	<insert id="shopProduct.insertCart" parameterClass="Map">
	INSERT /* ShopProduct.xml  shopProduct.insertCart */
	  INTO TB_CUSTOMER_PR
		(
		   PR_NO
		 , CUSTOMER_ID
         , PROD_NO
         , SUPPLY_COUNTRY
         , SUPPLY_CURRENCY
         , ORG_PRICE
         , PR_QTY
		 , INSERT_USER_ID
		 , INSERT_DT)
		VALUES
		(
		   #PR_NO#
		 , #LOGIN_ID#
         , #PROD_NO#
         , #SUPPLY_COUNTRY#
         , #SUPPLY_CURRENCY#
         , #ORG_PRICE#
         , #PR_QTY#
		 , #LOGIN_ID#
		 , DATE_FORMAT(now(), '%Y%m%d%H%i%s')
		)
	</insert>
	
	<select id="shop.getShopCartCount" parameterClass="Map" resultClass="java.lang.Integer">
	SELECT /* ShopProduct.xml  shop.getShopCartCount */
	       COUNT(1) 
	  FROM TB_CUSTOMER_PR A
	     , TB_PRODUCT_NAME B
	 WHERE 1 = 1
	   AND A.CUSTOMER_ID = #LOGIN_ID#
	   AND A.PROD_NO = B.PROD_NO
	   AND B.LANG_CD = #LANG_CD#
	</select>
	
	<select id="shop.getShopCartList" parameterClass="Map" resultClass="ValueMap" remapResults="true">
	<isEqual property="EXCEL_YN" compareValue="N">
	<include refid="pagingPrefixSQL"/>
	</isEqual>
	SELECT /* ShopProduct.xml  shop.getShopCartList */
           A.PR_NO
         , A.PROD_NO
         , B.PROD_NM
         , A.ORG_PRICE
         , A.PR_QTY
         , DATE_FORMAT(str_to_date(A.INSERT_DT, '%Y%m%d'), '%Y-%m-%d') AS INSERT_DT
	  FROM TB_CUSTOMER_PR A
	     , TB_PRODUCT_NAME B
	 WHERE 1 = 1
	   AND A.CUSTOMER_ID = #LOGIN_ID#
	   AND A.PROD_NO = B.PROD_NO
	   AND B.LANG_CD = #LANG_CD#
	 <isNotEmpty property="SORT_COL">
	 	<include refid="orderbySQL"/>
	 </isNotEmpty>
	 <isEmpty property="SORT_COL">
	 ORDER BY A.INSERT_DT DESC
	 </isEmpty>
	<isEqual property="EXCEL_YN" compareValue="N">
	<include refid="pagingSuffixSQL"/>
	</isEqual>
	</select>
	
	<delete id="shop.deleteCart" parameterClass="Map">
	DELETE /* ShopProduct.xml  shop.deleteCart */
	  FROM TB_CUSTOMER_PR
	 WHERE PR_NO = #PR_NO#
	</delete>
	
	<!-- TB_CUST_SHIP_TO_ADDR 배송지조회 -->
	<select id="shopProduct.getPreShipAddrInfo" parameterClass="Map" resultClass="ValueMap">
	SELECT /* ShopProduct.xml  shopProduct.getPreShipAddrInfo */
           A.SHIP_TO_COUNTRY
         , A.SHIP_TO_PROVINCE
         , A.SHIP_TO_CITY
         , A.SHIP_TO_ADDRESS
         , A.PREV_SHIP_TO_ADDR_YN
	  FROM TB_CUST_SHIP_TO_ADDR A
	 WHERE A.USER_ID= #LOGIN_ID#
	   AND A.VALID_YN = 'Y'
	   AND A.PREV_SHIP_TO_ADDR_YN = 'Y'
	 ORDER BY INSERT_DT DESC
	 LIMIT 1
	</select>
	
	<!-- TB_CUSTOMER_PO_HEADER PO_NO 발번 -->
	<select id="shop.getPoNo" parameterClass="Map" resultClass="java.lang.String">
		SELECT /* ShopProduct.xml  shop.getPoNo */
				   CONCAT('CPO', DATE_FORMAT(now(), '%y%m%d'),
			              IFNULL((SELECT 
			                            LPAD(MAX(SUBSTR(PO_NO, 10, 5))+1, 5, '0') AS SERIAL_NO
			                        FROM
			                            TB_CUSTOMER_PO_HEADER), '00001')) AS PO_NO
		      FROM DUAL
	</select>
	
	<!-- TB_CUSTOMER_PO_HEADER 등록 -->
	<insert id="shop.insertCustomerPoHeader" parameterClass="Map">
	INSERT /* ShopProduct.xml  shop.insertCustomerPoHeader */
	  INTO TB_CUSTOMER_PO_HEADER
		(
		   PO_NO
		 , CUSTOMER_ID
         , PARTNER_BIZ_ENTITY_ID
         , PHONE_COUNTRY_NO
         , PHONE_NO
         , PAYMENT_TERMS
         , SUPPLY_COUNTRY
         , SUPPLY_CURRENCY
         , CURRENCY
         , BASIC_EXT_RATE
         , BIZ_EXT_RATE
         , TOT_PO_AMT
         , DEP_CLOSE_YN
		 , INSERT_USER_ID
		 , INSERT_DT)
		VALUES
		(
		   #PO_NO#
		 , #CUSTOMER_ID#
         , #PARTNER_BIZ_ENTITY_ID#
         , #PHONE_COUNTRY_NO#
         , #PHONE_NO#
         , #PAYMENT_TERMS#
         , #SUPPLY_COUNTRY#
         , #SUPPLY_CURRENCY#
         , #CURRENCY#
         , #BASIC_EXT_RATE#
         , #BIZ_EXT_RATE#
         , #TOT_PO_AMT#
         , #DEP_CLOSE_YN#
		 , #LOGIN_ID#
		 , DATE_FORMAT(now(), '%Y%m%d%H%i%s')
		)
	</insert>
	
	<!-- TB_CUSTOMER_PO_DETAIL 등록 -->
	<insert id="shop.insertCustomerPoDetail" parameterClass="Map">
	INSERT /* ShopProduct.xml  shop.insertCustomerPoDetail */
	  INTO TB_CUSTOMER_PO_DETAIL
		(
		   PO_NO
		 , SEQ
         , PHONE_NO
         , SELLER_BIZ_ENTITY_ID
		 , ORG_PRICE
		 , UNIT_PRICE
		 , PO_AMT
		 , PO_QTY
		 , INSERT_USER_ID
		 , INSERT_DT)
		VALUES
		(
		   #PO_NO#
		 , #SEQ#
         , #PHONE_NO#
         , #SELLER_BIZ_ENTITY_ID#
		 , #ORG_PRICE#
		 , #UNIT_PRICE#
		 , #PO_AMT#
		 , #PO_QTY#
		 , #LOGIN_ID#
		 , DATE_FORMAT(now(), '%Y%m%d%H%i%s')
		)
	</insert>
	
	<!-- TB_CUSTOMER_PO_SHIP_TO_ADDRESS 등록 -->
	<insert id="shop.insertCustomerPoShipToAddress" parameterClass="Map">
	INSERT /* ShopProduct.xml  shop.insertCustomerPoShipToAddress */
	  INTO TB_CUSTOMER_PO_SHIP_TO_ADDRESS
		(
		   PO_NO
		 , SHIP_TO_COUNTRY
		 , SHIP_TO_PROVINCE
		 , SHIP_TO_CITY
		 , SHIP_TO_ADDRESS
		 , PHONE_COUNTRY_NO
		 , PHONE_NO
		 , INSERT_USER_ID
		 , INSERT_DT)
		VALUES
		(
		   #PO_NO#
		 , #SHIP_TO_COUNTRY#
		 , #SHIP_TO_PROVINCE#
		 , #SHIP_TO_CITY#
		 , #SHIP_TO_ADDRESS#
		 , #PHONE_COUNTRY_NO#
		 , #PHONE_NO#
		 , #LOGIN_ID#
		 , DATE_FORMAT(now(), '%Y%m%d%H%i%s')
		)
	</insert>
	
	<update id="shop.updatePrevAll_N" parameterClass="Map">
	UPDATE /* ShopProduct.xml  shop.updatePrevAll_N */
	       TB_CUST_SHIP_TO_ADDR
	   SET PREV_SHIP_TO_ADDR_YN   = 'N'
	 WHERE USER_ID                = #LOGIN_ID#
	</update>
	
	<update id="shop.updatePrev_Y" parameterClass="Map">
	UPDATE /* ShopProduct.xml  shop.updatePrev_Y */
	       TB_CUST_SHIP_TO_ADDR
	   SET PREV_SHIP_TO_ADDR_YN   = 'Y'
	     , UPDATE_USER_ID         = #LOGIN_ID#
	     , UPDATE_DT              = DATE_FORMAT(now(), '%Y%m%d%H%i%s')
	 WHERE USER_ID                = #LOGIN_ID#
	   AND SEQ                    = #SHIP_TO_SEQ#
	</update>
</sqlMap>