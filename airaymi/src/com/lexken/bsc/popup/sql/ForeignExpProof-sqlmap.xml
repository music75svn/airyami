<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bsc.popup.foreignExpProof">

	<!--
	==================================================================
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	:
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />

	<!--
	==================================================================
	  # 설명	: 시스템 연계항목 정보를 가져옴
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getItem" remapResults="true" parameterClass="hashMap" resultClass="hashMap">
          SELECT A.ITEM_CD, B.CAL_TYPE_COL_NM
            FROM BSC_SYSTEM_ITEM A
               , BSC_CAL_TYPE_COL B
           WHERE A.YEAR = #findYear#
             AND A.YEAR = B.YEAR
             AND A.ITEM_CD = B.ITEM_CD
             AND B.METRIC_ID = #findMetricId#
             AND B.INSERT_GUBUN = '01'
           ORDER BY B.CAL_TYPE_COL_NM
	</select>

	<!--
	==================================================================
	  # 설명	: 시스템 연계 부서 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getScDeptMapping" parameterClass="hashMap" resultClass="java.lang.String">
		SELECT DEPT_ID
		  FROM ( SELECT DEPT_ID
				   FROM BSC_SC_DEPT_MAPPING
				  WHERE YEAR = #findYear#
				    AND SC_DEPT_ID = #findScDeptCd# ORDER BY DEPT_ID )
		 WHERE ROWNUM = 1
	</select>

	<!--
	==================================================================
	  # 설명	: 시스템 연계 부서 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getDeptInfo" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_ID, B.DEPT_NM
		  FROM BSC_SC_DEPT_MAPPING A
	LEFT OUTER JOIN BSC_DEPTINFO B
			ON A.DEPT_ID = B.DEPT_ID
		 WHERE (YEAR, SC_DEPT_ID) IN
		          (SELECT YEAR, SC_DEPT_ID
		             FROM BSC_METRIC
		            WHERE (METRIC_GRP_ID, YEAR) IN
		                     (SELECT METRIC_GRP_ID, YEAR
		                        FROM BSC_METRIC
		                       WHERE YEAR = #findYear# AND METRIC_ID = #findMetricId#)
		            AND DELETE_DT IS NULL)

	</select>

	<!--
	==================================================================
	  # 설명	: 해외 방폭 인증 매출액 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: SAORA01.GBD0802D
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		 SELECT SUM(CUM_REQ_QTY) AS CUM_REQ_QTY          <!-- 누계-신규 - 신청수량 -->
              , SUM(CUM_REQ_AMT) AS CUM_REQ_AMT         <!-- 누계-신규 - 신청금액 -->
              , SUM(CUM_INSP_QTY) AS CUM_INSP_QTY    <!-- 누계-신규 - 검사수량 -->
              , SUM(CUM_PASS_QTY) AS CUM_PASS_QTY    <!-- 누계-신규 - 합격수량 -->
              , SUM(CUM_UNPASS_QTY) AS CUM_UNPASS_QTY     <!-- 누계-신규 - 불합격수량  -->
              , SUM(CUM_UNINSP_QTY) AS CUM_UNINSP_QTY  <!-- 누계-신규 - 검사불능수량 -->
              , SUM(CUM_DIF_QTY) AS CUM_DIF_QTY     <!-- 누계-신규 - 잔량 -->
		   FROM (SELECT (SELECT X.COMM_C
                FROM MAORA01.MDA0000M X
               WHERE B.UP_SER = X.SER
             )                                      AS RPT_TC,        
             (SELECT X.COMM_C_NM
                FROM MAORA01.MDA0000M X
               WHERE B.UP_SER = X.SER
             )                                      AS RPT_TC_NM,    
             A.ROLE_TC,
             C.ROLE_TC_NM,
             A.INSP_KIND_TC,
             C.INSP_KIND_TC_NM,
             A.LAW_TC,
             C.LAW_TC_NM,
             A.STIC_LAG_TC,
             C.STIC_LAG_TC_NM,
             A.STIC_MID_TC,
             C.STIC_MID_TC_NM,
             A.STIC_SML_TC,
             C.STIC_SML_TC_NM,
             SUM(A.REQ_QTY)                         AS REQ_QTY,            
             SUM(A.REQ_AMT)                         AS REQ_AMT,             
             SUM(A.INSP_QTY)                        AS INSP_QTY,           
             SUM(A.PASS_QTY)                        AS PASS_QTY,            
             SUM(A.UNPASS_QTY)                      AS UNPASS_QTY,          
             SUM(A.UNINSP_QTY)                      AS UNINSP_QTY,          
             SUM(A.RE_REQ_QTY)                      AS RE_REQ_QTY,          
             SUM(A.RE_REQ_AMT)                      AS RE_REQ_AMT,          
             SUM(A.RE_INSP_QTY)                     AS RE_INSP_QTY,          
             SUM(A.RE_PASS_QTY)                     AS RE_PASS_QTY,        
             SUM(A.RE_UNPASS_QTY)                   AS RE_UNPASS_QTY,        
             SUM(A.RE_UNINSP_QTY)                   AS RE_UNINSP_QTY,        
             SUM(A.CUM_REQ_QTY)                     AS CUM_REQ_QTY,         
             SUM(A.CUM_REQ_AMT)                     AS CUM_REQ_AMT,        
             SUM(A.CUM_INSP_QTY)                    AS CUM_INSP_QTY,       
             SUM(A.CUM_PASS_QTY)                    AS CUM_PASS_QTY,       
             SUM(A.CUM_UNPASS_QTY)                  AS CUM_UNPASS_QTY,     
             SUM(A.CUM_UNINSP_QTY)                  AS CUM_UNINSP_QTY,    
             SUM(A.CUM_DIF_QTY)                     AS CUM_DIF_QTY,         
             SUM(A.CUM_RE_REQ_QTY)                  AS CUM_RE_REQ_QTY,     
             SUM(A.CUM_RE_REQ_AMT)                  AS CUM_RE_REQ_AMT,      
             SUM(A.CUM_RE_INSP_QTY)                 AS CUM_RE_INSP_QTY,    
             SUM(A.CUM_RE_PASS_QTY)                 AS CUM_RE_PASS_QTY,     
             SUM(A.CUM_RE_UNPASS_QTY)               AS CUM_RE_UNPASS_QTY,   
             SUM(A.CUM_RE_UNINSP_QTY)               AS CUM_RE_UNINSP_QTY,   
             SUM(A.CUM_DIF_RE_QTY)                  AS CUM_DIF_RE_QTY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        FROM (
              SELECT 
                      case when role_tc = '23' and insp_kind_tc = '02' and br_cd = '2400' then br_cd
                          when role_tc = '23' and insp_kind_tc = '02' and br_cd <![CDATA[ <> ]]> '2400' then '1D00'
                          when role_tc = '23' and insp_kind_tc = '01' then '1D00'
                          when role_tc = '31' and insp_kind_tc = '03' then '5100'
                          when role_tc = '31' and insp_kind_tc = '05' and stic_lag_tc in ('49','B5') then '9100'
                          when role_tc = '31' and insp_kind_tc = '05' and stic_lag_tc not in ('49','B5') then '5100'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc = '40' then '5100'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '40' and br_cd = '1400' then '8300'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd in ('6300','6400','6500') then '6200'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd = '6700' then '6600'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd = '7100' then '6800'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd = '9000' then '8900'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc <![CDATA[ <> ]]> '45' then '5100'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd = '1400' then '8300'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd in ('6300','6400','6500') then '6200'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd = '6700' then '6600'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd = '9000' then '8900'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '1400' then '8300'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6300' then '6200'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6400' then '6200'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6500' then '6200'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6700' then '6600'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '7100' then '6800'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '9000' then '8900'
                          when role_tc = '32' and insp_kind_tc <![CDATA[ <> ]]> '08' then '5100'
                          when role_tc = '92' then '1400'
                     else br_cd end as BR_CD,
                     ROLE_TC,
                     INSP_KIND_TC,
                     LAW_TC,
                     STIC_LAG_TC,
                     STIC_MID_TC,
                     STIC_SML_TC,
                     0                                            AS REQ_QTY,
                     0                                            AS REQ_AMT,
                     0                                            AS INSP_QTY,
                     0                                            AS PASS_QTY,
                     0                                            AS UNPASS_QTY,
                     0                                            AS UNINSP_QTY,
                     0                                            AS RE_REQ_QTY,
                     0                                            AS RE_REQ_AMT,
                     0                                            AS RE_INSP_QTY,
                     0                                            AS RE_PASS_QTY,
                     0                                            AS RE_UNPASS_QTY,
                     0                                            AS RE_UNINSP_QTY,
                     SUM(NVL(REQ_QTY,0))                          AS CUM_REQ_QTY,
                     SUM(NVL(REQ_AMT,0))                          AS CUM_REQ_AMT,
                     SUM(NVL(INSP_QTY,0))                         AS CUM_INSP_QTY,
                     SUM(NVL(PASS_QTY,0))                         AS CUM_PASS_QTY,
                     SUM(NVL(UNPASS_QTY,0))                       AS CUM_UNPASS_QTY,
                     SUM(NVL(UNINSP_QTY,0))                       AS CUM_UNINSP_QTY,
                     SUM(NVL(RE_REQ_QTY,0))                       AS CUM_RE_REQ_QTY,
                     SUM(NVL(RE_REQ_AMT,0))                       AS CUM_RE_REQ_AMT,
                     SUM(NVL(RE_INSP_QTY,0))                      AS CUM_RE_INSP_QTY,
                     SUM(NVL(RE_PASS_QTY,0))                      AS CUM_RE_PASS_QTY,
                     SUM(NVL(RE_UNPASS_QTY,0))                    AS CUM_RE_UNPASS_QTY,
                     SUM(NVL(RE_UNINSP_QTY,0))                    AS CUM_RE_UNINSP_QTY,
                     SUM(NVL(REQ_QTY,0)-NVL(INSP_QTY,0))          AS CUM_DIF_QTY,
                     SUM(NVL(RE_REQ_QTY,0)-NVL(RE_INSP_QTY,0))    AS CUM_DIF_RE_QTY
                FROM SAORA01.GHF0221D
               WHERE BR_CD <![CDATA[ <> ]]> '0000'
                 AND SUMM_YY     = #findYear#      
                 AND SUMM_MM <![CDATA[<=]]> #findMon#        
                 AND ROLE_TC <![CDATA[ <> ]]> '93'
                 AND BR_CD = '3G00'   
               GROUP BY
                      case when role_tc = '23' and insp_kind_tc = '02' and br_cd = '2400' then br_cd
                          when role_tc = '23' and insp_kind_tc = '02' and br_cd <![CDATA[ <> ]]> '2400' then '1D00'
                          when role_tc = '23' and insp_kind_tc = '01' then '1D00'
                          when role_tc = '31' and insp_kind_tc = '03' then '5100'
                           when role_tc = '31' and insp_kind_tc = '05' and stic_lag_tc in ('49','B5') then '9100'
                          when role_tc = '31' and insp_kind_tc = '05' and stic_lag_tc not in ('49','B5') then '5100'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc = '40' then '5100'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '40' and br_cd = '1400' then '8300'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd in ('6300','6400','6500') then '6200'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd = '6700' then '6600'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd = '7100' then '6800'
                          when role_tc = '31' and insp_kind_tc = '02' and stic_lag_tc <![CDATA[ <> ]]> '20' and br_cd = '9000' then '8900'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc <![CDATA[ <> ]]> '45' then '5100'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd = '1400' then '8300'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd in ('6300','6400','6500') then '6200'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd = '6700' then '6600'
                          when role_tc = '31' and insp_kind_tc = '07' and stic_lag_tc =  '45' and br_cd = '9000' then '8900'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '1400' then '8300'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6300' then '6200'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6400' then '6200'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6500' then '6200'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '6700' then '6600'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '7100' then '6800'
                          when role_tc = '31' and insp_kind_tc = '08' and br_cd = '9000' then '8900'
                          when role_tc = '32' and insp_kind_tc <![CDATA[ <> ]]> '08' then '5100'
                          when role_tc = '92' then '1400'
                     else br_cd end ,
                     ROLE_TC,
                     INSP_KIND_TC,
                     LAW_TC,
                     STIC_LAG_TC,
                     STIC_MID_TC,
                     STIC_SML_TC
               UNION ALL
              SELECT 
                     BR_CD,
                     ROLE_TC,
                     INSP_KIND_TC,
                     LAW_TC,
                     STIC_LAG_TC,
                     STIC_MID_TC,
                     STIC_SML_TC,
                     0                                            AS REQ_QTY,
                     0                                            AS REQ_AMT,
                     0                                            AS INSP_QTY,
                     0                                            AS PASS_QTY,
                     0                                            AS UNPASS_QTY,
                     0                                            AS UNINSP_QTY,
                     0                                            AS RE_REQ_QTY,
                     0                                            AS RE_REQ_AMT,
                     0                                            AS RE_INSP_QTY,
                     0                                            AS RE_PASS_QTY,
                     0                                            AS RE_UNPASS_QTY,
                     0                                            AS RE_UNINSP_QTY,
                     SUM(NVL(REQ_QTY,0))                          AS CUM_REQ_QTY,
                     SUM(NVL(REQ_AMT,0))                          AS CUM_REQ_AMT,
                     SUM(NVL(INSP_QTY,0))                         AS CUM_INSP_QTY,
                     SUM(NVL(PASS_QTY,0))                         AS CUM_PASS_QTY,
                     SUM(NVL(UNPASS_QTY,0))                       AS CUM_UNPASS_QTY,
                     SUM(NVL(UNINSP_QTY,0))                       AS CUM_UNINSP_QTY,
                     SUM(NVL(RE_REQ_QTY,0))                       AS CUM_RE_REQ_QTY,
                     SUM(NVL(RE_REQ_AMT,0))                       AS CUM_RE_REQ_AMT,
                     SUM(NVL(RE_INSP_QTY,0))                      AS CUM_RE_INSP_QTY,
                     SUM(NVL(RE_PASS_QTY,0))                      AS CUM_RE_PASS_QTY,
                     SUM(NVL(RE_UNPASS_QTY,0))                    AS CUM_RE_UNPASS_QTY,
                     SUM(NVL(RE_UNINSP_QTY,0))                    AS CUM_RE_UNINSP_QTY,
                     SUM(NVL(REQ_QTY,0)-NVL(INSP_QTY,0))          AS CUM_DIF_QTY,
                     SUM(NVL(RE_REQ_QTY,0)-NVL(RE_INSP_QTY,0))    AS CUM_DIF_RE_QTY
                FROM TOORA01.TAA0106M
               WHERE BR_CD <![CDATA[ <> ]]> '0000'
                 AND SUMM_YY     = #findYear#        
                 AND SUMM_MM <![CDATA[<=]]> #findMon#        
                 AND ROLE_TC <![CDATA[ <> ]]> '93'      
                 AND BR_CD = '3G00'   
               GROUP BY
                     br_cd,
                     ROLE_TC,
                     INSP_KIND_TC,
                     LAW_TC,
                     STIC_LAG_TC,
                     STIC_MID_TC,
                     STIC_SML_TC
               UNION ALL
              SELECT 
                     K.CHNG_BR_CD AS BR_CD, 
                     K.ROLE_TC,
                     K.INSP_KIND_TC,
                     K.LAW_TC,
                     K.STIC_LAG_TC,
                     K.STIC_MID_TC,
                     K.STIC_SML_TC,
                     0                                              AS REQ_QTY,
                     0                                              AS REQ_AMT,
                     0                                              AS INSP_QTY,
                     0                                              AS PASS_QTY,
                     0                                              AS UNPASS_QTY,
                     0                                              AS UNINSP_QTY,
                     0                                              AS RE_REQ_QTY,
                     0                                              AS RE_REQ_AMT,
                     0                                              AS RE_INSP_QTY,
                     0                                              AS RE_PASS_QTY,
                     0                                              AS RE_UNPASS_QTY,
                     0                                              AS RE_UNINSP_QTY,
                     SUM(CASE WHEN K.CHNG_TC = 'F' THEN K.REQ_QTY*-1 ELSE K.REQ_QTY END) AS CUM_REQ_QTY,
                     SUM(CASE WHEN K.ROLE_TC = '02' AND K.CHNG_TC = 'F' THEN -0.7*K.COMS 
                              WHEN K.ROLE_TC = '02' AND K.CHNG_TC = 'T' THEN 0.7*K.COMS
                              WHEN K.ROLE_TC IN ('01','04','05','13','14','15') AND K.CHNG_TC = 'F' THEN -1*K.COMS
                              ELSE 1*K.COMS END) AS CUM_REQ_AMT,
                     0                                            AS CUM_INSP_QTY,
                     0                                            AS CUM_PASS_QTY,
                     0                                            AS CUM_UNPASS_QTY,
                     0                                            AS CUM_UNINSP_QTY,
                     0                                            AS CUM_RE_REQ_QTY,
                     0                                            AS CUM_RE_REQ_AMT,
                     0                                            AS CUM_RE_INSP_QTY,
                     0                                            AS CUM_RE_PASS_QTY,
                     0                                            AS CUM_RE_UNPASS_QTY,
                     0                                            AS CUM_RE_UNINSP_QTY,
                     0                                            AS CUM_DIF_QTY,
                     0                                            AS CUM_DIF_RE_QTY
                FROM SAORA01.GAA0102D K
               WHERE K.CHNG_DATE BETWEEN #findYear#||'0101' AND #findYear#||#findMon#||'31'       
                 AND K.CHNG_TC IN ('F', 'T')
                 AND K.ROLE_TC IN ('01','02','04','05','14','15','13')
                 AND K.ROLE_TC <![CDATA[ <> ]]> '93'
                 AND NOT EXISTS (SELECT 1 FROM SAORA01.GAA0102D X
                              WHERE X.YY = K.YY
                                AND X.RCPT_NO = K.RCPT_NO
                                AND X.ROLE_TC IN ('01','02','04','05','14','15','13')
                                AND X.CHNG_TC = 'T'
                                AND X.CHNG_DATE BETWEEN #findYear#||'0101' AND #findYear#||#findMon#||'31'
                                AND X.CHNG_BR_CD = '1300')
                 AND K.CHNG_BR_CD like '3G00'
               GROUP BY
                     K.CHNG_BR_CD,
                     K.ROLE_TC,
                     K.INSP_KIND_TC,
                     K.LAW_TC,
                     K.STIC_LAG_TC,
                     K.STIC_MID_TC,
                     K.STIC_SML_TC
           ) A,
           MAORA01.MDA0000M B,
          (
           SELECT DISTINCT
                  ROLE_TC,
                  ROLE_TC_NM,
                  INSP_KIND_TC,
                  INSP_KIND_TC_NM,
                  LAW_TC,
                  LAW_TC_NM,
                  STIC_LAG_TC,
                  STIC_LAG_TC_NM,
                  STIC_MID_TC,
                  STIC_MID_TC_NM,
                  STIC_SML_TC,
                  STIC_SML_TC_NM
             FROM SAORA01.GIB0100M_MV_01
            WHERE (ROLE_TC, INSP_KIND_TC, LAW_TC, STIC_LAG_TC, STIC_MID_TC) 
                   NOT IN (SELECT ROLE_TC, INSP_KIND_TC, LAW_TC, STIC_LAG_TC, STIC_MID_TC
                             FROM SAORA01.GIB0100M_MV_01
                            WHERE ROLE_TC = '10'
                              AND INSP_KIND_TC = '01'
                              AND LAW_TC = 'N'
                              AND STIC_LAG_TC = '36'
                              AND STIC_MID_TC IN ('05','10','15','20','30')
                           ) 
           ) C
       WHERE B.SYS_TC = 'TAA'
         AND B.KIND_TC = '1050'
         AND B.LEVL = 2
         AND A.ROLE_TC = B.COMM_C
         AND A.ROLE_TC      = C.ROLE_TC
         AND A.INSP_KIND_TC = C.INSP_KIND_TC
         AND A.LAW_TC       = C.LAW_TC
         AND A.STIC_LAG_TC  = C.STIC_LAG_TC
         AND A.STIC_MID_TC  = C.STIC_MID_TC
         AND A.STIC_SML_TC  = C.STIC_SML_TC
       GROUP BY
             B.UP_SER,
             A.ROLE_TC,
             C.ROLE_TC_NM,
             A.INSP_KIND_TC,
             C.INSP_KIND_TC_NM,
             A.LAW_TC,
             C.LAW_TC_NM,
             A.STIC_LAG_TC,
             C.STIC_LAG_TC_NM,
             A.STIC_MID_TC,
             C.STIC_MID_TC_NM,
             A.STIC_SML_TC,
             C.STIC_SML_TC_NM
             ) WHERE ROLE_TC = '12'

	</select>

</sqlMap>


