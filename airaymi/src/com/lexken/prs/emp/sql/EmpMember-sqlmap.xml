<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.emp.empMember">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: PRS_EVAL_GRP
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 
	<!--
	==================================================================   
	  # 설명	: 최상위 평가조직 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getTopDeptInfo" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
			 , DEPT_CD
			 , DEPT_KOR_NM
		  FROM ( SELECT YEAR, DEPT_CD, DEPT_KOR_NM FROM BSC_INSA_DEPT WHERE YEAR = #findYear# ORDER BY DISP_ORDER, DEPT_CD )
		WHERE DEPT_CD = '0000'
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 인사조직 왼쪽트리목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA_DEPT
	==================================================================
	-->
	<select id="getDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
			 , DEPT_CD
			 , DEPT_KOR_NM
			 , UP_DEPT_CD
			 , UP_USER_ID
			 , USE_YN
			 , DEPT_LEVL
			 , DISP_ORDER
		  FROM BSC_INSA_DEPT
		 WHERE YEAR = #findYear#
		   AND ( DEPT_CD > '1025'
		   		 OR DEPT_CD = '0000'
   		   		 OR DEPT_CD = '1000' )
<![CDATA[
   		   AND DEPT_CD <> '1090'
]]>	
		 ORDER BY DEPT_CD, DISP_ORDER      
		 
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_MNG_MEMBER
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR
			 , A.EMPN
			 , A.KOR_NM
			 , A.DEPT_CD
			 , D.DEPT_KOR_NM
             , F_DEPT_FULL_NM(A.YEAR, A.DEPT_CD, 'BSC_INSA_DEPT') DEPT_FULL_NM
			 , A.CAST_TC
			 , B.CODE_NM AS CAST_TC_NM
			 , A.POS_TC
			 , C.CODE_NM AS POS_TC_NM
			 , A.EVAL_YN
          FROM PRS_EMP_MEMBER A
          LEFT OUTER JOIN BSC_CODE B
                       ON A.YEAR = B.YEAR
                      AND B.CODE_GRP_ID = '170'
                      AND B.CODE_ID = A.CAST_TC
          LEFT OUTER JOIN BSC_CODE C
                       ON A.YEAR = C.YEAR
                      AND C.CODE_GRP_ID = '171'
                      AND C.CODE_ID = A.POS_TC
		  LEFT OUTER JOIN BSC_INSA_DEPT D
            		   ON A.YEAR = D.YEAR
           AND A.DEPT_CD = D.DEPT_CD
         WHERE A.YEAR=#findYear#
           AND A.DEPT_CD IN (SELECT DEPT_CD
							   FROM BSC_INSA_DEPT
							  WHERE YEAR = #findYear#
						 START WITH DEPT_CD = #findDeptCd#
				   CONNECT BY PRIOR YEAR = YEAR
								AND PRIOR DEPT_CD = UP_DEPT_CD)
			<isNotEmpty prepend="AND" property="findYear">
	            A.YEAR = #findYear#
		   	</isNotEmpty>
		   	<isNotEmpty prepend="AND" property="findCastTc">
		   		A.CAST_TC = #findCastTc#
		   	</isNotEmpty>
		   	<isNotEmpty prepend="AND" property="findKorNm">
		   		UPPER(A.KOR_NM) LIKE  '%' || TRIM(UPPER(#findKorNm#)) ||'%'   
		   	</isNotEmpty>
          ORDER BY A.DEPT_CD, A.EMPN  
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 파라미터 맵
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->
	<parameterMap id="paramMap" class="java.util.HashMap">
		<parameter property="year" 			jdbcType="VARCHAR"  javaType="java.lang.String" mode="IN"/>
	</parameterMap>	
	
	
	
	<!--
	==================================================================   
	  # 설명	: 데이터집계관리 프로시저 호출
	  #	기능	: CALL PROCEDURE
	  #	TABLE	: 
	==================================================================
	-->	
	<procedure id="callSpPrsEmpMemberProc"  parameterMap="paramMap">
		{CALL  SP_PRS_EMP_MEMBER(? )} 
	</procedure>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자 선정 수정
	  #	기능	: UPDATE
	  #	TABLE	: PRS_MNG_MEMBER
	==================================================================
	-->	
	<update id="updateEmpMemberData" parameterClass="hashMap">
		UPDATE PRS_EMP_MEMBER
	   	   SET EVAL_YN = #evalYn#
		 WHERE EMPN = #empn#
		   AND YEAR = #findYear#		
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 권한 삭제
	  #	기능	: DELETE
	  #	TABLE	: BSC_ADMIN
	==================================================================
	-->	
	<update id="deleteAdminDatas" parameterClass="hashMap">
		DELETE FROM BSC_ADMIN
         WHERE ADMIN_GUBUN='30'
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 권한 등록
	  #	기능	: INSERT
	  #	TABLE	: BSC_ADMIN
	==================================================================
	-->	
	<insert id="insertAdminDatas" parameterClass="hashMap">
		INSERT INTO BSC_ADMIN (ADMIN_GUBUN, USER_ID)
			SELECT '30', A.EMPN 
              FROM (SELECT EMPN
                      FROM PRS_EMP_MEMBER A
                     WHERE EVAL_YN = 'Y' 
                       AND YEAR = #findYear#
                    ) A 
	</insert>
		
</sqlMap>
