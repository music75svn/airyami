<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="shopProduct">

<typeAlias alias="ValueMap" type="egovframework.airyami.cmm.util.ValueMap"/>
	
	<select id="shopProduct.getPrNo" parameterClass="Map" resultClass="java.lang.String">
		SELECT /* ShopProduct.xml  shopProduct.getPrNo */
				   CONCAT('CPR', DATE_FORMAT(now(), '%y%m%d'),
			              IFNULL((SELECT 
			                            LPAD(MAX(SUBSTR(PR_NO, 10, 5))+1, 5, '0') AS SERIAL_NO
			                        FROM
			                            TB_CUSTOMER_PR), '00001')) AS PR_NO
		      FROM DUAL
	</select>
	
	<insert id="shopProduct.insertCart" parameterClass="Map">
	INSERT /* ShopProduct.xml  shopProduct.insertCart */
	  INTO TB_CUSTOMER_PR
		(
		   PR_NO
		 , CUSTOMER_ID
         , PROD_NO
         , SUPPLY_COUNTRY
         , SUPPLY_CURRENCY
         , ORG_PRICE
         , PR_QTY
		 , INSERT_USER_ID
		 , INSERT_DT)
		VALUES
		(
		   #PR_NO#
		 , #LOGIN_ID#
         , #PROD_NO#
         , #SUPPLY_COUNTRY#
         , #SUPPLY_CURRENCY#
         , #ORG_PRICE#
         , #PR_QTY#
		 , #LOGIN_ID#
		 , DATE_FORMAT(now(), '%Y%m%d%H%i%s')
		)
	</insert>
	
	<select id="shop.getShopCartCount" parameterClass="Map" resultClass="java.lang.Integer">
	SELECT /* ShopProduct.xml  shop.getShopCartCount */
	       COUNT(1) 
	  FROM TB_CUSTOMER_PR A
	     , TB_PRODUCT_NAME B
	 WHERE 1 = 1
	   AND A.CUSTOMER_ID = #LOGIN_ID#
	   AND A.PROD_NO = B.PROD_NO
	   AND B.LANG_CD = #LANG_CD#
	</select>
	
	<select id="shop.getShopCartList" parameterClass="Map" resultClass="ValueMap" remapResults="true">
	<isEqual property="EXCEL_YN" compareValue="N">
	<include refid="pagingPrefixSQL"/>
	</isEqual>
	SELECT /* ShopProduct.xml  shop.getShopCartList */
           A.PR_NO
         , A.PROD_NO
         , B.PROD_NM
         , A.ORG_PRICE
         , A.PR_QTY
         , DATE_FORMAT(str_to_date(A.INSERT_DT, '%Y%m%d'), '%Y-%m-%d') AS INSERT_DT
	  FROM TB_CUSTOMER_PR A
	     , TB_PRODUCT_NAME B
	 WHERE 1 = 1
	   AND A.CUSTOMER_ID = #LOGIN_ID#
	   AND A.PROD_NO = B.PROD_NO
	   AND B.LANG_CD = #LANG_CD#
	 <isNotEmpty property="SORT_COL">
	 	<include refid="orderbySQL"/>
	 </isNotEmpty>
	 <isEmpty property="SORT_COL">
	 ORDER BY A.INSERT_DT DESC
	 </isEmpty>
	<isEqual property="EXCEL_YN" compareValue="N">
	<include refid="pagingSuffixSQL"/>
	</isEqual>
	</select>
</sqlMap>