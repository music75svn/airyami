<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="str.base.subject">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 세부과제 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: STR_SUBJECT
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT SJ.YEAR, SJ.STRAT_SUBJECT_ID, ST.STRAT_SUBJECT_NM, SJ.STRAT_DIRECT_ID, SD.STRAT_DIRECT_NM
             , SJ.SUBJECT_ID, SJ.SUBJECT_NM, SJ.SUBJECT_TARGET
             , SJ.CHARGE_DEPT_ID, DP.DEPT_NM AS CHARGE_DEPT_NM, SJ.CHARGE_USER_ID, RU.USER_NM AS CHARGE_USER_NM
             , NVL(SM.SUBJECT_METRIC_CNT, 0) AS SUBJECT_METRIC_CNT
          FROM 
            (SELECT YEAR, STRAT_SUBJECT_ID, STRAT_DIRECT_ID, SUBJECT_ID, SUBJECT_NM
                  , SUBJECT_TARGET, CHARGE_DEPT_ID, CHARGE_USER_ID, SORT_ORDER
              FROM STR_SUBJECT
             WHERE 1=1
               AND YEAR = #findYear#
               <isNotEmpty property="findStratSubjectId">
               AND STRAT_SUBJECT_ID = #findStratSubjectId#
               </isNotEmpty>
            ) SJ
            LEFT OUTER JOIN 
            STR_STRAT_SUBJECT ST
            ON SJ.YEAR = ST.YEAR
           AND SJ.STRAT_SUBJECT_ID = ST.STRAT_SUBJECT_ID
            LEFT OUTER JOIN 
            STR_STRAT_DIRECT SD
            ON SJ.YEAR = SD.YEAR
           AND SJ.STRAT_DIRECT_ID = SD.STRAT_DIRECT_ID
            LEFT OUTER JOIN 
            BSC_DEPTINFO DP
            ON SJ.CHARGE_DEPT_ID = DP.DEPT_ID
            LEFT OUTER JOIN 
            V_ROLE_USER RU
            ON SJ.CHARGE_USER_ID = RU.USER_ID
            LEFT OUTER JOIN 
            (SELECT YEAR, SUBJECT_ID, COUNT(SUBJECT_METRIC_ID) AS SUBJECT_METRIC_CNT
               FROM STR_METRIC         
              WHERE 1=1
                AND YEAR = #findYear#
              GROUP BY YEAR, SUBJECT_ID
            ) SM
            ON SJ.YEAR = SM.YEAR
           AND SJ.SUBJECT_ID = SM.SUBJECT_ID
         ORDER BY ST.SORT_ORDER, SJ.SORT_ORDER
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 조회조건(전략과제) 목록
	  #	기능	: SELECT
	  #	TABLE	: STR_STRAT_SUBJECT
	==================================================================
	-->
	<select id="getStratSubjectSearchList" parameterClass="hashMap" resultClass="hashMap">
		SELECT STRAT_SUBJECT_ID, STRAT_SUBJECT_NM
		  FROM STR_STRAT_SUBJECT
		 WHERE 1=1
		   AND YEAR = #findYear#
		 ORDER BY SORT_ORDER, STRAT_SUBJECT_ID      
	</select>	
	
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: STR_SUBJECT
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT SJ.YEAR, SJ.STRAT_SUBJECT_ID, ST.STRAT_SUBJECT_NM, SJ.STRAT_DIRECT_ID, SD.STRAT_DIRECT_NM
		     , SJ.SUBJECT_ID, SJ.SUBJECT_NM, SJ.SUBJECT_TARGET
		     , SJ.CHARGE_DEPT_ID, DP.DEPT_NM AS CHARGE_DEPT_NM, SJ.CHARGE_USER_ID, RU.USER_NM AS CHARGE_USER_NM
		     , SJ.YEAR_ACTUAL_PLAN, SJ.MULTY_YEAR_ACTUAL_PLAN
		     , SJ.SORT_ORDER
		     , #year# + 1 AS Y_1
		     , #year# + 5 AS Y_2
		  FROM 
		    (SELECT YEAR, STRAT_SUBJECT_ID, STRAT_DIRECT_ID, SUBJECT_ID, SUBJECT_NM
		          , SUBJECT_TARGET, CHARGE_DEPT_ID, CHARGE_USER_ID
		          , YEAR_ACTUAL_PLAN, MULTY_YEAR_ACTUAL_PLAN
		          , SORT_ORDER
		      FROM STR_SUBJECT
		     WHERE 1=1
		       AND YEAR = #year#
		       AND SUBJECT_ID = #subjectId#
		    ) SJ
		    LEFT OUTER JOIN 
		    STR_STRAT_SUBJECT ST
		    ON SJ.YEAR = ST.YEAR
		   AND SJ.STRAT_SUBJECT_ID = ST.STRAT_SUBJECT_ID
		    LEFT OUTER JOIN 
		    STR_STRAT_DIRECT SD
		    ON SJ.YEAR = SD.YEAR
		   AND SJ.STRAT_DIRECT_ID = SD.STRAT_DIRECT_ID
		    LEFT OUTER JOIN 
		    BSC_DEPTINFO DP
		    ON SJ.CHARGE_DEPT_ID = DP.DEPT_ID
		    LEFT OUTER JOIN 
		    V_ROLE_USER RU
		    ON SJ.CHARGE_USER_ID = RU.USER_ID      
	</select>
	
	
	<!--
	==================================================================   
	  # 설명	: 상세화면 입력조건(전략과제) 목록
	  #	기능	: SELECT
	  #	TABLE	: STR_STRAT_SUBJECT
	==================================================================
	-->
	<select id="getYears" parameterClass="hashMap" resultClass="hashMap">
		SELECT #year# as YEAR, #year# + 1 AS Y_1, #year# + 5 AS Y_2 
		  FROM DUAL
	</select>	
	
	<!--
	==================================================================   
	  # 설명	: 상세화면 입력조건(전략과제) 목록
	  #	기능	: SELECT
	  #	TABLE	: STR_STRAT_SUBJECT
	==================================================================
	-->
	<select id="getStratSubjectList" parameterClass="hashMap" resultClass="hashMap">
		SELECT STRAT_SUBJECT_ID, STRAT_SUBJECT_NM
		  FROM STR_STRAT_SUBJECT
		 WHERE 1=1
		   AND YEAR = #year#
		 ORDER BY SORT_ORDER, STRAT_SUBJECT_ID      
	</select>	
	
	
	
	<!--
	==================================================================   
	  # 설명	: 상세화면 입력조건(전략방향) 목록
	  #	기능	: SELECT
	  #	TABLE	: STR_STRAT_DIRECT
	==================================================================
	-->
	<select id="getStratDirectList" parameterClass="hashMap" resultClass="hashMap">
		SELECT STRAT_DIRECT_ID, STRAT_DIRECT_NM
          FROM STR_STRAT_DIRECT
         WHERE 1=1
           AND YEAR = #year#
         ORDER BY SORT_ORDER, STRAT_DIRECT_ID     
	</select>	
	
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 첨부파일 목록
	  #	기능	: SELECT
	  #	TABLE	: STR_SUBJECT_ATTACH
	==================================================================
	-->
	<select id="getAttachFileList" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR, SUBJECT_ID, SEQ, ATTACH_FILE_NM
		     , ATTACH_FILE_FNM, ATTACH_FILE_SUFFIX
		     , F_ENCRYPT(ATTACH_FILE_PATH, #encryptionCode#) ATTACH_FILE_PATH
		  FROM STR_SUBJECT_ATTACH
		 WHERE 1=1
		   AND YEAR = #year#
		   AND SUBJECT_ID = #subjectId#
		 ORDER BY SEQ
		  
	</select>	
	
	
	<!--
	==================================================================   
	  # 설명	: 세부과제코드 채번
	  #	기능	: SELECT
	  #	TABLE	: STR_SUBJECT
	==================================================================
	-->
	<select id="getSubjectId" parameterClass="hashMap" resultClass="java.lang.String">
		SELECT F_PGM_SERI('STR_SUBJECT',#year#,'','','','') SEQ FROM DUAL
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 등록
	  #	기능	: INSERT
	  #	TABLE	: STR_SUBJECT
	==================================================================
	-->	
	<insert id="insertData" parameterClass="hashMap">

		INSERT INTO  STR_SUBJECT( YEAR, SUBJECT_ID, SUBJECT_NM, STRAT_SUBJECT_ID, STRAT_DIRECT_ID
							    , SUBJECT_TARGET, CHARGE_USER_ID, CHARGE_DEPT_ID, YEAR_ACTUAL_PLAN, MULTY_YEAR_ACTUAL_PLAN
							    , SORT_ORDER, CREATE_DT
			 ) VALUES ( #year#, #subjectId#, #subjectNm#, #stratSubjectId#, #stratDirectId#
			 		  , #subjectTarget#, #chargeUserId#, #chargeDeptId#, #yearActualPlan#, #multyYearActualPlan#
			 		  , #sortOrder#, SYSDATE
			 )
	</insert>	
	
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 첨부파일 등록
	  #	기능	: INSERT
	  #	TABLE	: STR_SUBJECT_ATTACH
	==================================================================
	-->	
	<insert id="insertFileInfo" parameterClass="hashMap">
		<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
			SELECT F_PGM_SERI('STR_SUBJECT_ATTACH', #year#, #subjectId#,'','','') SEQ FROM DUAL
		</selectKey> 
		INSERT INTO STR_SUBJECT_ATTACH (
               YEAR
             , SUBJECT_ID
             , SEQ
             , ATTACH_FILE_NM
             , ATTACH_FILE_FNM
             , ATTACH_FILE_SUFFIX
             , ATTACH_FILE_PATH
             , CREATE_DT
           ) VALUES (
               #year#
             , #subjectId#
             , #SEQ#
             , #attachFileNm#
             , #attachFileFnm#
             , #attachFileSufix#
             , #attachFilePath#
             , SYSDATE
    	   )       
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 수정
	  #	기능	: UPDATE
	  #	TABLE	: STR_SUBJECT
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE STR_SUBJECT
		   SET SUBJECT_NM = #subjectNm#
		     , STRAT_SUBJECT_ID = #stratSubjectId#
		     , STRAT_DIRECT_ID = #stratDirectId#
		     , SUBJECT_TARGET = #subjectTarget#
		     , CHARGE_USER_ID = #chargeUserId#
		     , CHARGE_DEPT_ID = #chargeDeptId#
		     , YEAR_ACTUAL_PLAN = #yearActualPlan#
		     , MULTY_YEAR_ACTUAL_PLAN = #multyYearActualPlan#
		     , SORT_ORDER = #sortOrder#
		     , MODIFY_DT = SYSDATE
		 WHERE 1=1 
		   AND YEAR = #year#
		   AND SUBJECT_ID = #subjectId#
	</update>	
	

	<!--
	==================================================================   
	  # 설명	: 세부과제 삭제
	  #	기능	: UPDATE
	  #	TABLE	: STR_SUBJECT
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">
		DELETE FROM STR_SUBJECT 
		 WHERE 1=1 
		   AND YEAR = #year#
		   AND SUBJECT_ID = #subjectId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 전체 첨부파일 삭제
	  #	기능	: UPDATE
	  #	TABLE	: STR_SUBJECT_ATTACH
	==================================================================
	-->
	<update id="deleteAllAttachFile" parameterClass="hashMap">
		DELETE FROM STR_SUBJECT_ATTACH
		 WHERE 1=1 
		   AND YEAR = #year#
		   AND SUBJECT_ID = #subjectId#
	</update>	
	
	<!--
	==================================================================   
	  # 설명	: 세부과제 첨부파일 삭제
	  #	기능	: UPDATE
	  #	TABLE	: STR_SUBJECT_ATTACH
	==================================================================
	-->
	<update id="deleteFileInfo" parameterClass="hashMap">
		DELETE FROM STR_SUBJECT_ATTACH
		 WHERE 1=1 
		   AND YEAR = #year#
		   AND SUBJECT_ID = #subjectId#
		   AND SEQ = #seq#
	</update>	
	
</sqlMap>


