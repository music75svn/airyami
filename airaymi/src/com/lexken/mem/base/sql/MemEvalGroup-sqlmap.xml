<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="mem.base.memEvalGroup">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 평가그룹 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR
             , A.EVAL_GRP_ID
             , A.EVAL_GRP_NM
             , (SELECT 
             		LISTAGG(
                    F_CODE_NM('170', CAST_TC, A.YEAR) ||
                    DECODE(YEAR_TC, '', '', 
                    	' ' || YEAR_TC || '년차 ' || F_CODE_NM('236', YEAR_TC_GUBUN, A.YEAR)) ||
                    	DECODE(APPLY_DT, '', '', '(' || TO_CHAR(TO_DATE(APPLY_DT, 'YYYYMMDD'), 'YYYY.MM.DD') || ' 기준)')
                    , ', ') WITHIN GROUP (ORDER BY EVAL_GRP_TRG_SEQ)
             	FROM MEM_EVAL_GRP_TARGET
               WHERE YEAR=#findYear#
                 AND EVAL_GRP_ID = A.EVAL_GRP_ID) AS EVAL_GRP_TARGET_LIST
             , A.SORT_ORDER
          FROM MEM_EVAL_GRP A
         WHERE A.YEAR=#findYear#
           AND DELETE_DT IS NULL
          ORDER BY A.SORT_ORDER
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가그룹 정렬순서 일괄 저장
	  #	기능	: UPDATE
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->	
	<update id="allSaveData" parameterClass="hashMap">
		UPDATE MEM_EVAL_GRP 
		   SET SORT_ORDER             = #sortOrder# 
			 , MODIFY_DT              = SYSDATE 
		 WHERE YEAR = #year#
		   AND EVAL_GRP_ID = #evalGrpId#		
	</update>	
	
	<!--
	==================================================================   
	  # 설명	: 평가그룹 삭제
	  #	기능	: UPDATE
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">
		UPDATE MEM_EVAL_GRP 
		   SET DELETE_DT      = SYSDATE 
		 WHERE YEAR = #year#
		   AND EVAL_GRP_ID = #evalGrpId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 평가그룹 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR                  
			 , EVAL_GRP_ID           
			 , EVAL_GRP_NM           
			 , SORT_ORDER            
			 , CASE WHEN DELETE_DT IS NULL THEN 'Y' ELSE 'N' END AS USE_YN     
		  FROM MEM_EVAL_GRP 
		 WHERE YEAR = #year#
		   AND EVAL_GRP_ID = #evalGrpId#	      
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가그룹대상 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<select id="getTargetList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR
             , A.EVAL_GRP_ID
             , A.EVAL_GRP_TRG_SEQ
             , A.CAST_TC
             , A.POS_TC
             , A.YEAR_TC
             , A.YEAR_TC_GUBUN
             , TO_CHAR(TO_DATE(A.APPLY_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS APPLY_DT
          FROM MEM_EVAL_GRP_TARGET A
         WHERE A.YEAR = #year#
           AND EVAL_GRP_ID = #evalGrpId#
         ORDER BY A.EVAL_GRP_TRG_SEQ
	</select>

	<!--
	==================================================================   
	  # 설명	: 평가그룹 수정
	  #	기능	: UPDATE
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE MEM_EVAL_GRP 
		   SET EVAL_GRP_NM = #evalGrpNm#
		     , SORT_ORDER = #sortOrder#
		     , MODIFY_DT      = SYSDATE 
		 WHERE YEAR = #year#
		   AND EVAL_GRP_ID = #evalGrpId#
	</update>

	<!--
	==================================================================   
	  # 설명	: 평가그룹 그룹ID 조회
	  #	기능	: SELECT
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<select id="getEvalGrpId" parameterClass="hashMap" resultClass="hashMap">
		SELECT 
			   'MEG'||NVL(LPAD(MAX(SUBSTR(EVAL_GRP_ID,4,4))+1,4,'0'),'0001') AS EVAL_GRP_ID
		  FROM MEM_EVAL_GRP
		 WHERE YEAR = #year#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가그룹 등록
	  #	기능	: INSERT
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<insert id="insertData" parameterClass="hashMap">		
		INSERT INTO MEM_EVAL_GRP (
		       YEAR
		     , EVAL_GRP_ID
		     , EVAL_GRP_NM
		     , SORT_ORDER
		     , CREATE_DT		     
			 ) VALUES ( 
			   #year#
			 , #evalGrpId#
			 , #evalGrpNm#
			 , #sortOrder#
			 , sysdate			
			 )
	</insert>	

	<!--
	==================================================================   
	  # 설명	: 평가그룹대상 삭제
	  #	기능	: UPDATE
	  #	TABLE	: MEM_EVAL_GRP_TARGET
	==================================================================
	-->	
	<delete id="deleteTargetData" parameterClass="hashMap">
		DELETE MEM_EVAL_GRP_TARGET 
		 WHERE YEAR = #year#
		   AND EVAL_GRP_ID = #evalGrpId#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 평가그룹대상 등록
	  #	기능	: INSERT
	  #	TABLE	: MEM_EVAL_GRP_TARGET
	==================================================================
	-->
	<insert id="insertTargetData" parameterClass="hashMap">		
		INSERT INTO MEM_EVAL_GRP_TARGET (
		       YEAR
		     , EVAL_GRP_ID
		     , EVAL_GRP_TRG_SEQ
		     , CAST_TC
		     , POS_TC
		     , YEAR_TC
		     , YEAR_TC_GUBUN
		     , APPLY_DT
		     , CREATE_DT		     
			 ) VALUES ( 
			   #year#
			 , #evalGrpId#
			 , (SELECT NVL(MAX(EVAL_GRP_TRG_SEQ), 0) + 1 FROM MEM_EVAL_GRP_TARGET WHERE YEAR = #year# AND EVAL_GRP_ID = #evalGrpId#)
			 , #castTc#
			 , #posTc#
			 , #yearTc#
			 , #yearTcGubun#
			 , #applyDt#
			 , sysdate			
			 )
	</insert>	
</sqlMap>


