<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.exc.excGroup">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		     SELECT A.YEAR
                  , A.EXC_GRP_ID
                  , A.EXC_GRP_NM
                  , (SELECT COUNT(*) 
                  	   FROM PRS_EXC_GRP_MEMBER M 
                  	  WHERE A.YEAR = M.YEAR 
                  	    AND A.EXC_GRP_ID = M.EXC_GRP_ID)EXC_COUNT
                  , B.CODE_NM EVAL_TYPE
                  , CASE
                  		WHEN EVAL_TYPE = '01' THEN C.CODE_NM
                  		WHEN EVAL_TYPE = '03' THEN '' 
                  	END AS EVAL_GRADE
               FROM PRS_EXC_GRP A
               LEFT OUTER JOIN BSC_CODE B
                 ON B.YEAR = #findYear#
                AND B.CODE_GRP_ID = '178'
                AND B.CODE_ID = A.EVAL_TYPE
               LEFT OUTER JOIN BSC_CODE C
                 ON C.YEAR = #findYear#
                AND C.CODE_GRP_ID = '164'
                AND C.CODE_ID = A.EVAL_GRADE               
              WHERE A.YEAR = #findYear#
              	AND A.EVAL_TYPE = '01'
              	 OR A.YEAR = #findYear#
              	AND A.EVAL_TYPE = '03' 
	</select>

	<!--	
	==================================================================   
	  # 설명	: 간부 별도평가군 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
	-->
	
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT G.YEAR                  
			 , G.EXC_GRP_ID           
			 , G.EXC_GRP_NM           
			 , G.EVAL_TYPE
			 , CASE
	           		WHEN EVAL_TYPE = '01' THEN G.EVAL_GRADE
	           		WHEN EVAL_TYPE = '03' THEN '' 
               END AS EVAL_GRADE
		  FROM PRS_EXC_GRP G
		 WHERE G.YEAR = #year#
		   AND G.EXC_GRP_ID = #excGrpId#	      
	</select>

	<!-- 	
	==================================================================   
	  # 설명	: 간부 별도평가군 부서 목록 조회
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP_DEPT
	==================================================================
	-->
	
	<select id="getDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR 
			 , A.EXC_GRP_ID
			 , A.DEPT_CD AS DEPT_ID
			 , B.DEPT_KOR_NM DEPT_NM
		  FROM PRS_EXC_GRP_DEPT A
		  LEFT OUTER JOIN BSC_INSA_DEPT B 
		    ON A.YEAR = B.YEAR 
		   AND A.DEPT_CD = B.DEPT_CD 
		 WHERE A.YEAR = #year#
		   AND A.EXC_GRP_ID = #excGrpId#	      
	</select>	

	<!-- 	
	==================================================================   
	  # 설명	: 간부 별도평가군 직위 목록 조회
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP_POS
	==================================================================
	-->
	
	<select id="getPosTcList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR 
             , A.EXC_GRP_ID
             , A.POS_TC
             , B.CODE_NM POS_TC_NM
          FROM PRS_EXC_GRP_POS A
          LEFT OUTER JOIN BSC_CODE B 
            ON A.YEAR = B.YEAR 
           AND A.POS_TC = B.CODE_ID 
           AND CODE_GRP_ID = '171' 
		 WHERE A.YEAR = #year#
		   AND A.EXC_GRP_ID = #excGrpId#	      
	</select>	


	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 코드 채번
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
	-->
	<select id="getExcGrpId" parameterClass="hashMap" resultClass="java.lang.String">
		SELECT F_PGM_SERI('BSC_EXC_GRP',#year#,'','','','') SEQ FROM DUAL		
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 등록
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
	-->
		
	<insert id="insertData" parameterClass="hashMap">
		INSERT INTO PRS_EXC_GRP (
		       YEAR
		     , EXC_GRP_ID
		     , EXC_GRP_NM
		     , EVAL_TYPE
		     <isEqual property="evalType" compareValue="01">
		     , EVAL_GRADE
		     </isEqual>
			 ) VALUES ( 
			   #year#
			 , #excGrpId#
			 , #excGrpNm#
			 , #evalType#
			 <isEqual property="evalType" compareValue="01">
			 , #evalGrade#
			 </isEqual>
			 )
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 부서 등록
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_DEPT
	==================================================================
	-->
		
	<insert id="insertDeptData" parameterClass="hashMap">		
		INSERT INTO PRS_EXC_GRP_DEPT (
		       YEAR
		     , EXC_GRP_ID
		     , DEPT_CD		     
			 ) VALUES ( 
			   #year#
			 , #excGrpId#
			 , #deptCd#			
			 )
	</insert>	

	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 직위 등록
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_POS
	==================================================================
	-->
		
	<insert id="insertPosData" parameterClass="hashMap">		
		INSERT INTO PRS_EXC_GRP_POS (
		       YEAR
		     , EXC_GRP_ID
		     , POS_TC		     
			 ) VALUES ( 
			   #year#
			 , #excGrpId#
			 , #posTc#			
			 )
	</insert>	
	
<!--	
	==================================================================   
	  # 설명	: 간부 별도평가군 수정
	  #	기능	: UPDATE
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
 -->
 		
	<update id="updateData" parameterClass="hashMap">
		UPDATE PRS_EXC_GRP 
		   SET EXC_GRP_NM	= #excGrpNm#
		     , EVAL_TYPE	= #evalType#	
		     <isEqual property="evalType" compareValue="01">
		     , EVAL_GRADE	= #evalGrade#
		     </isEqual>
		     <isEqual property="evalType" compareValue="03">
		     , EVAL_GRADE	= ''
		     </isEqual>
		 WHERE YEAR = #year#
		   AND EXC_GRP_ID = #excGrpId#		
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 부서 삭제
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_DEPT
	==================================================================
	-->
	<update id="deleteDeptData" parameterClass="hashMap">
		DELETE FROM PRS_EXC_GRP_DEPT 
		 WHERE YEAR = #year#
		   AND EXC_GRP_ID = #excGrpId#
	</update>

	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 직위 삭제
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_POS
	==================================================================
	-->
	<update id="deletePosData" parameterClass="hashMap">
		DELETE FROM PRS_EXC_GRP_POS 
		 WHERE YEAR = #year#
		   AND EXC_GRP_ID = #excGrpId#
	</update>
			
	

<!-- 	
	==================================================================   
	  # 설명	: 간부 별도평가군 삭제
	  #	기능	: UPDATE
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
-->		
	<update id="deleteData" parameterClass="hashMap">
		DELETE FROM PRS_EXC_GRP  
		 WHERE YEAR = #year#
		   AND EXC_GRP_ID = #excGrpId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 대상자관리 대상자 조회
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP_MEMBER
	==================================================================
	-->
	<select id="getUseList" parameterClass="hashMap" resultClass="hashMap">
	 SELECT A.YEAR
          , A.EXC_GRP_ID
          , A.EMPN
          , A.KOR_NM 
          , B.CODE_NM CAST_TC_NM
          , C.CODE_NM POS_TC_NM
          , D.DEPT_KOR_NM
          , E.DEPT_KOR_NM REAR_DEPT_KOR_NM
          , (SELECT DISTINCT TOT_MON
               FROM BSC_INSA_PCMT F
              WHERE A.YEAR = F.YEAR
                AND A.EMPN = F.EMPN) AS MON 
				  FROM PRS_EXC_GRP_MEMBER A
                  LEFT OUTER JOIN BSC_CODE B
                               ON A.YEAR = B.YEAR
                              AND A.CAST_TC = B.CODE_ID
                              AND B.CODE_GRP_ID = '170' 
                  LEFT OUTER JOIN BSC_CODE C
                               ON A.YEAR = C.YEAR
                              AND A.POS_TC = C.CODE_ID
                              AND C.CODE_GRP_ID = '171'
                  LEFT OUTER JOIN BSC_INSA_DEPT D
                               ON A.YEAR = D.YEAR
                              AND A.DEPT_CD = D.DEPT_CD
                  LEFT OUTER JOIN BSC_INSA_DEPT E
                               ON A.DEPT_CD = E.DEPT_CD
                              AND A.YEAR = E.YEAR                                                                                                  
				 WHERE A.YEAR = #findYear#
				   AND A.EXC_GRP_ID = #excGrpId#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 대상자관리 정보 조회
	  #	기능	: SELECT
	  #	TABLE	: PRS_EXC_GRP
	==================================================================
	-->
	<select id="getExcGrpUseDatail" parameterClass="hashMap" resultClass="hashMap">
		       SELECT YEAR
		       		, EXC_GRP_ID
		       		, EXC_GRP_NM 
				 FROM PRS_EXC_GRP
				WHERE YEAR = #findYear#
				  AND EXC_GRP_ID = #excGrpId#
	</select>	
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도평가군 평가 맵핑 대상자 조회
	  #	기능	: SELECT
	  #	TABLE	: BSC_INSA
	==================================================================
	-->
	<select id="getInsaUseList" parameterClass="hashMap" resultClass="hashMap">
		     SELECT I.YEAR
                  , I.EMPN
                  , I.KOR_NM
                  , I.DEPT_CD
                  , D.DEPT_KOR_NM
                  , I.CAST_TC
                  , C.CODE_NM CAST_TC_NM
                  , I.POS_TC
                  , O.CODE_NM POS_TC_NM
               FROM BSC_INSA I
    LEFT OUTER JOIN BSC_INSA_DEPT D
                 ON I.YEAR = D.YEAR
                AND I.DEPT_CD = D.DEPT_CD
    LEFT OUTER JOIN BSC_CODE C
                 ON I.YEAR = C.YEAR
                AND I.CAST_TC = C.CODE_ID
                AND C.CODE_GRP_ID = '170'
    LEFT OUTER JOIN BSC_CODE O
                 ON I.YEAR = O.YEAR
                AND I.POS_TC = O.CODE_ID
                AND O.CODE_GRP_ID = '171'
              WHERE I.YEAR = #findYear#
                AND I.CAST_TC IN ('10','20','30')            
		<dynamic>
			<isNotEmpty prepend="AND" property="findDeptKorNm">
			   	   UPPER(D.DEPT_KOR_NM) LIKE '%'|| TRIM(UPPER(#findDeptKorNm#)) ||'%'	
			</isNotEmpty>   
			<isNotEmpty prepend="AND" property="findEmpn">
			   	   I.EMPN = #findEmpn#	
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="findKorNm">
			   	   UPPER(I.KOR_NM) LIKE '%'|| TRIM(UPPER(#findKorNm#)) ||'%'	
			</isNotEmpty>
		</dynamic>                            
		ORDER BY I.EMPN, I.KOR_NM  
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 대상자관리 대상자 저장
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_MEMBER
	==================================================================
	-->
		
	<insert id="insertUseData" parameterClass="hashMap">		
		INSERT INTO PRS_EXC_GRP_MEMBER (
		       YEAR
		     , EXC_GRP_ID
		     , EMPN
		     , KOR_NM
		     , DEPT_CD
		     , CAST_TC
		     , POS_TC  
			 )
			 SELECT YEAR
			 	  , #excGrpId# EXC_GRP_ID
			      , EMPN
			      , KOR_NM
			      , DEPT_CD
			      , CAST_TC
			      , POS_TC 
			   FROM BSC_INSA 
			  WHERE EMPN = #empn#	
			    AND YEAR = #year#
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 대상자관리 대상자 삭제
	  #	기능	: DELETE
	  #	TABLE	: PRS_EXC_GRP_MEMBER
	==================================================================
	-->
	<update id="deleteUseData" parameterClass="hashMap">
		DELETE FROM PRS_EXC_GRP_MEMBER 
		 WHERE YEAR = #year#
		   AND EXC_GRP_ID = #excGrpId# 
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 대상자관리 대상자 자동저장
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_MEMBER
	==================================================================
	-->
	<insert id="insertUseDataAuto" parameterClass="hashMap">	
		INSERT INTO PRS_EXC_GRP_MEMBER (
					YEAR
		          , EXC_GRP_ID
		          , EMPN
		          , KOR_NM
		          , DEPT_CD
		          , CAST_TC
		          , POS_TC
		          )     
		     SELECT DISTINCT A.YEAR               
		          , A.EXC_GRP_ID                
		          , D.EMPN               
		          , D.KOR_NM               
		          , D.DEPT_CD               
		          , D.CAST_TC               
		          , D.POS_TC       
		       FROM PRS_EXC_GRP A
    LEFT OUTER JOIN PRS_EXC_GRP_DEPT B
		         ON A.YEAR = B.YEAR AND A.EXC_GRP_ID = B.EXC_GRP_ID
	LEFT OUTER JOIN PRS_EXC_GRP_POS C
		         ON A.YEAR = C.YEAR AND A.EXC_GRP_ID = C.EXC_GRP_ID
		 INNER JOIN BSC_INSA D
		         ON (
	                A.YEAR = D.YEAR    
		         	AND B.DEPT_CD IS NOT NULL
		            AND C.POS_TC IS NOT NULL
		            AND D.DEPT_CD = B.DEPT_CD
		            AND D.POS_TC = C.POS_TC
		       ) OR ( A.YEAR = D.YEAR AND
		            (B.DEPT_CD IS NULL OR C.POS_TC IS NULL) AND (D.DEPT_CD = B.DEPT_CD OR D.POS_TC = C.POS_TC)
		            )
		    WHERE     A.YEAR = #year#
		          AND A.EXC_GRP_ID NOT IN ('EX99999', 'EX99998')
		          AND D.CAST_TC BETWEEN '10' AND '30'
		   <![CDATA[       
		          AND D.EMPN NOT IN (SELECT DISTINCT EMPN FROM BSC_INSA_PCMT WHERE YEAR = #year# AND CAST_TC BETWEEN '10' AND '30' AND TOT_MON < 2)
		   ]]>       
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 근무기간 2개월 미만
	  #	기능	: INSERT
	  #	TABLE	: PRS_EXC_GRP_MEMBER
	==================================================================
	-->
	<insert id="insertLessThan1Months" parameterClass="hashMap">	
		INSERT INTO PRS_EXC_GRP_MEMBER (
					YEAR
		          , EXC_GRP_ID
		          , EMPN
		          , KOR_NM
		          , DEPT_CD
		          , CAST_TC
		          , POS_TC
		          )     
             SELECT A.YEAR               
                  , A.EXC_GRP_ID                
                  , C.EMPN               
                  , C.KOR_NM               
                  , C.DEPT_CD               
                  , C.CAST_TC               
                  , C.POS_TC       
               FROM PRS_EXC_GRP A
		<![CDATA[
                  , (SELECT DISTINCT EMPN FROM BSC_INSA_PCMT WHERE YEAR = #year# AND CAST_TC BETWEEN '10' AND '30' AND TOT_MON < 2) B
		]]>
                  , BSC_INSA C
              WHERE A.YEAR = #year#
                AND A.EXC_GRP_ID = 'EX99999'
                AND A.YEAR = C.YEAR
                AND B.EMPN = C.EMPN
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 간부 별도군관리 대상자관리 대상자 삭제
	  #	기능	: DELETE
	  #	TABLE	: PRS_EXC_GRP_MEMBER
	==================================================================
	-->
	<update id="deleteUseDataAuto" parameterClass="hashMap">
		DELETE FROM PRS_EXC_GRP_MEMBER 
		 WHERE YEAR = #year#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자 권한 삭제
	  #	기능	: DELETE
	  #	TABLE	: BSC_ADMIN
	==================================================================
	-->	
	<delete id="deleteAdminData" parameterClass="hashMap">
		DELETE FROM BSC_ADMIN
         WHERE ADMIN_GUBUN='82'
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 권한 등록
	  #	기능	: INSERT
	  #	TABLE	: BSC_ADMIN
	==================================================================
	-->	
	<insert id="insertAdminData" parameterClass="hashMap">
		INSERT INTO BSC_ADMIN (ADMIN_GUBUN, USER_ID)
        SELECT '82', EMPN  FROM
         (SELECT DISTINCT EMPN FROM PRS_EXC_GRP_MEMBER WHERE YEAR = #findYear# ) 
          
	</insert>	
		
	 
</sqlMap>


