<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.mngCon.actualMngCon">

    <!--
    ==================================================================   
      # 설명    : typeAlias 선언
      #    기능    : SETTING
      #    TABLE    : 
    ==================================================================
    -->
    <typeAlias alias="hashMap"             type="java.util.HashMap" />
    
    <!--
    ==================================================================   
      # 설명    : 직원개인업무성과 실적등록 목록 보기
      #    기능    : SELECT
      #    TABLE    : 
    ==================================================================
    -->
    <select id="getActualList" parameterClass="hashMap" resultClass="hashMap">
        SELECT A.YEAR
			 , A.EVAL_MEMB_EMPN
			 , A.EVAL_MEMB_EMPN_SEQ
			 , A.KOR_NM
			 , A.DEPT_CD
			 , A.DEPT_KOR_NM
			 , F_DEPT_FULL_NM(A.YEAR,A.DEPT_CD,'BSC_INSA_DEPT') DEPT_FULL_NM
			 , A.CAST_TC
			 , A.POS_TC
			 , F_CODE_NM('170', A.CAST_TC , A.YEAR) CAST_TC_NM 
             , F_CODE_NM('171', A.POS_TC , A.YEAR) POS_TC_NM 
			 , A.PLAN_STATUS_ID
			 , A.PLAN_STATUS_NM 
			 , A.PLAN_YN
			 , A.ACT_STATUS_ID
			 , A.ACT_STATUS_NM
        FROM (
        SELECT A.YEAR
			 , A.EVAL_MEMB_EMPN
			 , A.EVAL_MEMB_EMPN_SEQ
			 , A.KOR_NM
			 , A.DEPT_CD
			 , D.DEPT_KOR_NM
			 , A.CAST_TC
			 , A.POS_TC
			 , A.PLAN_STATUS_ID
			 , CASE WHEN A.PLAN_STATUS_ID IS NULL THEN '미입력' ELSE  F_CODE_NM('217', A.PLAN_STATUS_ID , A.YEAR)  END PLAN_STATUS_NM
			 , A.PLAN_YN
			 ,  NVL((SELECT MAX(S2.ACT_STATUS_ID) FROM CON_MNG_TARGET S1                      
            LEFT OUTER JOIN CON_MNG_ACTUAL S2
            		ON S1.YEAR = S2.YEAR                         
                    AND S2.MON =  '12'                         
                    AND S1.EVAL_MEMB_EMPN = S2.EVAL_MEMB_EMPN                         
                    AND S1.EVAL_MEMB_EMPN_SEQ = S2.EVAL_MEMB_EMPN_SEQ                         
                    AND S1.TARGET_ID = S2.TARGET_ID                     
            WHERE
                A.YEAR = S1.YEAR                     
                AND A.EVAL_MEMB_EMPN = S1.EVAL_MEMB_EMPN                     
                AND A.EVAL_MEMB_EMPN_SEQ = S1.EVAL_MEMB_EMPN_SEQ ), '06') AS ACT_STATUS_ID 
             , F_CODE_NM('217', (SELECT MAX(S2.ACT_STATUS_ID) FROM CON_MNG_TARGET S1                      
            LEFT OUTER JOIN CON_MNG_ACTUAL S2
            		ON S1.YEAR = S2.YEAR                         
                    AND S2.MON =  '12'                         
                    AND S1.EVAL_MEMB_EMPN = S2.EVAL_MEMB_EMPN                         
                    AND S1.EVAL_MEMB_EMPN_SEQ = S2.EVAL_MEMB_EMPN_SEQ                         
                    AND S1.TARGET_ID = S2.TARGET_ID                     
            WHERE
                A.YEAR = S1.YEAR                     
                AND A.EVAL_MEMB_EMPN = S1.EVAL_MEMB_EMPN                     
                AND A.EVAL_MEMB_EMPN_SEQ = S1.EVAL_MEMB_EMPN_SEQ ) , A.YEAR) ACT_STATUS_NM   
		FROM V_CON_MNG_MEMBER A
		 LEFT OUTER JOIN BSC_INSA_DEPT D ON A.YEAR = D.YEAR AND A.DEPT_CD = D.DEPT_CD
		WHERE A.EVAL_YN ='Y'  <!-- AND A.PLAN_YN ='Y'  -->) A
		WHERE A.YEAR= #findYear#
		 <isNotEmpty prepend="AND" property="findEvalMembEmpn" >
			  A.EVAL_MEMB_EMPN      = #findEvalMembEmpn#
		</isNotEmpty>
		<isNotEqual prepend="AND" property="isAdmin" compareValue="Y">
            A.EVAL_MEMB_EMPN = #loginUserId#
        </isNotEqual>
         <isNotEmpty prepend="AND" property="findActStatusId" >
            A.ACT_STATUS_ID = #findActStatusId#
        </isNotEmpty>
		   ORDER BY A.KOR_NM, A.EVAL_MEMB_EMPN, A.EVAL_MEMB_EMPN_SEQ
    </select>
    
     

    <!--
    ==================================================================   
      # 설명    : 직원개인업무성과 실적등록 목록 보기
      #    기능    : SELECT
      #    TABLE    : 
    ==================================================================
    -->
    <select id="getList" parameterClass="hashMap" resultClass="hashMap">
          SELECT A.YEAR
		        , A.DIRECTION_CD
		        , F_CODE_NM('218',A.DIRECTION_CD , A.YEAR) DIRECTION_NM
		        , A.TARGET_ID
		        , A.TARGET_NM
		        , A.METRIC_NM
		        , A.TARGET_VALUE
		        , A.TARGET_BASIS
        		, A.WEIGHT
		        , A.UNIT
		        , F_CODE_NM('013',A.UNIT , A.YEAR) UNIT_NM
		        , B.Q1_ACTUAL_VALUE
		        , B.Q2_ACTUAL_VALUE
		        , B.Q3_ACTUAL_VALUE
		        , B.Q4_ACTUAL_VALUE
		        , A.CONTENT
		        , B.VALUE
		        , ROUND(B.SCORE,3) AS SCORE
		        , B.EVAL_GRADE
		        , B.ACT_STATUS_ID
		        , B.CONTENT         
		    FROM  CON_MNG_TARGET A         
		    LEFT OUTER JOIN
		        CON_MNG_ACTUAL B             
		            ON A.YEAR = B.YEAR 
		            AND A.EVAL_MEMB_EMPN = B.EVAL_MEMB_EMPN             
		            AND A.EVAL_MEMB_EMPN_SEQ = B.EVAL_MEMB_EMPN_SEQ             
		            AND A.TARGET_ID = B.TARGET_ID   
		     WHERE A.YEAR = #findYear#
	        <isNotEqual prepend="AND" property="isAdmin" compareValue="Y">
	            A.EVAL_MEMB_EMPN = #loginUserId#
	        </isNotEqual>
	        <isEqual prepend="AND" property="isAdmin" compareValue="Y">
	            A.EVAL_MEMB_EMPN = #evalMembEmpn#    
	        </isEqual>
	        AND A.EVAL_MEMB_EMPN_SEQ = #evalMembEmpnSeq#  
		    ORDER BY
		        A.DIRECTION_CD,
		        A.TARGET_ID     

    </select>
    
     <!--
	==================================================================   
	  # 설명	: 첨부파일 보기  
	  #	기능	: SELECT  
	  #	TABLE	: PRS_MNG_RPT_ATTACH
	==================================================================
	-->
	<select id="getFileList" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
			 , EVAL_MEMB_EMPN
			 , EVAL_MEMB_EMPN_SEQ
			 , SEQ
			 , ATTACH_FILE_NM
		     , ATTACH_FILE_FNM
		     , ATTACH_FILE_SUFFIX
		     , ATTACH_FILE_PATH 
		  FROM CON_MNG_ACTUAL_ATTACH
		 WHERE YEAR = #findYear#
         AND   EVAL_MEMB_EMPN      = #evalMembEmpn#
		 AND   EVAL_MEMB_EMPN_SEQ  = #evalMembEmpnSeq#   
		 ORDER BY SEQ                                			                       
	</select>
    
    <!--
    ==================================================================   
      # 설명    : 직원개인업무성과 실적등록 수정
      #    기능    : UPDATE
      #    TABLE    : 
    ==================================================================
    -->    
    <update id="updateData" parameterClass="hashMap">
        MERGE INTO CON_MNG_ACTUAL A
        USING (
            SELECT  #year# AS YEAR
            , #mon# AS MON
            , #evalMembEmpn# AS EVAL_MEMB_EMPN
            , #evalMembEmpnSeq# AS EVAL_MEMB_EMPN_SEQ
            , #targetId# AS TARGET_ID
            , #actStatusId# AS ACT_STATUS_ID
            , #value# AS VALUE
            , #score# AS SCORE
            , #actualFValue# AS Q1_ACTUAL_VALUE
            , #actualSValue# AS Q2_ACTUAL_VALUE	
            , #actualTValue# AS Q3_ACTUAL_VALUE	
            , #actualFFValue# AS Q4_ACTUAL_VALUE	
            FROM DUAL
        ) B ON (A.YEAR = B.YEAR AND A.MON = B.MON AND A.EVAL_MEMB_EMPN = B.EVAL_MEMB_EMPN AND A.EVAL_MEMB_EMPN_SEQ = B.EVAL_MEMB_EMPN_SEQ AND A.TARGET_ID = B.TARGET_ID)
        WHEN MATCHED THEN
        UPDATE SET A.VALUE = B.VALUE, A.SCORE = B.SCORE,  A.ACT_STATUS_ID = B.ACT_STATUS_ID, A.MODIFY_ID = #loginUserId#, A.MODIFY_DT = SYSDATE
        , A.Q1_ACTUAL_VALUE = #actualFValue#  , A.Q2_ACTUAL_VALUE = #actualSValue#  , A.Q3_ACTUAL_VALUE = #actualTValue#  , A.Q4_ACTUAL_VALUE = #actualFFValue# 
        WHEN NOT MATCHED THEN
            INSERT (YEAR, MON, EVAL_MEMB_EMPN, EVAL_MEMB_EMPN_SEQ, TARGET_ID, VALUE, SCORE , ACT_STATUS_ID , 
            		Q1_ACTUAL_VALUE, Q2_ACTUAL_VALUE , Q3_ACTUAL_VALUE, Q4_ACTUAL_VALUE , CREATE_ID, CREATE_DT, MODIFY_ID, MODIFY_DT)
            VALUES (B.YEAR, B.MON, B.EVAL_MEMB_EMPN, B.EVAL_MEMB_EMPN_SEQ, B.TARGET_ID, B.VALUE, B.SCORE , B.ACT_STATUS_ID,
            		B.Q1_ACTUAL_VALUE, B.Q2_ACTUAL_VALUE , B.Q3_ACTUAL_VALUE, B.Q4_ACTUAL_VALUE , #loginUserId#, SYSDATE, #loginUserId#, SYSDATE)
    </update>    
    

	 <!--
    ==================================================================   
      # 설명    : 직원개인업무성과 실적등록 상태 수정
      #    기능    : UPDATE
      #    TABLE    : 
    ==================================================================
    -->    
    <update id="updateStatusData" parameterClass="hashMap">
        UPDATE CON_MNG_ACTUAL 
           SET    ACT_STATUS_ID     = #actStatusId#
                , MODIFY_ID         = #loginUserId#
                , MODIFY_DT         = SYSDATE
           WHERE YEAR               = #year# 
             AND MON                = #mon#
             AND EVAL_MEMB_EMPN     = #evalMembEmpn#
             AND EVAL_MEMB_EMPN_SEQ = #evalMembEmpnSeq#
    </update>
    
    <!--
	==================================================================   
	  # 설명	: 첨부파일 삭제  
	  #	기능	: INSERT
	  #	TABLE	: PRS_MNG_RPT_ATTACH
	==================================================================
	-->	
	<delete id="deleteFileInfo" parameterClass="hashMap">
		DELETE FROM CON_MNG_ACTUAL_ATTACH
		 WHERE YEAR = #year#
		   AND MON  = #mon#
		   AND EVAL_MEMB_EMPN      = #evalMembEmpn#
		   AND EVAL_MEMB_EMPN_SEQ  = #evalMembEmpnSeq#  
		   AND SEQ = #seq#
	</delete>
    
    <!--
	==================================================================   
	  # 설명	: 첨부파일 등록 
	  #	기능	: INSERT
	  #	TABLE	: PRS_MNG_RPT_ATTACH
	==================================================================
	-->	
	<insert id="insertFileInfo" parameterClass="hashMap">
		<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
	        SELECT NVL(MAX(SEQ)+1,1) SEQ
	          FROM CON_MNG_ACTUAL_ATTACH
	         WHERE YEAR = #year# 
	           AND MON  = #mon#
	           AND EVAL_MEMB_EMPN      = #evalMembEmpn#
		       AND EVAL_MEMB_EMPN_SEQ  = #evalMembEmpnSeq#  
		</selectKey>
		INSERT INTO CON_MNG_ACTUAL_ATTACH (
               YEAR
			 , MON
			 , EVAL_MEMB_EMPN
			 , EVAL_MEMB_EMPN_SEQ
			 , TARGET_ID
			 , SEQ
			 , ATTACH_FILE_NM
			 , ATTACH_FILE_FNM
			 , ATTACH_FILE_SUFFIX
			 , ATTACH_FILE_PATH
			 , CREATE_DT
            ) VALUES (
               #year#
             , #mon#
             , #evalMembEmpn#
             , #evalMembEmpnSeq#
             , #targetId# 
             , #SEQ#
             , #attachFileNm#
             , #attachFileFnm#
             , #attachFileSufix#
             , #attachFilePath#
             , SYSDATE
    	   )       
	</insert>
    
</sqlMap>


