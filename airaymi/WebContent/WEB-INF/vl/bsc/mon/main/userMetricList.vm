#*************************************************************************
* CLASS 명      : userMetricList
* 작 업 자      : 김윤기 
* 작 업 일      : 2012년 9월 6일 
* 기    능      : 주요지표선택
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자    작     업     일        변 경 내 용                비고
* ----  --------  -----------------  -------------------------  --------
*  1    김윤기      2012년 9월 6일             최 초 작 업 
**************************************************************************# 

<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;
	
	J(document).ready(function(){
		
		/******************************************
		 * 데이터 그리드 출력
		 ******************************************/
		var str = J('#formFindPop').serialize();
		
		jQuery("#mlist").jqGrid({
			url          :"$!{searchMap.txt2html("context")}/bsc/mon/main/userMetricList_xml.vw" + "?" + str,
			mtype        :"POST",
			datatype     :"json",
			jsonReader   : {   
    						page   : "page",
    						total  : "total",
    						root   : "rows", 
    						records: function(obj){return obj.length;},
    						repeatitems: false, 
    						id     : "id"
    				       },
			height       : 370,
			colNames     :['','성과조직명', 'KPI', 'KPI명'],
			colModel     :[
							{name:'VIEW_YN'  	    ,index:'VIEW_YN'  	  ,width:25, formatter:linkUpdate  	,align:'center'},
							{name:'METRIC_ID'  	    ,index:'METRIC_ID'    				   },
							{name:'SC_DEPT_NM'  	,index:'SC_DEPT_NM'   ,width:100 	 ,align:'left' },
							{name:'METRIC_NM'  	    ,index:'METRIC_NM'    ,width:300 	 ,align:'left' },
							],
			rowNum       : 100000,
			autowidth    : true,
			viewrecords  : true,
			loadonce     : true,
			multiselect  : false,
			cellEdit     : true,
			caption:"주요지표선택"
		}).jqGrid('hideCol',"METRIC_ID");

		/******************************************
		 * 버튼 UI 적용
		 ******************************************/		
		try {
			$("input", ".blockButton" ).button();
		} catch(err) { }
    				
	});

	/******************************************
	 * jqGrid CHECKBOX
	 ******************************************/
	function linkUpdate(cellvalue, options, rowObject) {
		if(rowObject.VIEW_YN=='Y'){
			J("#checked").val(J("#checked").val() + rowObject.METRIC_ID+ '|');
		}
	
		var checked="";
		if(cellvalue=="Y"){
			checked="checked";	
		}
        return '<input type="checkbox" name="check" '+ checked +'/>'
	}
	
	/******************************************
	 * 저장버튼 이벤트
	 ******************************************/
	J("#btnOk").click(function(e) {
		var rowdata = "";
		var metricIds = "";
		var idx=0;
		var ids = J("#mlist").jqGrid('getDataIDs');
		var checkes = J(":input[name=check]");
		J.each(checkes, function (index, value) {
			if(J(value).attr("checked")=="checked"){
				idx++;
        		rowdata = J("#mlist").getRowData(ids[index]);
        		metricIds += rowdata.METRIC_ID + '|';
			}
		});
		
		if(idx==0){
			alert("저장할 데이터를 선택하십시요");
		}else{
    		if(idx>4){
    			alert("최대 4개까지 저정 할 수 있습니다");
    		}else{
    			//변경이 있을 때만 저장이 되도록 처리
    			if(metricIds!=J("#checked").val()){
            		J("#stMode").val("ADD_METRIC");
            		J("#metricIds").val(metricIds);
            		J("#formFindPop").attr("action", "$!{searchMap.txt2html("contextPath")}/bsc/mon/main/mainProcess.vw?type=template").submit();
				}else{
					//변경이 없을 때는 화면이 닫혀지도록 처리
					J.fancybox.close();
				}
    		}
		}
		return false;
	});	
	
//]]>
</script>

<form id="formFindPop" name="formFindPop" method="post">
	<input type="hidden" id="year" 		name="year" 	value="$!{searchMap.txt2html("year")}" />
	<input type="hidden" id="scDeptId" 	name="scDeptId" value="$!{CS_LOGIN.getSc_dept_id()}" />
	<input type="hidden" name="userId" 	value="$!{CS_LOGIN.getUser_id()}" />
	<input type="hidden" id="metricIds" name="metricIds" />
	<input type="hidden" id="stMode"    name="stMode" />
	<input type="hidden" id="checked" 	name="checked"  />
	
    <div  style="width:425px;height:460px">
		<div id="">
    		<div id="userData">
    			<!-- 데이터그리드 Start -->
    			<div class="blockGridListTable">
					<table id="mlist" summary="비교조직선택 조회결과">
    					<caption class="none">비교조직선택 조회</caption>
    					<thead><tr><th></th></tr></thead>
    					<tbody><tr><td></td></tr></tbody>
    				</table>
    				<div id="pager"></div>                    
    			</div>
    			<!--// 데이터그리드 End -->	
    		</div>
    	</div>
    	
		<div class="blockButton_all">			
        	<div class="blockButton_l"></div>
        	<div class="blockButton">			
        		<ul>
        			<li><input type="button" id="btnOk" value="확인" /></li>
        		</ul>
        	</div>
        </div>
    </div>
</form>
