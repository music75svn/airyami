<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bsc.popup.certificationProcess">

	<!--
	==================================================================
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	:
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />

	<!--
	==================================================================
	  # 설명	: 시스템 연계 부서 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getScDeptMapping" parameterClass="hashMap" resultClass="java.lang.String">
		SELECT DEPT_ID
		FROM ( SELECT DEPT_ID
				   FROM BSC_SC_DEPT_MAPPING
				  WHERE YEAR = #findYear#
				    AND SC_DEPT_ID = #findScDeptCd# ORDER BY DEPT_ID )
		WHERE ROWNUM = 1
	</select>


	<!--
	==================================================================
	  # 설명	: 시스템 연계 부서 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getDeptInfo" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.DEPT_ID, B.DEPT_NM
	 	FROM BSC_SC_DEPT_MAPPING A
		LEFT OUTER JOIN BSC_DEPTINFO B
			ON A.DEPT_ID = B.DEPT_ID
		 WHERE (YEAR, SC_DEPT_ID) IN
		          (SELECT YEAR, SC_DEPT_ID
		             FROM BSC_METRIC
		            WHERE (METRIC_GRP_ID, YEAR) IN
		                     (SELECT METRIC_GRP_ID, YEAR
		                        FROM BSC_METRIC
		                       WHERE YEAR = #findYear# AND METRIC_ID = #findMetricId#)
		            AND DELETE_DT IS NULL)
	</select>

	<!--
	==================================================================
	  # 설명	: 시스템 연계항목 정보를 가져옴
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getItem" remapResults="true" parameterClass="hashMap" resultClass="hashMap">
          SELECT A.ITEM_CD, B.CAL_TYPE_COL_NM
            FROM BSC_SYSTEM_ITEM A
               , BSC_CAL_TYPE_COL B
           WHERE A.YEAR = #findYear#
             AND A.YEAR = B.YEAR
             AND A.ITEM_CD = B.ITEM_CD
             AND B.METRIC_ID = #findMetricId#
             AND B.INSERT_GUBUN = '01'
           ORDER BY B.CAL_TYPE_COL_NM
	</select>

	<!--
	==================================================================
	  # 설명	: 시스템 연계데이터 조회 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT RCPT_YY
		     , MON
		     , INSP_DEPT_CD
		     , DEPT_NM
		     , INSP_KIND_TC_NM
		     , STIC_LAG_TC_NM
		     , STIC_MID_TC_NM
		     , STIC_SML_TC_NM
		     , CO_NM
		     , SUM (ACTUAL) ACTUAL
		     , SYSDATE
		  FROM (SELECT A.RCPT_YY
		             , SUBSTR (A.RCPT_DATE, 5, 2) MON
		             , A.INSP_DEPT_CD
		             , B.DEPT_NM
		             , A.INSP_KIND_TC_NM
		             , A.STIC_LAG_TC_NM
		             , A.STIC_MID_TC_NM
		             , A.STIC_SML_TC_NM
		             , A.CO_NM
		             , CASE
		            	   WHEN STIC_MID_TC = '20'
		                   THEN
		                   		CASE
		                        	WHEN STIC_SML_TC = '55'
		                         	THEN
		                            	CASE
		                               		WHEN (SELECT (TO_DATE (INSP_END_DATE, 'YYYYMMDD')- TO_DATE (RCPT_DATE, 'YYYYMMDD')+ 1)
		                                            - (SELECT COUNT (1)
		                                                 FROM SAORA01.GGA0500M
		                                                WHERE HODY_YN = 'T'
		                                                  AND YMD_CHAR BETWEEN RCPT_DATE
		                                                  AND INSP_END_DATE
		                                                  AND DATE_D <![CDATA[ <> ]]> '7')
		                                       		FROM DUAL)<![CDATA[ <=]]>30
		                                    THEN 1
		                                ELSE 0
		                            	END
		                         	ELSE
		                            	CASE
		                               		WHEN (SELECT (TO_DATE (INSP_END_DATE, 'YYYYMMDD')- TO_DATE (RCPT_DATE, 'YYYYMMDD')+ 1)
		                                            - (SELECT COUNT (1)
		                                                 FROM SAORA01.GGA0500M
		                                                WHERE HODY_YN = 'T'
		                                                  AND YMD_CHAR BETWEEN RCPT_DATE
		                                                  AND INSP_END_DATE
		                                                  AND DATE_D <![CDATA[ <> ]]> '7')
		                                       		FROM DUAL)<![CDATA[ <= ]]> 15
		                                    THEN 1
		                               	ELSE 0
		                            	END
		                      		END
		                   		WHEN STIC_MID_TC = '25'
		                   		THEN
		                      		CASE
		                         		WHEN (SELECT (  TO_DATE (INSP_END_DATE, 'YYYYMMDD')- TO_DATE (RCPT_DATE, 'YYYYMMDD')+ 1)
		                                      - (SELECT COUNT (1)
		                                           FROM SAORA01.GGA0500M
		                                          WHERE HODY_YN = 'T'
		                                            AND YMD_CHAR BETWEEN RCPT_DATE
		                                            AND INSP_END_DATE
		                                            AND DATE_D <![CDATA[ <> ]]> '7')
		                                 		FROM DUAL) <![CDATA[ <= ]]> 60
		                                THEN 1
		                         		ELSE 0
		                      	END
		               END
		                   ACTUAL
		           FROM V_GBB0701M_001 A
		           LEFT OUTER JOIN BSC_DEPTINFO B
		             ON A.INSP_DEPT_CD = B.DEPT_ID
		          WHERE RCPT_YY = #findYear#
		          <isNotEmpty prepend="AND" property="findMon">
		            SUBSTR (RCPT_DATE, 5, 2) = #findMon#
		          </isNotEmpty>
		          		AND INSP_DEPT_CD = #findDeptId#
		)
		GROUP BY RCPT_YY
		      , MON
		      , INSP_DEPT_CD
		      , DEPT_NM
		      , INSP_KIND_TC_NM
		      , STIC_LAG_TC_NM
		      , STIC_MID_TC_NM
		      , STIC_SML_TC_NM
		      , CO_NM
		ORDER BY RCPT_YY, MON
	</select>

	<!--
	==================================================================
	  # 설명	: 시스템 연계데이터 조회 목록 보기
	  #	기능	: SELECT
	  #	TABLE	:
	==================================================================
	-->
	<select id="getTotList" parameterClass="hashMap" resultClass="hashMap">
		SELECT RCPT_YY
		      , MON
		      , 'S031D001' ITEM_CD
		      , INSP_DEPT_CD
		      , DEPT_NM
		      , INSP_KIND_TC_NM
		      , STIC_LAG_TC_NM
		      , STIC_MID_TC_NM
		      , STIC_SML_TC_NM
		      , CO_NM
		      , SUM (ACTUAL) ACTUAL
		      , SYSDATE
		   FROM (  SELECT A.RCPT_YY
		                , SUBSTR (A.RCPT_DATE, 5, 2) MON
		                , A.INSP_DEPT_CD
		                , B.DEPT_NM
		                , A.INSP_KIND_TC_NM
		                , A.STIC_LAG_TC_NM
		                , A.STIC_MID_TC_NM
		                , A.STIC_SML_TC_NM
		                , A.CO_NM
		                , COUNT (1) ACTUAL
		            FROM   V_GBB0701M_001 A
		            LEFT OUTER JOIN
		                 BSC_DEPTINFO B
		              ON A.INSP_DEPT_CD = B.DEPT_ID
		           WHERE RCPT_YY = #findYear#
		             AND SUBSTR (RCPT_DATE, 5, 2) = #findMon#
		             AND INSP_DEPT_CD = #findDeptId#
		           GROUP BY A.RCPT_YY
		                  , A.RCPT_DATE
		                  , A.INSP_DEPT_CD
		                  , B.DEPT_NM
		                  , A.INSP_KIND_TC_NM
		                  , A.STIC_LAG_TC_NM
		                  , A.STIC_MID_TC_NM
		                  , A.STIC_SML_TC_NM
		                  , A.CO_NM)
			GROUP BY RCPT_YY
		        , MON
		        , INSP_DEPT_CD
		        , DEPT_NM
		        , INSP_KIND_TC_NM
		        , STIC_LAG_TC_NM
		        , STIC_MID_TC_NM
		        , STIC_SML_TC_NM
		        , CO_NM
		    ORDER BY INSP_DEPT_CD
	</select>

</sqlMap>


