#*************************************************************************
* CLASS 명      : ahpEvalModify
* 작 업 자      : 하윤식
* 작 업 일      : 2012년 11월 29일
* 기    능      : AHP 평가실시
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자    작     업     일        변 경 내 용                비고
* ----  --------  -----------------  -------------------------  --------
*  1    하윤식      2012년 11월 29일             최 초 작 업
**************************************************************************#

<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;

	J(document).ready(function(){

		/******************************************
		 * 데이터 그리드 출력
		 ******************************************/
		var str = J('#form1').serialize();

		jQuery("#list").jqGrid({
			url          :"$!{context_path}/bsc/ahp/ahpEval/ahpEvalExecList_xml.vw" + "?" + str,
			mtype        :"POST",
			datatype     :"json",
			jsonReader   : {
    						page   : "page",
    						total  : "total",
    						root   : "rows",
    						records: function(obj){return obj.length;},
    						repeatitems: false,
    						id     : "id"
    				       },
			height       : $!{jqGrid_height},
			width        : $!{jqGrid_width},
			colNames     :['기준대상id', '기준대상'
							#foreach($list in $evalScorelist)
								, '$!{CS_HTML.txt2html($list.EVAL_SCORE)}점'
							#end
                           , '피비교대상id', '피비교대상','기준대상','피비교대상', '평가점수'
			              ],
			colModel     :[
                            {name:'ITEM_ID'            ,index:'ITEM_ID'           ,width:150   ,align:'center' },
                            {name:'ITEM_NM'            ,index:'ITEM_NM'           ,width:180   ,align:'left'   },

							#foreach($list in $evalScorelist)
								{name:'SCORE_$!{CS_HTML.txt2html($list.EVAL_SCORE_ID)}' ,index:'SCORE_$!{CS_HTML.txt2html($list.EVAL_SCORE_ID)}' ,width:50 ,align:'center' ,formatter:linkRadioCheck},
							#end

							{name:'PER_ITEM_ID'        ,index:'PER_ITEM_ID'        ,width:80    ,align:'center' },
							{name:'PER_ITEM_NM'        ,index:'PER_ITEM_NM'        ,width:180   ,align:'left'   },
							{name:'ITEM_ID_PARAM'      ,index:'ITEM_ID_PARAM'      ,width:150   ,align:'center' ,formatter:linkItemId},
							{name:'PER_ITEM_ID_PARAM'  ,index:'PER_ITEM_ID_PARAM'  ,width:80    ,align:'center' ,formatter:linkPerItemId},
                            {name:'EVAL_SCORE_ID'      ,index:'EVAL_SCORE_ID'      ,width:50    ,align:'center' }
							],
			rowNum       : $!{jqGrid_rownum},
			autowidth    : false,
			viewrecords  : true,
			loadonce     : true,
			multiselect  : false,
			cellEdit     : true,
			gridview     : true,
			cmTemplate: {sortable:false},
			loadComplete : function() {
                            			//평가자가 평가제출 했으면 평가항목을 입력 못 함
                            			if('$!{evalStatus.EVAL_SUBMIT_YN}' == 'Y' ){
    										J("input:radio", "#list").attr("disabled",true);
										}
                           },
			caption:"AHP 평가실시"
        }).jqGrid('hideCol',"ITEM_ID").jqGrid('hideCol',"PER_ITEM_ID").jqGrid('hideCol',"EVAL_SCORE_ID")
		  .jqGrid('hideCol',"ITEM_ID_PARAM").jqGrid('hideCol',"PER_ITEM_ID_PARAM").setGridWidth($!{jqGrid_width});

		J("#list").jqGrid('setGroupHeaders', {
          useColSpanStyle: true,
          groupHeaders:[
		  	#foreach($list in $evalScorelist)
				#if($velocityCount != 1)
					,
				#end
				{startColumnName: 'SCORE_$!{CS_HTML.txt2html($list.EVAL_SCORE_ID)}', numberOfColumns: 1, titleText: '<em>$!{CS_HTML.txt2html($list.CONTENT)}</em>'}
			#end
          ]
        });

		/******************************************
		 * 취소버튼 (돌아가기)
		 ******************************************/
		J("#btnBack").click(function() {
			J("#form1").attr("action", "$!{context_path}/bsc/ahp/ahpEval/ahpEvalList.vw?type=template").submit();
		});

		/******************************************
		 * 저장버튼 이벤트
		 ******************************************/
		J("#btnInsert").click(function(e) {
			e.preventDefault();
			saveChk();
		});

		/******************************************
		 * 평가제출버튼 이벤트
		 ******************************************/
		J("#btnSubmit").click(function(e) {
			e.preventDefault();
			saveSubmitChk();
		});

		/******************************************
		 * 평가제출 취소버튼 이벤트
		 ******************************************/
		J("#btnSubmitReject").click(function(e) {
			e.preventDefault();
			saveSubmitRejectChk();
		});

		/******************************************
		 * 저장버튼 이중 클릭 방지
		 ******************************************/
		J("form").submit(function(){
			J("#btnInsert").unbind();
		});

		/******************************************
		 * 엑셀다운로드 버튼 클릭 이벤트
		 ******************************************/
		J("#btnExcelDown").click(function() {
			excelDownload();
			return false;
		});
	});

	/******************************************
	 * jqGrid 기준대상
	 ******************************************/
	function linkItemId(cellvalue, options, rowObject) {
		return '<input type="text" name="itemIds" value="' + cellvalue + '" class="inputbox wp70" />';
	}

	/******************************************
	 * jqGrid 기준대상
	 ******************************************/
	function linkPerItemId(cellvalue, options, rowObject) {
		return '<input type="text" name="perItemIds" value="' + cellvalue + '" class="inputbox wp70" />';
	}

	/******************************************
	 * jqGrid 수정페이지 링크
	 ******************************************/
	function linkRadioCheck(cellvalue, options, rowObject) {
		var str = '<input type="radio" name="evalScore_' + rowObject.ITEM_ID + "_" + rowObject.PER_ITEM_ID + '" value="' + cellvalue + '">';

		if(cellvalue == rowObject.EVAL_SCORE_ID) {
			str = '<input type="radio" name="evalScore_' + rowObject.ITEM_ID + "_" + rowObject.PER_ITEM_ID + '" value="' + cellvalue + '" checked="checked">';
		}
		return str;
	}

	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk() {
		#if($!{evalStatus.EVAL_SUBMIT_YN} == 'Y' )
			J.showMsgBox("이미 제출되었습니다.", null, null);
		#else
			J.showConfirmBox("저장하시겠습니까?", "saveDo"); //saveDo() 콜백함수 호출
		#end
	}

	/******************************************
	 * 저장
	 ******************************************/
	function saveDo() {
		J("#mode").val("MOD");
		J("#form1").attr("action", "$!{context_path}/bsc/ahp/ahpEval/ahpEvalProcess.vw?type=template").submit();
	}

	/******************************************
	 * 평가제출 체크
	 ******************************************/
	function saveSubmitChk() {
    	try {
    		var totCnt = "";
    		var evalCnt = "";

    		totCnt = J("input:radio", "#list").length / $!{evalScorelist.size()};
    		evalCnt = J("input:radio:checked", "#list").length;

    		if(totCnt > evalCnt) {
    			J.showMsgBox("평가하지 않은 항목이 있습니다.", null, null);
    			return;
    		} else {
    			J.showConfirmBox("평가제출 하시겠습니까?", "saveSubmitDo"); //saveSubmitDo() 콜백함수 호출
    			return;
    		}
    	} catch(err) {}
	}

	/******************************************
	 * 평가제출
	 ******************************************/
	function saveSubmitDo() {
		J("#mode").val("SUBMIT");
		J("#evalSubmitYn").val("Y");
		J("#form1").attr("action", "$!{context_path}/bsc/ahp/ahpEval/ahpEvalProcess.vw?type=template").submit();
	}

	/******************************************
	 * 평가제출 취소 체크
	 ******************************************/
	function saveSubmitRejectChk() {
		J.showConfirmBox("평가제출을 취소 하시겠습니까?", "saveSubmitRejectDo"); //saveSubmitRejectDo() 콜백함수 호출
	}

	/******************************************
	 * 평가제출취소
	 ******************************************/
	function saveSubmitRejectDo() {
		J("#mode").val("SUBMIT_REJECT");
		J("#evalSubmitYn").val("N");
		J("#form1").attr("action", "$!{context_path}/bsc/ahp/ahpEval/ahpEvalProcess.vw?type=template").submit();
	}

	/******************************************
	 * 엑셀다운로드
	 ******************************************/
	function excelDownload(){
		J("#findYear").val(J("#year").val());
		J("#findItemGrpId").val(J("#itemGrpId").val());
		J("#findEvalUserGrpId").val(J("#evalUserGrpId").val());
		J("#findEvalUserId").val(J("#evalUserId").val());
		J("#excelForm").attr("action", "$!{context_path}/bsc/ahp/ahpEval/ahpEvalDetailExcel.vw?type=excel").submit();
		return false;
	}
//]]>
</script>

<form id="form1" name="form1" method="post" action="$!{context_path}/bsc/ahp/ahpEval/ahpEvalProcess.vw?type=template">
    <input type="hidden" 	id="mode"		    name="mode"		      value="$!{searchMap.txt2html("mode")}" />
	<input type="hidden"	id="year"           name="year"           value="$!{searchMap.txt2html("year")}" />
	<input type="hidden"	id="itemGrpId"      name="itemGrpId"      value="$!{searchMap.txt2html("itemGrpId")}" />
	<input type="hidden"	id="evalUserGrpId"  name="evalUserGrpId"  value="$!{searchMap.txt2html("evalUserGrpId")}" />
	<input type="hidden"	id="evalUserId"     name="evalUserId"     value="$!{searchMap.txt2html("evalUserId")}" />
	<input type="hidden"	id="perItemId"      name="perItemId"      value="$!{searchMap.txt2html("perItemId")}" />
	<input type="hidden"	id="itemId"         name="itemId"         value="$!{searchMap.txt2html("itemId")}" />
	<input type="hidden"	id="evalSubmitYn"   name="evalSubmitYn" />

    $!{searchMap.makeHiddenFind()}

    <div id="Table">
    	<div id="Table_blockContainer">
    		<div class="tableTop">
    			#parse("/WEB-INF/vl/common/template/tabs.vm")
    			<div class="clear"></div>
    		</div>
			<div class="tableTop">
                <!-- 검색 테이블 Start -->
                <div class="searchBox">
                <div><div><div>
                    <table summary="검색조건">
                        <caption class="none">검색조건</caption>
                        <thead><tr><th></th><th></th></tr></thead>
                        <tbody>
                            <tr>
								<td class="searchBox_tit w180">$!{YEAR} <span class="searchBar">$!{searchMap.txt2html("findYear")}년</span></td>
								<td class="searchBox_tit w180">평가자 <span class="searchBar">$!{evalUserNm}</span></td>
								<td class="searchBox_tit w250">평가단 <span class="searchBar">$!{evalUserGrpNm}</span></td>
								<td class="searchBox_tit w250">평가대상그룹 <span class="searchBar">$!{itemGrpNm}</span></td>
							</tr>
                        </tbody>
                    </table>
                </div></div></div>
                </div>
                <!--// 검색 테이블 End -->
                <div class="clear"></div>
            </div>
			<div id="splitterBox">
				<div>
					<!-- 데이터그리드 Start -->
					<div class="blockGridListTable">
						<table id="list" summary="AHP 평가실시 조회결과">
							<caption class="none">AHP 평가실시 조회</caption>
							<thead><tr><th></th></tr></thead>
							<tbody><tr><td></td></tr></tbody>
						</table>
						<div id="pager"></div>
					</div>
					<!--// 데이터그리드 End -->
					<div class="blockButton_all">
						<div class="blockButton_l">
							<div class="blockButton" style="float:left; text-align:left; width:530px;">
							<input id="btnExcelDown" type="button" align="middle" value="엑셀변환" alt="엑셀다운로드" /><br/>
							※평가상태 : <span class="strong">$!{evalStatus.EVAL_SUBMIT_YN_NM}</strong> <br/>
							</div>
						</div>
						<div class="blockButton">
							<ul>
								<li><input type="button" id="btnBack"   value="돌아가기" /></li>
								#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("60"))
									#if($!{evalStatus.EVAL_SUBMIT_YN} == 'Y' )
										<li><input type="button" id="btnSubmitReject" value="제출취소" /></li>
									#end
								#end
								<li><input type="button" id="btnInsert" value="저장" /></li>

								#if($!{evalStatus.EVAL_SUBMIT_YN} == 'N' )
									<li><input type="submit" id="btnSubmit" value="평가제출" /></li>
								#end
							</ul>
						</div>
					</div>
				</div>
			</div>
    	</div>
    	<div class="clear"></div>
    </div>
</form>

<form id="excelForm" name="excelForm" method="post" action="$!{context_path}/bsc/ahp/ahpEval/ahpEvalDetailExcel.vw">
	<input type="hidden" id="findYear"			name="findYear" />
	<input type="hidden" id="findYearNm"		name="findYearNm" />
	<input type="hidden" id="findItemGrpId"		name="findItemGrpId" />
	<input type="hidden" id="findEvalUserGrpId"	name="findEvalUserGrpId" />
	<input type="hidden" id="findEvalUserId"	name="findEvalUserId" />
</form>