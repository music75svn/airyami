<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="mem.tot.memDissent">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: MEM_DISSENT
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 이의신청 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_EVAL_GRP
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT
		       A.YEAR
		     , A.DISSENT_SEQ
		     , A.DISSENT_TITLE
		     , B.DEPT_CD
		     , F_DEPT_LEV2_NM(A.YEAR, B.DEPT_CD) AS DEPT_NM
		     , A.EMP_NO
		     , B.KOR_NM AS EMP_NM
		     , TO_CHAR(A.CREATE_DT, 'YYYY.MM.DD') AS CREATE_DT
		     , A.PROC_STATUS_ID
		     , F_CODE_NM('249', A.PROC_STATUS_ID , A.YEAR) AS PROC_STATUS_NM 
		     , TO_CHAR(A.PROC_DT, 'YYYY.MM.DD') AS PROC_DT
		  FROM MEM_DISSENT A
		     , BSC_INSA B
		 WHERE 1 = 1
		   AND A.YEAR = B.YEAR
		   AND A.EMP_NO = B.EMPN
		   AND A.YEAR = #findYear#
	<isNotEmpty prepend="AND" property="findProcStatusId">
			   A.PROC_STATUS_ID = #findProcStatusId#
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="sEmpNo">
			   A.EMP_NO = #sEmpNo#
	</isNotEmpty>
		   AND A.DELETE_DT IS NULL
		 ORDER BY A.CREATE_DT DESC
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_DISSENT
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT
		       A.YEAR
		     , A.DISSENT_SEQ
		     , A.DISSENT_TITLE
		     , A.DISSENT_CONTENT
		     , A.CHECK_CONTENT
		     , B.DEPT_CD
		     , F_DEPT_LEV2_NM(A.YEAR, B.DEPT_CD) AS DEPT_NM
		     , A.EMP_NO
		     , B.KOR_NM AS EMP_NM
		     , TO_CHAR(A.CREATE_DT, 'YYYY.MM.DD') AS CREATE_DT
		     , A.PROC_STATUS_ID
		     , F_CODE_NM('249', A.PROC_STATUS_ID , A.YEAR) AS PROC_STATUS_NM 
		     , TO_CHAR(A.PROC_DT, 'YYYY.MM.DD') AS PROC_DT
		  FROM MEM_DISSENT A
		     , BSC_INSA B
		 WHERE 1 = 1
		   AND A.YEAR = B.YEAR
		   AND A.EMP_NO = B.EMPN
		   AND A.DELETE_DT IS NULL
		   AND A.YEAR = #year#
		   AND A.DISSENT_SEQ = #dissentSeq#	      
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 첨부파일 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_DISSENT_ATTACH
	==================================================================
	-->
	<select id="getAttachFileList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR
		     , A.DISSENT_SEQ
		     , A.SEQ
             , A.ATTACH_FILE_NM
             , A.ATTACH_FILE_FNM
             , A.ATTACH_FILE_SUFFIX
             , A.ATTACH_FILE_PATH
          FROM MEM_DISSENT_ATTACH A
         WHERE A.YEAR = #year#
           AND A.DISSENT_SEQ = #dissentSeq#
          ORDER BY A.SEQ
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 첨부파일  양식 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: MEM_DISSENT_ATTACH
	==================================================================
	-->
	<select id="getFormAttachFileList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.FORM_CD
             , A.ATTACH_FILE_NM
             , A.ATTACH_FILE_FNM
             , A.ATTACH_FILE_SUFFIX
             , A.ATTACH_FILE_PATH
          FROM MEM_FORM_ATTACH A
         WHERE 1 = 1
           AND A.FORM_CD IN ('02', '03')
          ORDER BY A.FORM_CD
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 시컨스 조회
	  #	기능	: SELECT
	  #	TABLE	: MEM_DISSENT
	==================================================================
	-->
	<select id="getDissentSeq" parameterClass="hashMap" resultClass="hashMap">
		SELECT 
			   NVL(MAX(DISSENT_SEQ), 0) + 1 AS DISSENT_SEQ
		  FROM MEM_DISSENT
		 WHERE YEAR = #year#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 등록
	  #	기능	: INSERT
	  #	TABLE	: MEM_DISSENT
	==================================================================
	-->
	<insert id="insertData" parameterClass="hashMap">		
		INSERT INTO MEM_DISSENT (
		       YEAR
		     , DISSENT_SEQ
		     , DISSENT_TITLE
		     , EMP_NO
		     , PROC_STATUS_ID
		     , DISSENT_CONTENT
		     , CREATE_DT		     
			 ) VALUES ( 
			   #year#
			 , #dissentSeq#
			 , #dissentTitle#
			 , #sEmpNo#
			 , '01'
			 , #dissentContent#
			 , sysdate			
			 )
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 수정
	  #	기능	: UPDATE
	  #	TABLE	: MEM_DISSENT
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE MEM_DISSENT 
		   SET DISSENT_TITLE = #dissentTitle#
		<isNotEmpty property="procStatusId">
		     , PROC_STATUS_ID = #procStatusId#
		</isNotEmpty>
		     , DISSENT_CONTENT = #dissentContent#
		     , CHECK_CONTENT = #checkContent#
	<isNotEmpty property="procStatusId">
		<isNotEqual property="procStatusId" compareValue="01">
		     , PROC_DT = SYSDATE
		</isNotEqual>
	</isNotEmpty>
		     , MODIFY_DT      = SYSDATE 
		 WHERE YEAR = #year#
		   AND DISSENT_SEQ = #dissentSeq#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 이의신청 삭제
	  #	기능	: UPDATE
	  #	TABLE	: MEM_DISSENT
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">
		UPDATE MEM_DISSENT 
		   SET DELETE_DT      = SYSDATE 
		 WHERE YEAR = #year#
		   AND DISSENT_SEQ = #dissentSeq#
	</update>

	<!--
	==================================================================   
	  # 설명	: 첨부파일 삭제
	  #	기능	: INSERT
	  #	TABLE	: MEM_DISSENT_ATTACH
	==================================================================
	-->	
	<delete id="deleteFileInfo" parameterClass="hashMap">
		DELETE FROM MEM_DISSENT_ATTACH
		 WHERE YEAR = #findYear# 
		   AND DISSENT_SEQ = #dissentSeq#
		   AND SEQ = #seq#
	</delete>

	<!--
	==================================================================   
	  # 설명	: 첨부파일 등록
	  #	기능	: INSERT
	  #	TABLE	: MEM_DISSENT_ATTACH
	==================================================================
	-->	
	<insert id="insertFileInfo" parameterClass="hashMap">
		INSERT INTO MEM_DISSENT_ATTACH (
			   YEAR	
             , DISSENT_SEQ
             , SEQ
             , ATTACH_FILE_NM
             , ATTACH_FILE_FNM
             , ATTACH_FILE_SUFFIX
             , ATTACH_FILE_PATH
             , CREATE_DT
           ) VALUES (
           	   #year#	
             , #dissentSeq#
             , (SELECT NVL(MAX(SEQ)+1,1) FROM MEM_DISSENT_ATTACH WHERE YEAR = #year# AND DISSENT_SEQ = #dissentSeq#)
             , #attachFileNm#
             , #attachFileFnm#
             , #attachFileSufix#
             , #attachFilePath#
             , SYSDATE
    	   )       
	</insert>
</sqlMap>