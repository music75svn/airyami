<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="cbe.eval.evalWeightMapping">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
	 

	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR,
               A.EVAL_DEGREE_ID,
               A.WEIGHT_GRP_ID,
               A.WEIGHT_GRP_NM,
               F_CBE_GRP_DEPT_LIST(A.YEAR, A.EVAL_DEGREE_ID, A.WEIGHT_GRP_ID, 'CBE_WEIGHT_GRP_DEPT', 'SC_DEPT_NM') DEPT_NM,
               F_CBE_GRP_JIKGUB_LIST(A.YEAR, A.EVAL_DEGREE_ID, A.WEIGHT_GRP_ID, 'CBE_WEIGHT_GRP_JIKGUB') JIKGUB_NM,
               A.WORK_TERM,
               (SELECT COUNT(*)
                  FROM CBE_EVAL_MASTER B
                WHERE B.YEAR=A.YEAR
                    AND B.EVAL_DEGREE_ID = A.EVAL_DEGREE_ID
                    AND B.WEIGHT_GRP_ID=A.WEIGHT_GRP_ID) USER_CNT,
               TO_CHAR(A.REFL_DT, 'YYYYMMDD') AS REFL_DT,
               A.SORT_ORDER
          FROM CBE_WEIGHT_GRP A
         WHERE A.YEAR=#findYear#
           AND A.EVAL_DEGREE_ID=#findEvalDegreeId#
         ORDER BY A.SORT_ORDER 
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 상세 보기
	  #	기능	: SELECT
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->
	<select id="getDetail" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR                  
			 , EVAL_DEGREE_ID        
			 , WEIGHT_GRP_ID         
			 , WEIGHT_GRP_NM
			 , WORK_TERM
		  FROM CBE_WEIGHT_GRP
		 WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
	</select>
	
	
	
	<!--
	==================================================================   
	  # 설명	: 직급 목록 조회
	  #	기능	: SELECT
	  #	TABLE	: CBE_WEIGHT_GRP_JIKGUB
	==================================================================
	-->
	<select id="getJikgubList" parameterClass="hashMap" resultClass="hashMap">
		SELECT JIKGUB_ID, JIKGUB_NM
		  FROM CBE_EVAL_MASTER
		 WHERE 1=1
		   AND YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND JIKGUB_NM IS NOT NULL
		 GROUP BY JIKGUB_ID, JIKGUB_NM
		 ORDER BY JIKGUB_ID, JIKGUB_NM   
		
	</select>
	
	
	<!--
	==================================================================   
	  # 설명	: 직급 목록 조회
	  #	기능	: SELECT
	  #	TABLE	: CBE_WEIGHT_GRP_JIKGUB
	==================================================================
	-->
	<select id="jikgubList" parameterClass="hashMap" resultClass="hashMap">
		SELECT YEAR
		     , JIKGUB_ID
		FROM CBE_WEIGHT_GRP_JIKGUB 
		WHERE YEAR = #year#
		  AND EVAL_DEGREE_ID=#evalDegreeId#
		  AND WEIGHT_GRP_ID=#weightGrpId#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 직급 목록 조회
	  #	기능	: SELECT
	  #	TABLE	: CBE_WEIGHT_GRP_JIKGUB
	==================================================================
	-->
	<select id="deptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT MAX(F_CBE_GRP_DEPT_LIST(#year#, #evalDegreeId#, #weightGrpId#, 'CBE_WEIGHT_GRP_DEPT', 'SC_DEPT_NM')) SC_DEPT_NM,
		       REPLACE(MAX(F_CBE_GRP_DEPT_LIST(#year#, #evalDegreeId#, #weightGrpId#, 'CBE_WEIGHT_GRP_DEPT', 'SC_DEPT_ID') ) 
		       		 ,','
		       		 ,'|') SC_DEPT_ID    
          FROM CBE_WEIGHT_GRP_DEPT A
         INNER JOIN BSC_SC_DEPT B ON A.YEAR=B.YEAR AND A.SC_DEPT_ID=B.SC_DEPT_ID
         WHERE A.YEAR=#year#
           AND A.EVAL_DEGREE_ID=#evalDegreeId#
           AND A.WEIGHT_GRP_ID=#weightGrpId#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 지표Pool 사용중인 지표목록 보기
	  #	기능	: SELECT
	  #	TABLE	: BSC_METRIC
	==================================================================
	-->
	<select id="getUseScDeptList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.SC_DEPT_ID,
		       B.SC_DEPT_NM
          FROM CBE_WEIGHT_GRP_DEPT A
         INNER JOIN BSC_SC_DEPT B ON A.YEAR=B.YEAR AND A.SC_DEPT_ID=B.SC_DEPT_ID
         WHERE A.YEAR=#findYear#
           AND A.EVAL_DEGREE_ID=#evalDegreeId#
           AND A.WEIGHT_GRP_ID=#weightGrpId#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 등록
	  #	기능	: INSERT
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<insert id="insertData" parameterClass="hashMap">
		<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
			SELECT F_PGM_SERI('CBE_WEIGHT_GRP_DEPT','','','','','') SEQ FROM DUAL
		</selectKey>
		INSERT INTO CBE_WEIGHT_GRP_DEPT ( 
			   YEAR
			 , EVAL_DEGREE_ID
			 , WEIGHT_GRP_ID
			 , SC_DEPT_ID
			 , CREATE_DT
			 ) VALUES ( 
			   #year#
			 , #SEQ#
			 , #weightGrpId#
			 , #scDeptId#
			 , SYSDATE
			 )
	</insert>	
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 수정
	  #	기능	: UPDATE
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<update id="updateData" parameterClass="hashMap">
		UPDATE CBE_WEIGHT_GRP 
		   SET 	WORK_TERM = #workTerm#
		   , MODIFY_DT              = SYSDATE 	 
		   WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
	</update>	
	

	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<update id="deleteData" parameterClass="hashMap">
		DELETE FROM CBE_WEIGHT_GRP_DEPT 
		 WHERE 1 = 1 
		   AND YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
		   AND SC_DEPT_ID = #scDeptId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<update id="deleteDeptData" parameterClass="hashMap">
		DELETE FROM CBE_WEIGHT_GRP_DEPT 
		 WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<update id="deleteDeptPrsData" parameterClass="hashMap">
		DELETE FROM CBE_WEIGHT_GRP_DEPT 
		 WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
	</update>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 등록
	  #	기능	: INSERT
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<insert id="insertDeptData" parameterClass="hashMap">
		INSERT INTO CBE_WEIGHT_GRP_DEPT ( 
			   YEAR
			 , EVAL_DEGREE_ID
			 , WEIGHT_GRP_ID
			 , SC_DEPT_ID
			 , CREATE_DT
			 ) VALUES ( 
			   #year#
			 , #evalDegreeId#
			 , #weightGrpId#
			 , #scDeptId#
			 , SYSDATE
			 )
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 삭제
	  #	기능	: UPDATE
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<update id="deleteJikgubData" parameterClass="hashMap">
		DELETE FROM CBE_WEIGHT_GRP_JIKGUB 
		 WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
	</update>	
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 등록
	  #	기능	: INSERT
	  #	TABLE	: CBE_WEIGHT_GRP_DEPT
	==================================================================
	-->	
	<insert id="insertJikgubData" parameterClass="hashMap">
	<!-- 
		INSERT INTO CBE_WEIGHT_GRP_JIKGUB ( 
			   YEAR
			 , EVAL_DEGREE_ID
			 , WEIGHT_GRP_ID
			 , JIKGUB_ID
			 , CREATE_DT
			 ) VALUES ( 
			   #year#
			 , #evalDegreeId#
			 , #weightGrpId#
			 , #jikgubId#
			 , SYSDATE
			 )
	 -->
	 	MERGE INTO CBE_WEIGHT_GRP_JIKGUB O
	 	USING (SELECT #year# AS YEAR
				    , #evalDegreeId# AS EVAL_DEGREE_ID
				    , #weightGrpId# AS WEIGHT_GRP_ID
				    , #jikgubId# AS JIKGUB_ID
				    , SYSDATE AS CREATE_DT
			     FROM DUAL) I
	 	ON (O.YEAR = I.YEAR
	 	AND O.EVAL_DEGREE_ID = I.EVAL_DEGREE_ID
	 	AND O.WEIGHT_GRP_ID = I.WEIGHT_GRP_ID
	 	AND O.JIKGUB_ID = I.JIKGUB_ID)
	 	WHEN MATCHED THEN
	 		UPDATE SET O.CREATE_DT = I.CREATE_DT
	 	WHEN NOT MATCHED THEN
	 		INSERT (O.YEAR, O.EVAL_DEGREE_ID, O.WEIGHT_GRP_ID, O.JIKGUB_ID, O.CREATE_DT )
	 		VALUES (I.YEAR, I.EVAL_DEGREE_ID, I.WEIGHT_GRP_ID, I.JIKGUB_ID, I.CREATE_DT)
	</insert>
	
	
	<!--
	==================================================================   
	  # 설명	: 가중치그룹 수정
	  #	기능	: UPDATE
	  #	TABLE	: CBE_EVAL_MASTER
	==================================================================
	-->	
	<update id="updateWeightGrpData" parameterClass="hashMap">
		UPDATE CBE_EVAL_MASTER
		   SET WEIGHT_GRP_ID = #weightGrpId#
		     , EVAL_METHOD_GBN = '10'
		 WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND EVAL_MEMB_USER_ID = #reflUserId#
	</update>	
	
	<!--
	==================================================================   
	  # 설명	: 가중치그룹 수정
	  #	기능	: UPDATE
	  #	TABLE	: CBE_WEIGHT_GRP
	==================================================================
	-->	
	<update id="updateRivalGrpReflDtData" parameterClass="hashMap">
		UPDATE CBE_WEIGHT_GRP
   		   SET REFL_DT = SYSDATE
		 WHERE YEAR = #year#
		   AND EVAL_DEGREE_ID = #evalDegreeId#
		   AND WEIGHT_GRP_ID = #weightGrpId#
	</update>	
	
	<!--
	==================================================================   
	  # 설명	: 파라미터 맵
	  #	기능	: SETTING
	  #	TABLE	: 
	==================================================================
	-->		
	<parameterMap id="paramMap" class="java.util.HashMap">
		<parameter property="year" 				jdbcType="VARCHAR"  javaType="java.lang.String" mode="IN"/>	
		<parameter property="evalDegreeId" 		jdbcType="VARCHAR"  javaType="java.lang.String" mode="IN"/>
	</parameterMap>	
	
	
	<!--
	==================================================================   
	  # 설명	: 평가대상자매핑 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: CBE_EVAL_MASTER
	==================================================================
	-->
	<select id="getUserList" parameterClass="hashMap" resultClass="hashMap">
		SELECT A.YEAR,
	            A.EVAL_DEGREE_ID,
	            A.EVAL_MEMB_USER_ID, 
	            A.NAME,
	            A.WEIGHT_GRP_ID,
	            CASE WHEN B.WEIGHT_GRP_NM IS NULL THEN NULL ELSE B.WEIGHT_GRP_NM END WEIGHT_GRP_NM,
	            C.SC_DEPT_NM
	            , ITEM_FRS_DEPT_ID, ITEM_SEC_DEPT_ID, ITEM_TEAM_ID
                , FDM.SC_DEPT_NM AS ITEM_FRS_DEPT_NM
                , SDM.SC_DEPT_NM AS ITEM_SEC_DEPT_NM
                , TDM.SC_DEPT_NM AS ITEM_TEAM_NM
	            , A.JIKGUB_NM
	            , A.POS_NM
	            , F_CODE_NM('155', A.EVAL_METHOD_GBN, A.YEAR) AS EVAL_METHOD_GBN_NM
	            , A.WORK_TERM  
	  FROM CBE_EVAL_MASTER A
	  LEFT OUTER JOIN CBE_WEIGHT_GRP B 
	               ON A.YEAR=B.YEAR 
	              AND A.EVAL_DEGREE_ID = B.EVAL_DEGREE_ID 
	              AND A.WEIGHT_GRP_ID=B.WEIGHT_GRP_ID 
	  LEFT OUTER JOIN BSC_SC_DEPT C 
	               ON A.YEAR=C.YEAR 
	              AND A.SC_DEPT_ID=C.SC_DEPT_ID
	  LEFT OUTER JOIN BSC_SC_DEPT FDM ON A.YEAR = FDM.YEAR AND A.ITEM_FRS_DEPT_ID = FDM.SC_DEPT_ID
      LEFT OUTER JOIN BSC_SC_DEPT SDM ON A.YEAR = SDM.YEAR AND A.ITEM_SEC_DEPT_ID = SDM.SC_DEPT_ID
      LEFT OUTER JOIN BSC_SC_DEPT TDM ON A.YEAR = TDM.YEAR AND A.ITEM_TEAM_ID = TDM.SC_DEPT_ID	              
	WHERE A.YEAR = #year#
	     AND A.EVAL_DEGREE_ID = #evalDegreeId#
	     AND A.WORK_TERM <![CDATA[ >= ]]>(SELECT WORK_TERM
				                            FROM CBE_EVAL_INIT_INFO
				                           WHERE YEAR = #year#
				                             AND EVAL_DEGREE_ID=#evalDegreeId# )
     	AND A.SC_DEPT_ID IN (SELECT SC_DEPT_ID
                               FROM CBE_WEIGHT_GRP_DEPT
                              WHERE YEAR = #year#
                                AND EVAL_DEGREE_ID=#evalDegreeId#
                                AND WEIGHT_GRP_ID=#weightGrpId# )
    	AND A.JIKGUB_ID IN (SELECT JIKGUB_ID
                              FROM CBE_WEIGHT_GRP_JIKGUB
                             WHERE YEAR = #year#
                               AND EVAL_DEGREE_ID = #evalDegreeId#
                               AND WEIGHT_GRP_ID = #weightGrpId# )     
	</select>
	
	
</sqlMap>


