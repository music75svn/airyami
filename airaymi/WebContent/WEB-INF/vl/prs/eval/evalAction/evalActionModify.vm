#*************************************************************************
* CLASS 명      : evalActionModify
* 작 업 자      : 현걸욱 
* 작 업 일      : 2012년 11월 26일 
* 기    능      : 개인평가 평가실시 (현황)    
* ---------------------------- 변 경 이 력 --------------------------------
* 번호    작 업 자    작     업     일        변 경 내 용                비고
* ----  --------  -----------------  -------------------------  --------
*  1    현걸욱      2012년 11월 26일             최 초 작 업 
**************************************************************************# 
#set($curr_url = $!{context_path} + "/prs/eval/evalAction/evalActionModify.vw")
<script type="text/javascript" language="javascript" >
//<![CDATA[

	var J = jQuery;
	
	J(document).ready(function(){
    
		/******************************************
		 * 데이터 그리드 출력
		 ******************************************/
		var str = J('#formList').serialize();
		
		jQuery("#list").jqGrid({
			url          :"$!{context_path}/prs/eval/evalAction/evalActionModify_xml.vw" + "?" + str,
			mtype        :"POST",
			datatype     :"json",
			jsonReader   : {   
    						page   : "page",
    						total  : "total",
    						root   : "rows", 
    						records: function(obj){return obj.length;},
    						repeatitems: false, 
    						id     : "id"
    				       },
			height       : $!{jqGrid_height},
			width        : $!{jqGrid_width},
			colNames     :['EVAL_MEMB_USER_ID', '성명', '평가조직', 
			                #foreach($gradeList in $gradeList)
								'$!{CS_HTML.txt2html($gradeList.GRADE_ITEM_NM)}',
							#end
						   '피드백', 'EVAL_DEGREE_ID', 'EVAL_GRP_ID', 'DEPT_ID'],
			colModel     :[
							{name:'EVAL_MEMB_USER_ID'       ,index:'EVAL_MEMB_USER_ID'  ,width:150   ,align:'center' }, 
                            {name:'EVAL_MEMB_USER_NM'       ,index:'EVAL_MEMB_USER_NM'  ,width:150   ,align:'center' }, 
                            {name:'DEPT_NM'         		,index:'DEPT_NM'        	,width:200   ,align:'center' },
							
							#foreach($gradeList in $gradeList)
								{name:'$!{CS_HTML.txt2html($gradeList.GRADE_ITEM_ID)}'      ,index:'$!{CS_HTML.txt2html($gradeList.GRADE_ITEM_ID)}'   ,width:60   ,align:'center' ,formatter:linkRadioCheck},
							#end
							
							{name:'FEED'         			,index:'FEED'         		,width:300   ,align:'center' ,formatter:linkInputText},
                            {name:'EVAL_DEGREE_ID'         	,index:'EVAL_SEQ'         	,width:150   ,align:'center' }, 
                            {name:'EVAL_GRP_ID'      		,index:'EVAL_METHOD_ID'     ,width:150   ,align:'center' }, 
                            {name:'DEPT_ID'             	,index:'CONTENT'            ,width:300   ,align:'center' }
							],
			rowNum       : $!{jqGrid_rownum},
			autowidth    : false, 
			viewrecords  : true,
			loadonce     : true,
			multiselect  : false,
			cellEdit     : true,
			gridview     : true,
			loadComplete : function() {
			
								var gradeArray = new Array();
										
								#foreach($gradeList in $gradeList)
								
									var gradeId = '$!{CS_HTML.txt2html($gradeList.GRADE_ITEM_ID)}';
									
									gradeArray.push(gradeId);
									
    							#end
			
								var ids = J("#list").jqGrid('getDataIDs');
								if( ids.length > 0 ){
									for( var i = 1 ; i <= ids.length ; i++ ){
										
										var rowDatas = J("#list").getRowData(i);
										
										J("input[name=feeds]").each(function(index,value){
										
											J(this).addClass('inputbox w300');
											
										});
										
										J("input[name=feeds]").each(function(index,value){
										
											J(this).addClass('inputbox w300');
											
											$(this).bind('keyup',function(){
        										J(this).checkbyte({
                                        			limit:600
                                        		});
                                			});
											
											if('$!{searchMap.txt2html("evalSubmitYn")}' == 'Y'){
												J(this).attr('readonly','readonly');
											}
											
										});
										
										J('input[name=evalGrades'+i+']').each(function(index,value){
										
											J(this).val(gradeArray[index]);
											
											if('$!{searchMap.txt2html("evalSubmitYn")}' == 'Y'){
												J(this).attr('disabled','disabled');
											}
										
										});
									}
								}
                           },
			caption:"개인평가 평가실시 (현황)"
		}).jqGrid('hideCol',"EVAL_MEMB_USER_ID").jqGrid('hideCol',"EVAL_DEGREE_ID").jqGrid('hideCol',"EVAL_GRP_ID").jqGrid('hideCol',"DEPT_ID").setGridWidth($!{jqGrid_width});
		
		/******************************************
		 * 조회
		 ******************************************/
		J("#formFind").submit(function(event) {
			//submit 하기전 작업추가
		});
		
		/******************************************
		 * 취소버튼 (돌아가기)
		 ******************************************/
		J("#btnBack").click(function() {
			J("#formList").attr("action", "$!{context_path}/prs/eval/evalAction/evalActionList.vw?type=template").submit();
		});
        
		/******************************************
		 * 저장버튼 이벤트
		 ******************************************/
		J("#btnInsert").click(function(e) {
			e.preventDefault();
			saveChk();
		});
		
		/******************************************
		 * 제출버튼 이벤트
		 ******************************************/
		J("#btnSubmit").click(function(e) {
			e.preventDefault();
			chkSubmit();
		});
		
		/******************************************
		 * 제출취소버튼  이벤트
		 ******************************************/
		J("#btnSubmitCancel").click(function(e) {
			e.preventDefault();
			chkSubmitCancel();
		});

		/******************************************
		 * 저장버튼 이중 클릭 방지
		 ******************************************/
		J("form").submit(function(){
			J("#btnInsert").unbind();
		});
        
		/******************************************
		 * 엑셀다운로드 버튼 클릭 이벤트
		 ******************************************/
		J("#btnExcelDown").click(function() {
			excelDownload();
			return false;
		});
		
		/******************************************
		 * 엑셀다운로드 버튼 클릭 이벤트
		 ******************************************/
		J("#btnEvalBase").click(function() {
			popEvalBase();
			return false;
		});
	});

	/******************************************
	 * jqGrid 수정페이지 링크
	 ******************************************/
	function linkRadioCheck(cellvalue, options, rowObject) {
		var str = '<input type="radio" id="evalGrade'+options.rowId+'" name="evalGrades'+options.rowId+'" value="'+cellvalue+'">';
		
		if(cellvalue != ''){
			str = '<input type="radio" id="evalGrade'+options.rowId+'" name="evalGrades'+options.rowId+'" value="'+cellvalue+'" checked>';
		}
		
		return str;
	}
	
	/******************************************
	 * jqGrid 수정페이지 링크
	 ******************************************/
	function linkInputText(cellvalue, options, rowObject) { 
		return '<input type="text" id="feed'+options.rowId+'" name="feeds" value="'+cellvalue+'">';
	}
	
	/******************************************
	 * 필수입력 체크
	 ******************************************/
	function saveChk() {
		var ids = J("#list").jqGrid('getDataIDs');
		var rowdata = "";
		var val = "";
		var cnt = 0;
		var countChk = true;
		
		if(ids.length == 0){
			J.showMsgBox("저장할 데이터가 없습니다..", null, null);
			return false;
		}
		
		#foreach($gradeList in $gradeList)
								
    		var gradeId = '$!{CS_HTML.txt2html($gradeList.GRADE_ITEM_ID)}';
			var distCnt = '$!{CS_HTML.txt2html($gradeList.ITEM_DISTRI_CNT)}';
    		
			cnt = 0;
			
    		for (var i = 1; i <= ids.length; i++) {
				
    			val = J(':radio[name="evalGrades'+i+'"]:checked').val();
    			
				if(val == gradeId){
					cnt++;
				}
    		}
			
			if(cnt != distCnt){
				countChk = false;
			}
    		
    	#end
		
		if(!countChk){
		
			J.showMsgBox("각 등급에 따른 제한 명수를 확인하십시요.", null, null);
			return false;
		}
		
		J.showConfirmBox("저장하시겠습니까?", "saveDo"); //saveDo() 콜백함수 호출
	}
	
	/******************************************
	 * 저장
	 ******************************************/
	function saveDo() {
	
		var ids = J("#list").jqGrid('getDataIDs');
		var rowdata = "";
		var userIds = "";
		var gradeIds = "";
		
		for (var i = 1; i <= ids.length; i++) {
			var rowDatas = J("#list").getRowData(i);	
			userIds += rowDatas.EVAL_MEMB_USER_ID + '|';
    		gradeIds += J(':radio[name="evalGrades'+i+'"]:checked').val() + '|';
    	}
		
		J('#mode').val('MOD');
		J('#userIds').val(userIds);
		J('#gradeIds').val(gradeIds);
	
		J("#formList").attr("action", "$!{context_path}/prs/eval/evalAction/evalActionProcess.vw?type=template").submit();
	}
	
	/******************************************
	 * 제출
	 ******************************************/
	function chkSubmit() {
	
		if('$!{searchMap.txt2html("totCnt")}' != '$!{searchMap.txt2html("evalCnt")}'){
			J.showMsgBox("평가한 내용을 먼저 저장해 주십시요.", null, null); 
			return false;
		}

		J.showConfirmBox("평가를 제출 하시겠습니까?", "submitDo"); //submitDo() 콜백함수 호출
	}
	
	/******************************************
	 * 제출취소
	 ******************************************/
	function chkSubmitCancel() {
	
		if('$!{CS_HTML.txt2html($confirmYn)}' == 'Y'){
			J.showMsgBox("평가가 확정되어 평가제출을 취소할수 없습니다.", null, null);
			return false;
		}
	
		if('$!{CS_HTML.txt2html($closeYn)}' == 'Y'){
			J.showMsgBox("평가가 마감되어 평가제출을 취소할수 없습니다.", null, null);
			return false;
		}
		
		J.showConfirmBox("평가제출을 취소 하시겠습니까?", "submitCancelDo"); //closeCancelDo() 콜백함수 호출
	}
	
	/******************************************
	 * 제출
	 ******************************************/
	function submitDo() {

		J('#mode').val('SUB');
		J('#evalSubmitYn').val('Y');
		J("#formList").attr("action", "$!{context_path}/prs/eval/evalAction/evalActionProcess.vw?type=template").submit();
	}
	
	/******************************************
	 * 제출취소
	 ******************************************/
	function submitCancelDo() {
		J('#mode').val('SUB');
		J('#evalSubmitYn').val('N');
		J("#formList").attr("action", "$!{context_path}/prs/eval/evalAction/evalActionProcess.vw?type=template").submit();
	}
	
	/******************************************
	 * 수정
	 ******************************************/
	function popEvalBase() {
		
		var findYear = J("#year").val();
		var findEvalDegreeId = J("#evalDegreeId").val();
		
		var param = "&amp;findYear=" + findYear +"&amp;findEvalDegreeId=" + findEvalDegreeId;
		
		var url = "$!{context_path}/prs/eval/evalBase/popEvalBaseList.vw?type=popup" + param;
		openWinByName(url,'evalBasePop','650','450','yes');
	}
    
	/******************************************
	 * 엑셀다운로드
	 ******************************************/
	function excelDownload(){
		J("#yearNm").val(J("#findYear > option:selected").text());
		J("#findEvalDegreeNm").val(J("#findEvalDegreeId > option:selected").text());
		J("#findEvalUserNm").val(J("#findEvalUserId > option:selected").text());
		J("#formList").attr("action", "$!{context_path}/prs/eval/evalAction/evalActionListExcel.vw?type=excel").submit();
		return false;
	}

//]]>
</script>

<div id="Table">
	<div id="Table_blockContainer">
		<h1 class="none">개인평가 평가실시 (현황)</h1>
		<div class="tableTop">
			#parse("/WEB-INF/vl/common/template/tabs.vm")
				
				<div class="searchBox">
    				<div><div><div>
    				<table summary="개인평가 평가실시 (현황)검색 조건">
						<caption class="none">개인평가 평가실시 (현황) 검색 조건</caption> 
						<thead><tr><th></th></tr></thead>
        				<tbody>
            				<tr>
								<td class="searchBox_tit w250">
            						<span><label for="year">$!{YEAR}</label></span>
            						<span class="searchBar">
            							$!CS_CODE.getCodeName("017", $!{searchMap.txt2html("year")})
            						</span>
            					</td>
								
								<td class="searchBox_tit w250">
                					<span><label for="evalDegreeNm">평가구분</label></span>
									<span class="searchBar">
										$!{searchMap.txt2html("evalDegreeNm")}
									</span>
                                </td>
								
            					<td class="searchBox_tit w250">
                					<span><label for="evalUserNm">평가자</label></span>
									<span class="searchBar">
										$!{searchMap.txt2html("evalUserNm")}
									</span>
                                </td>
								
								<td class="searchBox_tit w250">
                					<span><label for="evalGrpNm">평가군</label></span>
									<span class="searchBar">
										$!{searchMap.txt2html("evalGrpNm")}
									</span>
                                </td>
            				</tr>
        				</tbody>
    				</table>
                    </div></div></div>
    	        </div>
    		<!-- search E -->
			<div class="clear"></div>
		</div>
		
		<form id="formList" name="formList" method="post" action="$!{context_path}/prs/eval/evalAction/evalActionProcess.vw?type=template">
			<input type="hidden" id="mode"       			name="mode" 		value="$!{searchMap.txt2html("mode")}" />
			<input type="hidden" id="year"       			name="year" 		value="$!{searchMap.txt2html("year")}" />
			<input type="hidden" id="evalGrpId"     		name="evalGrpId" 	value="$!{searchMap.txt2html("evalGrpId")}" />
			<input type="hidden" id="evalDegreeId"   		name="evalDegreeId" value="$!{searchMap.txt2html("evalDegreeId")}" />
			<input type="hidden" id="evalUserId"     		name="evalUserId" 	value="$!{searchMap.txt2html("evalUserId")}" />
			<input type="hidden" id="totCnt"       			name="totCnt" 		value="$!{searchMap.txt2html("totCnt")}" />
			<input type="hidden" id="userIds"       		name="userIds" 		value="$!{searchMap.txt2html("userIds")}" />
			<input type="hidden" id="gradeIds"       		name="gradeIds" 	value="$!{searchMap.txt2html("gradeIds")}" />
			<input type="hidden" id="evalSubmitYn"       	name="evalSubmitYn" 	value="$!{searchMap.txt2html("evalSubmitYn")}" />
			$!{searchMap.makeHiddenFind()}
			<div id="splitterBox">
				<div>
					<!-- 데이터그리드 Start -->
					<div class="blockGridListTable">
						<table id="list" summary="개인평가 평가실시 (현황) 조회결과">
							<caption class="none">개인평가 평가실시 (현황) 조회</caption>
							<thead><tr><th></th></tr></thead>
							<tbody><tr><td></td></tr></tbody>
						</table>
						<div id="pager"></div>
					</div>
					<!--// 데이터그리드 End -->
					<div class="blockButton_all">
						<div class="txt_blue">
							&nbsp;* 평가대상자 : 총 $!{searchMap.txt2html("totCnt")} 명
							&nbsp;&nbsp;
							*
							#foreach($gradeList in $gradeList)
								$!{CS_HTML.txt2html($gradeList.GRADE_ITEM_NM)}등급:$!{CS_HTML.txt2html($gradeList.ITEM_DISTRI_CNT)}명
							#end
							</br>
						</div>
						<div class="blockButton">
							<ul>
								<li><input type="button" id="btnEvalBase" value="평가요소" /></li>
								<li><input type="button" id="btnBack" value="돌아가기" /></li>
								#if($!{searchMap.txt2html("evalSubmitYn")} == 'N')
								<li><input type="button" id="btnInsert" value="저장" /></li>
								<li><input type="button" id="btnSubmit" value="평가제출" /></li>
								#else
									#if($CS_LOGIN.chkAuthGrp("01") || $CS_LOGIN.chkAuthGrp("60"))
										<li><input type="button" id="btnSubmitCancel" value="평가제출취소" /></li>
									#end
								#end
							</ul>
						</div>
					</div>
				</div>
			</div>
		</form>
		
	</div>
	<div class="clear"></div>
</div>

