<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="prs.dir.jobRpt">

	<!--
	==================================================================   
	  # 설명	: typeAlias 선언
	  #	기능	: SETTING
	  #	TABLE	: PRS_EVAL_GRP
	==================================================================
	-->
	<typeAlias alias="hashMap" 			type="java.util.HashMap" />
    <typeAlias alias="detailMap" 		type="java.util.HashMap"/>
    <typeAlias alias="rptParam" 		type="java.util.HashMap"/>

	<!--
	==================================================================   
	  # 설명	: 임원평가 직무성과기술서 제출기간 조회
	  #	기능	: SELECT
	  #	TABLE	: PRS_EVAL_SCHEDULE
	==================================================================
	-->
	<select id="getRptSchedule" parameterClass="hashMap" resultClass="hashMap">
		SELECT DIR_RPT_START_DT, DIR_RPT_END_DT
		     , CASE WHEN SYSDATE BETWEEN TO_DATE(DIR_RPT_START_DT, 'rrrr-mm-dd') AND TO_DATE(DIR_RPT_END_DT || '23:59:59', 'rrrr-mm-dd hh24:mi:ss') THEN 'T'
		            ELSE 'N' END JOBRPT_YN
		  FROM PRS_EVAL_SCHEDULE
		 WHERE 1 = 1
		 <isNotEmpty prepend="AND" property="findYear">
			YEAR = #findYear#
		 </isNotEmpty>
		 <isNotEmpty prepend="AND" property="year">
			YEAR = #year#
		 </isNotEmpty>
	</select>

	<!--
	==================================================================   
	  # 설명	: 임원평가 직무성과기술서 목록 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_DIR_EVAL_MEMBER
	==================================================================
	-->
	<select id="getList" parameterClass="hashMap" resultClass="hashMap">
		  SELECT A.YEAR
    		   , A.EMPN
		       , A.KOR_NM
    		   , A.CAST_TC
		       , A.POS_TC
		       , A.DUTY_START_DT
		       , A.DUTY_END_DT
		       , A.RPT_SUBMIT_YN
		       , (
		     	SELECT CODE_NM FROM BSC_CODE 
		     	 WHERE YEAR = A.YEAR AND CODE_GRP_ID = '179' 
		     	   AND CODE_ID = (
							        CASE 
							            WHEN A.RPT_SUBMIT_YN IS NULL THEN '03'               
							            WHEN A.RPT_SUBMIT_YN = 'N' THEN '02'               
							            WHEN A.RPT_SUBMIT_YN = 'Y' THEN '01'               
							            ELSE ''                
        							END)
        	   ) RPT_SUBMIT_YN_NM
    		FROM PRS_DIR_EVAL_MEMBER A
		   WHERE A.YEAR = #findYear#
		     AND A.EVAL_YN = 'Y'
<![CDATA[
   		   AND A.POS_TC <> '00'
]]>
           <isEqual prepend="AND" property="findSubmitYn" compareValue="01">
				A.RPT_SUBMIT_YN = 'Y'
           </isEqual>
           <isEqual prepend="AND" property="findSubmitYn" compareValue="02">
				A.RPT_SUBMIT_YN = 'N'
           </isEqual>
           <isEqual prepend="AND" property="findSubmitYn" compareValue="03">
				A.RPT_SUBMIT_YN IS NULL
           </isEqual>
		 ORDER BY A.POS_TC, A.EMPN
	</select>
	
    <!--
	==================================================================   
	  # 설명	: 직무성과기술서 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_DIR_EVAL_MEMBER
	==================================================================
	-->
	<resultMap id="detailMap" class="java.util.HashMap">
        <result property="YEAR"						column="YEAR" />                                   
		<result property="EMPN"						column="EMPN" />
		<result property="DUTY_START_DT"			column="DUTY_START_DT" />
		<result property="DUTY_END_DT"				column="DUTY_END_DT" />
		<result property="RPT_SUBMIT_YN"			column="RPT_SUBMIT_YN" />
		<result property="KOR_NM"					column="KOR_NM" />
		<result property="POS_TC_NM"				column="POS_TC_NM" />
		<result property="RPT_CONTENT"              column="RPT_CONTENT"			jdbcType="CLOB"		javaType="String"	/>
		<result property="DEPT_CD"              	column="DEPT_CD" />
    </resultMap>
    
	<select id="getDirRpt" parameterClass="java.util.HashMap" resultClass="detailMap">
		SELECT A.YEAR
		     , A.KOR_NM
		     , A.DEPT_CD
		     , (SELECT CODE_NM
		          FROM BSC_CODE
		         WHERE YEAR = A.YEAR
		           AND CODE_GRP_ID = '171'
		           AND CODE_ID = A.POS_TC)
		          POS_TC_NM
		     , A.EMPN
		     , A.DUTY_START_DT
		     , A.DUTY_END_DT
		     , A.RPT_SUBMIT_YN
		     , A.RPT_CONTENT
		     , (SELECT CODE_NM FROM BSC_CODE WHERE YEAR = A.YEAR AND CODE_GRP_ID = '171' AND CODE_ID = A.pos_tc) POS_TC_NM
		  FROM PRS_DIR_EVAL_MEMBER A
		 WHERE A.YEAR = #year#
		   AND A.EMPN = #empn#
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 직무성과기술서 저장
	  #	기능	: MERGE INTO
	  #	TABLE	: PRS_DIR_EVAL_MEMBER
	==================================================================
	-->	
	<parameterMap id="rptParam" class="java.util.HashMap">
        <parameter property="year" 			jdbcType="VARCHAR2" 		javaType="String"	mode="IN"/>        
        <parameter property="empn"			jdbcType="VARCHAR2" 		javaType="String"	mode="IN"/>
        <parameter property="dutyStartDt"	jdbcType="VARCHAR2" 		javaType="String"	mode="IN"/>
        <parameter property="dutyEndDt"		jdbcType="VARCHAR2" 		javaType="String"	mode="IN"/>
        <parameter property="rptSubmitYn" 	jdbcType="VARCHAR2" 		javaType="String"	mode="IN"/>
        <parameter property="rptContent" 	jdbcType="CLOB" 			javaType="String"	mode="IN"/>
    </parameterMap>
    
	<update id="updateData" parameterClass="hashMap">
            UPDATE PRS_DIR_EVAL_MEMBER SET RPT_CONTENT = #rptContent:CLOB#, RPT_SUBMIT_YN = #rptSubmitYn#
             WHERE YEAR = #year# AND EMPN = #empn#
	</update>	
	
	<!--
	==================================================================   
	  # 설명	: 첨부파일 삭제
	  #	기능	: INSERT
	  #	TABLE	: PRS_DIR_RPT_ATTACH
	==================================================================
	-->	
	<delete id="deleteFileInfo" parameterClass="hashMap">
		DELETE FROM PRS_DIR_RPT_ATTACH
		 WHERE YEAR = #year# AND EMPN = #empn# AND SEQ = #seq#
	</delete>
	
	<!--
	==================================================================   
	  # 설명	: 첨부파일 등록
	  #	기능	: INSERT
	  #	TABLE	: PRS_DIR_RPT_ATTACH
	==================================================================
	-->	
	<insert id="insertFileInfo" parameterClass="hashMap">
		<selectKey resultClass="java.lang.String" keyProperty="SEQ" >
	        SELECT NVL(MAX(SEQ)+1,1) SEQ
	          FROM PRS_DIR_RPT_ATTACH
	         WHERE YEAR = #year# AND EMPN = #empn#
		</selectKey>
		INSERT INTO PRS_DIR_RPT_ATTACH (
               YEAR
			 , EMPN
			 , SEQ
			 , ATTACH_FILE_NM
			 , ATTACH_FILE_FNM
			 , ATTACH_FILE_SUFFIX
			 , ATTACH_FILE_PATH
            ) VALUES (
               #year#
             , #empn#
             , #SEQ#
             , #attachFileNm#
             , #attachFileFnm#
             , #attachFileSufix#
             , #attachFilePath#
    	   )       
	</insert>
	
	<!--
	==================================================================   
	  # 설명	: 첨부파일 보기
	  #	기능	: SELECT
	  #	TABLE	: PRS_DIR_RPT_ATTACH
	==================================================================
	-->
	<select id="getFileList" parameterClass="hashMap" resultClass="hashMap">
		SELECT   YEAR
		       , EMPN
		       , SEQ
		       , ATTACH_FILE_NM
		       , ATTACH_FILE_FNM
		       , ATTACH_FILE_SUFFIX
		       , ATTACH_FILE_PATH
		    FROM PRS_DIR_RPT_ATTACH
		   WHERE YEAR = #year#
		     AND EMPN = #empn#
		ORDER BY SEQ                                			                       
	</select>
	
	<!--
	==================================================================   
	  # 설명	: 자기성과기술서 제출취소
	  #	기능	: UPDATE
	  #	TABLE	: PRS_MNG_RPT
	==================================================================
	-->
	<update id="cancelData" parameterClass="rptParam">
		UPDATE PRS_DIR_EVAL_MEMBER
		   SET RPT_SUBMIT_YN = 'N'
		 WHERE YEAR = #year#
		   AND EMPN = #empn#
	</update>	
	
</sqlMap>


